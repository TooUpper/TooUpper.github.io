<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="ADC 指模&#x2F;数转换器或者模数转换器。是指将连续变化的模拟信号转换为离散的数字信号的器件。 我们这里需要使用 ADC 功能采集麦克风数据(原始 PCM 数据)，发送给服务端。 LN882H对ADC的支持支持 6 通道轮询采样12bit 分辨率单次和连续转换模式支持DMA支持转换完成中断  注：如果要使用 ADC 的 DMA，除了要使能 ADC_DMA_EN，还要配置 ADC 的转换中断使">
<meta property="og:type" content="article">
<meta property="og:title" content="麦克风">
<meta property="og:url" content="https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/index.html">
<meta property="og:site_name" content="流年不知心底事">
<meta property="og:description" content="ADC 指模&#x2F;数转换器或者模数转换器。是指将连续变化的模拟信号转换为离散的数字信号的器件。 我们这里需要使用 ADC 功能采集麦克风数据(原始 PCM 数据)，发送给服务端。 LN882H对ADC的支持支持 6 通道轮询采样12bit 分辨率单次和连续转换模式支持DMA支持转换完成中断  注：如果要使用 ADC 的 DMA，除了要使能 ADC_DMA_EN，还要配置 ADC 的转换中断使">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.tooupper.org/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ARM/Cortex-M4/LN882H/mtmkf.png">
<meta property="og:image" content="https://www.tooupper.org/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ARM/Cortex-M4/LN882H/mkfgzsm.png">
<meta property="og:image" content="https://www.tooupper.org/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ARM/Cortex-M4/LN882H/dbjsgs.png">
<meta property="og:image" content="https://www.tooupper.org/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ARM/Cortex-M4/LN882H/dairufsycs.png">
<meta property="og:image" content="https://www.tooupper.org/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ARM/Cortex-M4/LN882H/zxcsdl.png">
<meta property="og:image" content="https://www.tooupper.org/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ARM/Cortex-M4/LN882H/bzjs.png">
<meta property="og:image" content="https://www.tooupper.org/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ARM/Cortex-M4/LN882H/bzfw.png">
<meta property="article:published_time" content="2025-03-10T03:40:00.000Z">
<meta property="article:modified_time" content="2025-03-31T06:15:10.547Z">
<meta property="article:author" content="kay">
<meta property="article:tag" content="LN">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.tooupper.org/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ARM/Cortex-M4/LN882H/mtmkf.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>麦克风</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">博主</a></li><!--
     --><!--
       --><li><a href="/tags/">标签</a></li><!--
     --><!--
       --><li><a href="/categories/">分类</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/%E5%B5%8C%E5%85%A5%E5%BC%8F/EDA/%E7%AB%8B%E5%88%9BEDA/%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/PCM/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/&text=麦克风"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/&title=麦克风"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/&is_video=false&description=麦克风"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=麦克风&body=Check out this article: https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/&title=麦克风"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/&title=麦克风"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/&title=麦克风"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/&title=麦克风"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/&name=麦克风&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/&t=麦克风"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#LN882H%E5%AF%B9ADC%E7%9A%84%E6%94%AF%E6%8C%81"><span class="toc-number">1.</span> <span class="toc-text">LN882H对ADC的支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%B5%E8%B7%AF%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.</span> <span class="toc-text">电路设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">3.</span> <span class="toc-text">实现思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FFT"><span class="toc-number">4.</span> <span class="toc-text">FFT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.</span> <span class="toc-text">软件实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#123"><span class="toc-number">6.</span> <span class="toc-text">123</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#456"><span class="toc-number">6.1.</span> <span class="toc-text">456</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        麦克风
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">kay</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-03-10T03:40:00.000Z" class="dt-published" itemprop="datePublished">2025-03-10</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/ARM/">ARM</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/LN/" rel="tag">LN</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>ADC 指模&#x2F;数转换器或者模数转换器。是指将连续变化的模拟信号转换为离散的数字信号的器件。</p>
<p>我们这里需要使用 ADC 功能采集麦克风数据(原始 PCM 数据)，发送给服务端。</p>
<h2 id="LN882H对ADC的支持"><a href="#LN882H对ADC的支持" class="headerlink" title="LN882H对ADC的支持"></a>LN882H对ADC的支持</h2><p>支持 6 通道轮询采样<br>12bit 分辨率<br>单次和连续转换模式<br>支持DMA<br>支持转换完成中断</p>
<blockquote>
<p>注：如果要使用 ADC 的 DMA，除了要使能 ADC_DMA_EN，还要配置 ADC 的转换中断使能（不用配置 NVIC），这样才能触发 DMA采集数据</p>
</blockquote>
<p>引脚和ADC通道对应关系</p>
<p>GPIOA0  -&gt;  ADC2<br>GPIOA1  -&gt;  ADC3<br>GPIOA4  -&gt;  ADC4<br>GPIOB3  -&gt;  ADC5<br>GPIOB4  -&gt;  ADC6<br>GPIOB5  -&gt;  ADC7</p>
<h2 id="电路设计"><a href="#电路设计" class="headerlink" title="电路设计"></a>电路设计</h2><p><strong>实体样式</strong></p>
<p>咪头式麦克风</p>
<p><img src="/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ARM/Cortex-M4/LN882H/mtmkf.png" alt="mtmkf"></p>
<p><strong>规格说明</strong></p>
<p><img src="/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ARM/Cortex-M4/LN882H/mkfgzsm.png" alt="mkfgzsm"></p>
<p>参数说明：</p>
<p>指向性：全指向(说明麦克风能均匀接收<strong>各个方向</strong>的声音，适用于语音采集)<br>灵敏度：-31±3(麦克风将声压转换为电信号的能力)</p>
<ul>
<li><strong>0 dB &#x3D; 1V&#x2F;Pa</strong>，即 <strong>1 帕斯卡（Pa）的声压下，麦克风输出 1V 电压</strong>。</li>
<li>规格中参数是 <strong>-31 ±3 dB</strong>，意味着灵敏度范围在 <strong>-34 dB 到 -28 dB</strong> 之间。</li>
<li>那么根据公式：<img src="/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ARM/Cortex-M4/LN882H/dbjsgs.png" alt="dbjsgs"></li>
<li>我们可以将参数 -31dB 带入：<img src="/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ARM/Cortex-M4/LN882H/dairufsycs.png" alt="dairufsycs">可以得出有效值为 28.2mv，峰值约为 39.9mV</li>
</ul>
<p>标准工作电压：4.5V(范围是 2v-10V，4.5V 最佳)<br>输出阻抗：2.2KΩ(麦克风输出信号的内阻，影响与后续电路的匹配)<br>频率：100Hz-20000Hz(麦克风能有效响应的音频频率范围)<br>最大耗电流：0.5mA(麦克风在工作时的最大电流)<br>…</p>
<p><strong>最小测试电路</strong></p>
<p><img src="/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ARM/Cortex-M4/LN882H/zxcsdl.png" alt="zxcsdl"></p>
<p>为什么不可以直接将咪头麦克风接入 ADC 引脚而需要外置电路？</p>
<p>根据规格说明中的解释我们可以得出如下麦克风特性：<br>咪头麦克风（驻极体麦克风）输出的是<strong>交流音频信号</strong>，以直流偏置电压为中心；而ADC只能采集正电压（0V到3.3V，假设 ln882H 的参考电压是3.3V）。<br>直流偏置：根据公式，假设负载电阻 R<sub>L</sub> &#x3D; 2.2kΩ，电流 0.5 mA，咪头两端压降约为 0.5 x 10<sup>-3</sup> x 2200 &#x3D; 1.1 V。若供电3.3V，输出引脚（Term 1）的直流电平约为 3.3 - 1.1 &#x3D; 2.2。(驻极体麦克风内部有一个FET（场效应管），它需要一个偏置电流来工作。)<br>交流部分：±39.9 mV（1Pa声压），总输出范围约为 2.2V ± 39.9 mV（2.1601V 到 2.2399V）。</p>
<p>LN882H ADC 引脚特性：<br><strong>输入范围</strong>：0V 至 3.3V（单极输入，常见值）。</p>
<p><strong>分辨率</strong>：LN882H ADC 12 位(2<sup>12</sup> &#x3D; 4096），电压分辨率约为$$ \frac{3.3}{4096} \approx 0.805\text{mV} $$</p>
<p>这两个特性说明了两点：</p>
<p>第一、引脚输入电压不能超过 3.3V，因为它最大只支持 3.3V<br>第二、咪头麦克风的电压变化大概在 0.805mV 左右太微弱了，ADC 可能无法精确识别<br>第三、麦克风需要的电压为 4.5V，ADC 引脚最大也就 3.3V</p>
<p>为了解决这些问题：我们就需要外置电路，对麦克风提供 3.3V 的电压，并将电压变大让 ADC 可以正常采集这些变化；</p>
<h2 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h2><p><strong>使用 ADC 采集音频数据</strong>（原始 PCM 数据）。<br>注意因为直流偏置范围只有(2.1601V 到 2.2399V)，所以我们可以计算出 ADC 步长为:<br><img src="/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ARM/Cortex-M4/LN882H/bzjs.png" alt="bzjs"><br>那么信号范围 $ 2.1601V $ 到 $ 2.2399V $ 对应的ADC值<br><img src="/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ARM/Cortex-M4/LN882H/bzfw.png" alt="bzfw"><br>信号变化范围为 2683 到 2783，总共约100个量化级别。所以我们需要线性映射对应的数值。<br>将采集到的数据转为 16 位的 PCM，存储到 PCMBuffer（环形缓冲区)</p>
<p><strong>使用 G.726 编码</strong>（将 PCM 数据压缩，降低带宽需求）。这个后续实现<br><strong>通过 Socket 发送</strong> G.726 编码后的数据给服务端。<br><strong>服务端解码 G.726</strong>，还原成 PCM，再进行后续处理（播放&#x2F;存储&#x2F;语音识别等）。</p>
<h2 id="FFT"><a href="#FFT" class="headerlink" title="FFT"></a>FFT</h2><p>通过 ADC 采样麦克风数据，但采样结果受到干扰。测试发现 ADC 引脚本身存在大概 0.0几V 的噪声波动，我当前使用的是咪头麦克风输出信号幅度较低，导致采样信号淹没在噪声中，无法正确获取麦克风数据。这里就可使用 FFT 算法</p>
<h2 id="软件实现"><a href="#软件实现" class="headerlink" title="软件实现"></a>软件实现</h2><p>思路：通过 ADC 读取音频数据，将其转为 PCM 数据流，通过 socket 发送给大模型进行处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hal/hal_clock.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hal/hal_common.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hal/hal_gpio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hal/hal_adc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hal/hal_timer.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ln_show_reg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ln_test_common.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;utils/debug/log.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ln_drv_timer.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ln_drv_adc.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADC_CHANNEL   ADC_CH5    <span class="comment">// 使用GPIOB3作为ADC输入</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SAMPLE_RATE   40000      <span class="comment">// 目标采样率 40kHz</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE   1024       <span class="comment">// PCM缓冲区大小</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PCM缓冲区</span></span><br><span class="line"><span class="type">int16_t</span> pcmBuffer[BUFFER_SIZE];</span><br><span class="line"><span class="keyword">volatile</span> <span class="type">uint16_t</span> bufferIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定时器中断回调</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer_callback</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 直接读取最新ADC值 (0-4095，非阻塞)</span></span><br><span class="line">    <span class="type">uint16_t</span> adcValue = adc_get_data(ADC_CHANNEL);</span><br><span class="line">	LOG(LOG_LVL_INFO, <span class="string">&quot;PCM ...\n&quot;</span>);</span><br><span class="line">    <span class="comment">// 转换为16位PCM (-32768至32767)</span></span><br><span class="line">    <span class="type">int16_t</span> pcmValue = (<span class="type">int16_t</span>)((adcValue - <span class="number">2733</span>) * (<span class="number">29490.0</span> / <span class="number">50.0</span>)); <span class="comment">// 映射到90%满量程</span></span><br><span class="line">	<span class="keyword">if</span> (pcmValue &gt; <span class="number">32767</span>) pcmValue = <span class="number">32767</span>;  <span class="comment">// 防止溢出</span></span><br><span class="line">	<span class="keyword">if</span> (pcmValue &lt; <span class="number">-32768</span>) pcmValue = <span class="number">-32768</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存储到缓冲区</span></span><br><span class="line">    <span class="keyword">if</span> (bufferIndex &lt; BUFFER_SIZE)&#123;</span><br><span class="line">        pcmBuffer[bufferIndex++] = pcmValue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 缓冲区满，处理数据（例如发送或重置）</span></span><br><span class="line">        bufferIndex = <span class="number">0</span>;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;PCM Buffer Full, Processing...\n&quot;</span>);</span><br><span class="line">        <span class="comment">// 可添加数据传输逻辑（如串口发送）</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span>&#123;</span><br><span class="line">    <span class="comment">/****************** 1. 系统初始化 ***********************/</span></span><br><span class="line">    SetSysClock();</span><br><span class="line">    log_init();</span><br><span class="line">    LOG(LOG_LVL_INFO, <span class="string">&quot;LN882H init for audio capture!\n&quot;</span>);</span><br><span class="line">    ln_show_reg_init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/****************** 2. 外设配置 ***********************/</span></span><br><span class="line">    <span class="comment">// 初始化ADC</span></span><br><span class="line">    adc_init(ADC_CHANNEL);  <span class="comment">// 配置ADC_CH5 (GPIOB3)为连续模式</span></span><br><span class="line">    adc_start();            <span class="comment">// 开始ADC转换</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化定时器 (使用Timer0，40kHz中断)</span></span><br><span class="line">    <span class="type">uint32_t</span> timer_us = <span class="number">1000000</span> / SAMPLE_RATE; <span class="comment">// 40kHz -&gt; 25 us</span></span><br><span class="line">    timer_init(TIMER_CH_0, timer_us, timer_callback); <span class="comment">// 初始化Timer0，25us中断</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/****************** 3. 采集循环 ***********************/</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)&#123;</span><br><span class="line">        ln_delay_ms(<span class="number">100</span>);  <span class="comment">// 避免CPU过载</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="123"><a href="#123" class="headerlink" title="123"></a>123</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CRC16</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">calculate_crc16</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">uint16_t</span> length)</span> &#123;</span><br><span class="line">    <span class="type">uint16_t</span> crc = <span class="number">0x0000</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint16_t</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        crc ^= (<span class="type">uint16_t</span>)data[i] &lt;&lt; <span class="number">8</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">uint8_t</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (crc &amp; <span class="number">0x8000</span>) crc = (crc &lt;&lt; <span class="number">1</span>) ^ <span class="number">0x8005</span>; <span class="keyword">else</span> crc &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> crc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 格式校验</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">validate_format</span><span class="params">(<span class="type">uint8_t</span> *buffer, <span class="type">uint32_t</span> pos)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pos &lt; <span class="number">7</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="type">uint16_t</span> data_length = (buffer[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | buffer[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">if</span> (data_length &gt; TEMP_BUFFER_SIZE - <span class="number">7</span>) &#123;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;Data length too big: %u\n&quot;</span>, data_length);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">uint16_t</span> expected_pos = <span class="number">4</span> + data_length + <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (pos &lt; expected_pos) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (buffer[<span class="number">0</span>] != <span class="number">0xAA</span> || buffer[expected_pos - <span class="number">1</span>] != <span class="number">0xFF</span> || pos != expected_pos) &#123;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;Data format error: head=0x%02X, tail=0x%02X, pos=%u, expected=%u\n&quot;</span>,</span><br><span class="line">            buffer[<span class="number">0</span>], buffer[pos - <span class="number">1</span>], pos, expected_pos);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">send_ACK</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">uint8_t</span> response_type)</span> &#123;</span><br><span class="line">    <span class="type">uint8_t</span> response[<span class="number">3</span>] = &#123;<span class="number">0xAA</span>, response_type, <span class="number">0xFF</span>&#125;;</span><br><span class="line">    <span class="type">int</span> attempts = <span class="number">5</span>;</span><br><span class="line">    <span class="type">int</span> sent;</span><br><span class="line">    <span class="keyword">while</span> (attempts-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        sent = lwip_send(sockfd, response, <span class="keyword">sizeof</span>(response), <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (sent &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            LOG(LOG_LVL_ERROR, <span class="string">&quot;send_ACK error, errno=%d, attempts left=%d\n&quot;</span>, errno, attempts);</span><br><span class="line">            <span class="keyword">if</span> (errno == EAGAIN || errno == ETIMEDOUT) &#123;</span><br><span class="line">                OS_MsDelay(<span class="number">50</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sent != <span class="keyword">sizeof</span>(response)) &#123;</span><br><span class="line">            LOG(LOG_LVL_ERROR, <span class="string">&quot;Partial ACK send: expected 3, sent %d\n&quot;</span>, sent);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span>(response_type)&#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0xAA</span>: LOG(LOG_LVL_INFO, <span class="string">&quot;Sent %s\n&quot;</span>, <span class="string">&quot;ACK_0xAA&quot;</span>);<span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0xEE</span>: LOG(LOG_LVL_INFO, <span class="string">&quot;Sent %s\n&quot;</span>, <span class="string">&quot;ACK_0xEE&quot;</span>);<span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0x02</span>: LOG(LOG_LVL_INFO, <span class="string">&quot;Sent %s\n&quot;</span>, <span class="string">&quot;ACK_0x02&quot;</span>);<span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0x01</span>: LOG(LOG_LVL_INFO, <span class="string">&quot;Sent %s\n&quot;</span>, <span class="string">&quot;ACK_0x01&quot;</span>);<span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    LOG(LOG_LVL_ERROR, <span class="string">&quot;Failed to send ACK after retries\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">get_free_space</span><span class="params">(<span class="type">uint32_t</span> write_pos, <span class="type">uint32_t</span> read_pos, <span class="type">uint32_t</span> buffer_size)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((write_pos + <span class="number">1</span>) % buffer_size == read_pos) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (write_pos &gt;= read_pos) &#123;</span><br><span class="line">        <span class="keyword">return</span> buffer_size - (write_pos - read_pos) - <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> read_pos - write_pos - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">read_circular_buffer</span><span class="params">(<span class="type">void</span> *buffer, <span class="type">uint32_t</span> *read_pos, <span class="type">uint32_t</span> *write_pos, <span class="type">uint32_t</span> buffer_size, <span class="type">void</span> *data, <span class="type">uint16_t</span> data_length, <span class="type">size_t</span> element_size)</span> &#123;</span><br><span class="line">    <span class="type">uint32_t</span> available = (*write_pos &gt;= *read_pos) ? (*write_pos - *read_pos) : (buffer_size - *read_pos + *write_pos);</span><br><span class="line">    <span class="keyword">if</span> (available &lt; data_length) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">uint32_t</span> space_to_end = buffer_size - *read_pos;</span><br><span class="line">    <span class="keyword">if</span> (space_to_end &gt;= data_length) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(data, (<span class="type">uint8_t</span> *)buffer + (*read_pos * element_size), data_length * element_size);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(data, (<span class="type">uint8_t</span> *)buffer + (*read_pos * element_size), space_to_end * element_size);</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="type">uint8_t</span> *)data + (space_to_end * element_size), buffer, (data_length - space_to_end) * element_size);</span><br><span class="line">    &#125;</span><br><span class="line">    *read_pos = (*read_pos + data_length) % buffer_size;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向环形缓冲区写入数据</span></span><br><span class="line"><span class="comment">// buffer：环形缓冲区的起始地址（通用指针）。</span></span><br><span class="line"><span class="comment">// write_pos：指向写指针的指针，表示当前写入位置。</span></span><br><span class="line"><span class="comment">// read_pos：指向读指针的指针，表示当前读取位置。</span></span><br><span class="line"><span class="comment">// buffer_size：缓冲区总大小（元素个数）。</span></span><br><span class="line"><span class="comment">// data：要写入的数据的起始地址（通用指针）。</span></span><br><span class="line"><span class="comment">// data_length：要写入的元素个数。</span></span><br><span class="line"><span class="comment">// element_size：每个元素的大小（字节数，例如 sizeof(int16_t) 为 2）。</span></span><br><span class="line"><span class="comment">// 0：写入成功。</span></span><br><span class="line"><span class="comment">// -1：因缓冲区空间不足超时失败</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">write_circular_buffer</span><span class="params">(<span class="type">void</span> *buffer, <span class="type">uint32_t</span> *write_pos, <span class="type">uint32_t</span> *read_pos, </span></span><br><span class="line"><span class="params">                                 <span class="type">uint32_t</span> buffer_size, <span class="type">void</span> *data, <span class="type">uint16_t</span> data_length, </span></span><br><span class="line"><span class="params">                                 <span class="type">size_t</span> element_size)</span> &#123;</span><br><span class="line">    <span class="comment">// 计算可用空间</span></span><br><span class="line">    <span class="type">uint32_t</span> free_space = get_free_space(*write_pos, *read_pos, buffer_size);</span><br><span class="line">    <span class="type">uint32_t</span> wait_start = OS_GetTicks(); <span class="comment">// 获取当前系统时间（tick 计数），用于超时检测</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 空间不够，等待缓冲区空间</span></span><br><span class="line">    <span class="keyword">while</span> (free_space &lt; data_length) &#123;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;Buffer full, data_length=%u, free_space=%u\n&quot;</span>, data_length, free_space);</span><br><span class="line">        vTaskDelay(pdMS_TO_TICKS(<span class="number">10</span>));</span><br><span class="line">        free_space = get_free_space(*write_pos, *read_pos, buffer_size);</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;write_circular_buffer write=%u, read=%u\n&quot;</span>, *write_pos, *read_pos);</span><br><span class="line">        <span class="keyword">if</span> (OS_GetTicks() - wait_start &gt; pdMS_TO_TICKS(<span class="number">5000</span>)) &#123;</span><br><span class="line">            LOG(LOG_LVL_ERROR, <span class="string">&quot;Timeout waiting for buffer space after 5s\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// 返回 -1 表示因空间不足超时</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 写入数据</span></span><br><span class="line">    <span class="type">uint32_t</span> space_to_end = buffer_size - *write_pos;</span><br><span class="line">    <span class="keyword">if</span> (space_to_end &gt;= data_length) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="type">uint8_t</span> *)buffer + (*write_pos * element_size), data, data_length * element_size);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="type">uint8_t</span> *)buffer + (*write_pos * element_size), data, space_to_end * element_size);</span><br><span class="line">        <span class="built_in">memcpy</span>(buffer, (<span class="type">uint8_t</span> *)data + (space_to_end * element_size), </span><br><span class="line">               (data_length - space_to_end) * element_size);</span><br><span class="line">    &#125;</span><br><span class="line">    *write_pos = (*write_pos + data_length) % buffer_size;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 写入成功</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">receive_sum_size</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">uint32_t</span> *sum_size)</span> &#123;</span><br><span class="line">    <span class="type">uint8_t</span> size_buffer[<span class="number">4</span>];</span><br><span class="line">    <span class="type">int</span> size_pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">4</span>];</span><br><span class="line">    <span class="type">int</span> len = lwip_recv(sockfd, buffer, <span class="keyword">sizeof</span>(buffer), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 处理非阻塞临时错误</span></span><br><span class="line">        <span class="keyword">if</span> (errno == EAGAIN || errno == EWOULDBLOCK) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;receive_sum_size len: %d\n&quot;</span>, len);</span><br><span class="line">        <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; len &amp;&amp; size_pos &lt; <span class="number">4</span>) &#123;</span><br><span class="line">            size_buffer[size_pos] = buffer[i];</span><br><span class="line">            size_pos++;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (size_pos == <span class="number">4</span>) &#123;</span><br><span class="line">            *sum_size = ((<span class="type">uint32_t</span>)size_buffer[<span class="number">0</span>] &lt;&lt; <span class="number">24</span>) | ((<span class="type">uint32_t</span>)size_buffer[<span class="number">1</span>] &lt;&lt; <span class="number">16</span>) |</span><br><span class="line">                        ((<span class="type">uint32_t</span>)size_buffer[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | (<span class="type">uint32_t</span>)size_buffer[<span class="number">3</span>];</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;Received total size: %u bytes\n&quot;</span>, *sum_size);</span><br><span class="line">            send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查结束信号</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">check_end_signal</span><span class="params">(<span class="type">uint8_t</span> *buffer, <span class="type">uint32_t</span> *pos, <span class="type">int</span> sockfd)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (*pos &lt; <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 数据不足以包含结束信号，直接返回</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt;= *pos - <span class="number">3</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (buffer[i] == <span class="number">0xAA</span> &amp;&amp; buffer[i + <span class="number">1</span>] == <span class="number">0x02</span> &amp;&amp; buffer[i + <span class="number">2</span>] == <span class="number">0xFF</span>) &#123;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;recv end pos=%u\n&quot;</span>, i);</span><br><span class="line">            <span class="type">uint32_t</span> remaining = *pos - (i + <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检查结束信号后是否紧跟开始信号</span></span><br><span class="line">            <span class="keyword">if</span> (remaining &gt;= <span class="number">3</span> &amp;&amp; buffer[i + <span class="number">3</span>] == <span class="number">0xAA</span> &amp;&amp; buffer[i + <span class="number">4</span>] == <span class="number">0x01</span> &amp;&amp; buffer[i + <span class="number">5</span>] == <span class="number">0xFF</span>) &#123;</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Start signal follows end signal, remaining=%u\n&quot;</span>, remaining);</span><br><span class="line">                memmove(buffer, &amp;buffer[i + <span class="number">3</span>], remaining);</span><br><span class="line">                *pos = remaining;</span><br><span class="line">                send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">// 表示结束信号后紧跟开始信号</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理剩余数据</span></span><br><span class="line">            <span class="keyword">if</span> (remaining &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Moving %u bytes after end signal\n&quot;</span>, remaining);</span><br><span class="line">                memmove(buffer, &amp;buffer[i + <span class="number">3</span>], remaining);</span><br><span class="line">                *pos = remaining;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                *pos = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-3</span>; <span class="comment">// 仅检测到结束信号</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 未检测到结束信号</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理数据包</span></span><br><span class="line"><span class="comment">// buffer：包含完整数据包的缓冲区。</span></span><br><span class="line"><span class="comment">// pos：缓冲区中数据包的长度（字节数）。</span></span><br><span class="line"><span class="comment">// sockfd：socket 文件描述符，用于发送 ACK。</span></span><br><span class="line"><span class="comment">// data_type：指向数据类型变量的指针，存储解析出的类型（0x11 或 0x12）。</span></span><br><span class="line"><span class="comment">// total_written：指向已写入数据总量的指针（样本数或字节数）。</span></span><br><span class="line"><span class="comment">// 0：成功处理数据包或仅接收类型信息。</span></span><br><span class="line"><span class="comment">// -1：CRC 校验失败。</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">process_packet</span><span class="params">(<span class="type">uint8_t</span> *buffer, <span class="type">uint32_t</span> pos, <span class="type">int</span> sockfd, <span class="type">uint8_t</span> *data_type, <span class="type">uint32_t</span> *total_written)</span> &#123;</span><br><span class="line">    <span class="type">uint16_t</span> data_length = (buffer[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | buffer[<span class="number">3</span>]; <span class="comment">// 数据长度</span></span><br><span class="line">    *data_type = buffer[<span class="number">1</span>]; <span class="comment">// 数据包类型</span></span><br><span class="line">    <span class="type">uint8_t</span> *data = &amp;buffer[<span class="number">4</span>]; <span class="comment">// 指向数据开头</span></span><br><span class="line">    <span class="type">uint16_t</span> recv_crc = (buffer[<span class="number">4</span> + data_length] &lt;&lt; <span class="number">8</span>) | buffer[<span class="number">5</span> + data_length];</span><br><span class="line">    <span class="type">uint16_t</span> calculated_crc = calculate_crc16(data, data_length);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (calculated_crc != recv_crc) &#123;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;CRC16 error: received=0x%04X, calculated=0x%04X\n&quot;</span>, recv_crc, calculated_crc);</span><br><span class="line">        send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 引导包</span></span><br><span class="line">    <span class="keyword">if</span> (data_length == <span class="number">0</span> &amp;&amp; (*data_type == <span class="number">0x11</span> || *data_type == <span class="number">0x12</span>)) &#123;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;recv type : 0x%02X\n&quot;</span>, *data_type);</span><br><span class="line">        send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    taskENTER_CRITICAL();</span><br><span class="line">    <span class="keyword">if</span> (*data_type == <span class="number">0x12</span>) &#123; <span class="comment">// 音频数据</span></span><br><span class="line">        <span class="keyword">if</span> (data_length % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">            LOG(LOG_LVL_ERROR, <span class="string">&quot;Audio data length not two: %u\n&quot;</span>, data_length);</span><br><span class="line">            send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 转为16位样本</span></span><br><span class="line">            <span class="type">uint16_t</span> sample_count = data_length / <span class="number">2</span>;</span><br><span class="line">            <span class="type">int16_t</span> samples[sample_count];</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">uint16_t</span> i = <span class="number">0</span>; i &lt; sample_count; i++) &#123;</span><br><span class="line">                samples[i] = (<span class="type">int16_t</span>)((data[i * <span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | data[i * <span class="number">2</span> + <span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> write_result = write_circular_buffer(PCMBuffer_rx, (<span class="type">uint32_t</span> *)&amp;rx_write_pos, </span><br><span class="line">                                                    (<span class="type">uint32_t</span> *)&amp;rx_read_pos, RING_BUFFER_SIZE, </span><br><span class="line">                                                    (<span class="type">uint8_t</span> *)samples, sample_count, <span class="keyword">sizeof</span>(<span class="type">int16_t</span>));</span><br><span class="line">            <span class="keyword">if</span> (write_result == <span class="number">0</span>) &#123;</span><br><span class="line">                *total_written += sample_count;</span><br><span class="line">                send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;CRC match, total_written=%u (0x12)\n&quot;</span>, *total_written);</span><br><span class="line">                xSemaphoreGive(rx_data_ready_sem); <span class="comment">// 写入成功，增加计数</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (write_result == <span class="number">-1</span>) &#123;</span><br><span class="line">                xSemaphoreGive(rx_data_ready_sem); <span class="comment">// 空间不足，通知消费者</span></span><br><span class="line">                send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Buffer full, signalled consumer for audio data\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (*data_type == <span class="number">0x11</span>) &#123; <span class="comment">// 打印数据</span></span><br><span class="line">        <span class="type">int</span> write_result = write_circular_buffer(print_buffer, (<span class="type">uint32_t</span> *)&amp;print_write_pos, </span><br><span class="line">                                                (<span class="type">uint32_t</span> *)&amp;print_read_pos, SUM_BUFFER_SIZE, </span><br><span class="line">                                                data, data_length, <span class="keyword">sizeof</span>(<span class="type">uint8_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (write_result == <span class="number">0</span>) &#123;</span><br><span class="line">            *total_written += data_length;</span><br><span class="line">            send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;CRC match, total_written=%u (bytes)\n&quot;</span>, *total_written);</span><br><span class="line">            xSemaphoreGive(print_data_ready_sem); <span class="comment">// 写入成功，增加计数</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (write_result == <span class="number">-1</span>) &#123;</span><br><span class="line">            xSemaphoreGive(print_data_ready_sem); <span class="comment">// 空间不足，通知消费者</span></span><br><span class="line">            send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;Buffer full, signalled consumer for print data\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    taskEXIT_CRITICAL();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">receive_data</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> *has_partial, <span class="type">uint8_t</span> *temp_buffer, <span class="type">uint32_t</span> *temp_pos, <span class="type">uint8_t</span> *data_type, <span class="type">uint32_t</span> *total_written)</span> &#123;</span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    <span class="type">static</span> <span class="type">uint8_t</span> buffer[<span class="number">4096</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*has_partial &amp;&amp; *temp_pos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> end_result = check_end_signal(temp_buffer, temp_pos, sockfd);</span><br><span class="line">        <span class="keyword">if</span> (end_result == <span class="number">-3</span>) &#123;</span><br><span class="line">            *has_partial = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-3</span>; <span class="comment">// 仅结束信号</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (end_result == <span class="number">1</span>) &#123;</span><br><span class="line">            *has_partial = <span class="number">1</span>; <span class="comment">// 保留开始信号数据</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;  <span class="comment">// 结束信号后紧跟开始信号</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> validation_result = validate_format(temp_buffer, *temp_pos);</span><br><span class="line">        <span class="keyword">if</span> (validation_result == <span class="number">2</span>) &#123;</span><br><span class="line">            process_packet(temp_buffer, *temp_pos, sockfd, data_type, total_written);</span><br><span class="line">            *temp_pos = <span class="number">0</span>;</span><br><span class="line">            *has_partial = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (validation_result == <span class="number">-1</span>) &#123;</span><br><span class="line">            send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">            *temp_pos = <span class="number">0</span>;</span><br><span class="line">            *has_partial = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    len = lwip_recv(sockfd, buffer, <span class="keyword">sizeof</span>(buffer), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EAGAIN || errno == ETIMEDOUT) &#123;</span><br><span class="line">            OS_MsDelay(<span class="number">100</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;recv_data len &lt; 0: %d\n&quot;</span>, errno);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>) &#123;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;Server closed connection\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; len) &#123;</span><br><span class="line">        <span class="keyword">if</span> (*temp_pos &gt;= TEMP_BUFFER_SIZE) &#123;</span><br><span class="line">            send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">            *temp_pos = <span class="number">0</span>;</span><br><span class="line">            *has_partial = <span class="number">0</span>;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;temp_pos &gt;= sizeof(temp_buffer)...\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        temp_buffer[*temp_pos] = buffer[i];</span><br><span class="line">        (*temp_pos)++;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> end_result = check_end_signal(temp_buffer, temp_pos, sockfd);</span><br><span class="line">        <span class="keyword">if</span> (end_result == <span class="number">-3</span>) &#123;</span><br><span class="line">            *has_partial = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-3</span>; <span class="comment">// 仅结束信号</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (end_result == <span class="number">1</span>) &#123;</span><br><span class="line">            *has_partial = <span class="number">1</span>; <span class="comment">// 保留开始信号数据</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;  <span class="comment">// 结束信号后紧跟开始信号</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> validation_result = validate_format(temp_buffer, *temp_pos);</span><br><span class="line">        <span class="keyword">if</span> (validation_result == <span class="number">-1</span>) &#123;</span><br><span class="line">            send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">            *temp_pos = <span class="number">0</span>;</span><br><span class="line">            *has_partial = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (validation_result == <span class="number">2</span>) &#123;</span><br><span class="line">            process_packet(temp_buffer, *temp_pos, sockfd, data_type, total_written);</span><br><span class="line">            *temp_pos = <span class="number">0</span>;</span><br><span class="line">            *has_partial = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (i + <span class="number">1</span> &lt; len &amp;&amp; buffer[i + <span class="number">1</span>] != <span class="number">0xAA</span>) &#123;</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Discarding invalid data after packet: %02X\n&quot;</span>, buffer[i + <span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*temp_pos &gt; <span class="number">0</span> &amp;&amp; temp_buffer[*temp_pos - <span class="number">1</span>] == <span class="number">0xAA</span> &amp;&amp; validate_format(temp_buffer, *temp_pos) != <span class="number">2</span>) &#123;</span><br><span class="line">        *has_partial = <span class="number">1</span>;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;package not wanzheng\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">socket_task_entry</span><span class="params">(<span class="type">void</span> *params)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    LN_UNUSED(params); <span class="comment">// 抑制编译器对未使用参数的警告。</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_addr</span>;</span> <span class="comment">// 存储 IP 和端口。</span></span><br><span class="line">    <span class="type">int</span> timeout_ms = <span class="number">5000</span>; <span class="comment">// 接收超时时间，单位毫秒 5s</span></span><br><span class="line">    <span class="type">int</span> sockfd = <span class="number">-1</span>; <span class="comment">// socket 句柄 -1 未连接</span></span><br><span class="line">    <span class="type">int</span> has_partial = <span class="number">0</span>; <span class="comment">// 标志位，表示是否有未处理完的部分数据。</span></span><br><span class="line">    <span class="comment">// 临时缓冲区，用于接收数据，初始化为全 0。</span></span><br><span class="line">    <span class="type">uint8_t</span> temp_buffer[TEMP_BUFFER_SIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">uint32_t</span> temp_pos = <span class="number">0</span>; <span class="comment">// 临时缓冲区的当前写入位置</span></span><br><span class="line">    <span class="type">uint8_t</span> data_type = <span class="number">0</span>; <span class="comment">// 接收数据的类型</span></span><br><span class="line">    <span class="type">uint32_t</span> total_written = <span class="number">0</span>; <span class="comment">// 已写入的总数据量（样本数或字节数）</span></span><br><span class="line">    State_t state = STATE_IDLE; <span class="comment">// 状态机变量，初始状态为空闲</span></span><br><span class="line">    <span class="type">uint32_t</span> data_sum_size = <span class="number">0</span>; <span class="comment">// 打印数据的总大小</span></span><br><span class="line">    <span class="type">uint8_t</span> is_get_sum_size = <span class="number">0</span>; <span class="comment">// 标志位，表示是否已获取打印数据的总大小</span></span><br><span class="line">    <span class="comment">// 记录上次接收数据的时间，用于超时检测，静态变量保持任务间的状态。</span></span><br><span class="line">    <span class="type">static</span> <span class="type">uint32_t</span> last_data_time = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 检查 MUC 是否获取到 IP 地址（WiFi 是否连接）</span></span><br><span class="line">        <span class="keyword">if</span> (!netdev_got_ip()) &#123;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;No IP, waiting for WiFi...\n&quot;</span>);</span><br><span class="line">            OS_MsDelay(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取网络接口（STA 模式）的 IP 信息，包括 IP 地址、子网掩码和网关</span></span><br><span class="line">        <span class="type">tcpip_ip_info_t</span> ip_info;</span><br><span class="line">        netdev_get_ip_info(NETIF_IDX_STA, &amp;ip_info);</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;IP: %s, Mask: %s, Gateway: %s\n&quot;</span>,</span><br><span class="line">            ip4addr_ntoa(&amp;ip_info.ip), ip4addr_ntoa(&amp;ip_info.netmask), ip4addr_ntoa(&amp;ip_info.gw));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取 WiFi 信号强度（RSSI，单位 dBm），并打印。</span></span><br><span class="line">        <span class="type">int8_t</span> rssi;</span><br><span class="line">        wifi_sta_get_rssi(&amp;rssi);</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;WiFi RSSI: %d dBm\n&quot;</span>, rssi);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当网络连接正常时，进入内层循环处理 socket 连接和数据通信。</span></span><br><span class="line">        <span class="keyword">while</span> (netdev_got_ip()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123; <span class="comment">// 未创建，则创建 socket 句柄</span></span><br><span class="line">                sockfd = lwip_socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123; <span class="comment">// 失败延迟 2s 重试</span></span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Socket create error: %d\n&quot;</span>, errno);</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Socket create ID=%d\n&quot;</span>, sockfd);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 设置 socket 为非阻塞模式（FIONBIO）失败则关闭重试</span></span><br><span class="line">                <span class="type">int</span> flags = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (lwip_ioctl(sockfd, FIONBIO, &amp;flags) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;socket ioctl error: %d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 配置服务器地址</span></span><br><span class="line">                <span class="built_in">memset</span>(&amp;server_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">                server_addr.sin_family = AF_INET;</span><br><span class="line">                server_addr.sin_port = lwip_htons(<span class="number">8080</span>);</span><br><span class="line">                server_addr.sin_addr.s_addr = inet_addr(<span class="string">&quot;192.168.2.27&quot;</span>);</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Connecting to 192.168.2.27:8080...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 连接到指定 IP 和 端口，非阻塞失败就关闭 socket 重试</span></span><br><span class="line">                <span class="type">int</span> connect_result = lwip_connect(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">                <span class="keyword">if</span> (connect_result &lt; <span class="number">0</span> &amp;&amp; errno != EINPROGRESS) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;lwip_connect failed: %d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 检查连接结果</span></span><br><span class="line">                fd_set writefds, exceptfds;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">                tv.tv_sec = <span class="number">10</span>;</span><br><span class="line">                tv.tv_usec = <span class="number">0</span>;</span><br><span class="line">                FD_ZERO(&amp;writefds);</span><br><span class="line">                FD_ZERO(&amp;exceptfds);</span><br><span class="line">                FD_SET(sockfd, &amp;writefds);</span><br><span class="line">                FD_SET(sockfd, &amp;exceptfds);</span><br><span class="line">                <span class="type">int</span> select_result = lwip_select(sockfd + <span class="number">1</span>, <span class="literal">NULL</span>, &amp;writefds, &amp;exceptfds, &amp;tv);</span><br><span class="line">                <span class="keyword">if</span> (select_result &lt;= <span class="number">0</span> || FD_ISSET(sockfd, &amp;exceptfds)) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Connect timed out or failed: %d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 检查错误状态</span></span><br><span class="line">                <span class="type">int</span> so_error = <span class="number">0</span>;</span><br><span class="line">                <span class="type">socklen_t</span> len = <span class="keyword">sizeof</span>(so_error);</span><br><span class="line">                <span class="keyword">if</span> (lwip_getsockopt(sockfd, SOL_SOCKET, SO_ERROR, &amp;so_error, &amp;len) &lt; <span class="number">0</span> || so_error != <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Connect failed with error: %d\n&quot;</span>, so_error);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 设置接收超时</span></span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Connected to 192.168.2.27:8080\n&quot;</span>);</span><br><span class="line">                tv.tv_sec = timeout_ms / <span class="number">1000</span>;</span><br><span class="line">                tv.tv_usec = (timeout_ms % <span class="number">1000</span>) * <span class="number">1000</span>;</span><br><span class="line">                <span class="keyword">if</span> (lwip_setsockopt(sockfd, SOL_SOCKET, SO_RCVTIMEO, &amp;tv, <span class="keyword">sizeof</span>(tv)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;setsockopt SO_RCVTIMEO failed: %d\n&quot;</span>, errno);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 重置状态</span></span><br><span class="line">                state = STATE_IDLE;</span><br><span class="line">                has_partial = <span class="number">0</span>;</span><br><span class="line">                temp_pos = <span class="number">0</span>;</span><br><span class="line">                data_type = <span class="number">0</span>;</span><br><span class="line">                total_written = <span class="number">0</span>;</span><br><span class="line">                data_sum_size = <span class="number">0</span>;</span><br><span class="line">                is_get_sum_size = <span class="number">0</span>;</span><br><span class="line">                last_data_time = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// socket 和 WiFi 都正常时进入循环</span></span><br><span class="line">            <span class="keyword">while</span> (sockfd &gt;= <span class="number">0</span> &amp;&amp; netdev_got_ip()) &#123;</span><br><span class="line">                <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">                    <span class="keyword">case</span> STATE_IDLE: &#123; <span class="comment">// 接收 3 字节的开始信号。</span></span><br><span class="line">                        <span class="type">uint8_t</span> response[<span class="number">3</span>];</span><br><span class="line">                        <span class="type">int</span> len = lwip_recv(sockfd, response, <span class="keyword">sizeof</span>(response), <span class="number">0</span>);</span><br><span class="line">                        <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// 无数据时候就 break</span></span><br><span class="line">                            <span class="keyword">if</span> (errno == EAGAIN || errno == ETIMEDOUT) &#123;</span><br><span class="line">                                OS_MsDelay(<span class="number">100</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// 说明错误了</span></span><br><span class="line">                            LOG(LOG_LVL_ERROR, <span class="string">&quot;STATE_IDLE len &lt; 0: %d\n&quot;</span>, errno);</span><br><span class="line">                            lwip_close(sockfd);</span><br><span class="line">                            sockfd = <span class="number">-1</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>) &#123; <span class="comment">// 0 表示对方关闭了连接</span></span><br><span class="line">                            LOG(LOG_LVL_INFO, <span class="string">&quot;Server closed connection\n&quot;</span>);</span><br><span class="line">                            lwip_close(sockfd);</span><br><span class="line">                            sockfd = <span class="number">-1</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 检查接收到的开始信号是否为 0xAA 0x01 0xFF</span></span><br><span class="line">                        <span class="keyword">if</span> (len == <span class="number">3</span> &amp;&amp; response[<span class="number">0</span>] == <span class="number">0xAA</span> &amp;&amp; response[<span class="number">1</span>] == <span class="number">0x01</span> &amp;&amp; response[<span class="number">2</span>] == <span class="number">0xFF</span>) &#123;</span><br><span class="line">                            LOG(LOG_LVL_INFO, <span class="string">&quot;recv start...\n&quot;</span>);</span><br><span class="line">                            send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">                            state = STATE_TYPE;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            LOG(LOG_LVL_ERROR, <span class="string">&quot;recv start error: %02X %02X %02X\n&quot;</span>, response[<span class="number">0</span>], response[<span class="number">1</span>], response[<span class="number">2</span>]);</span><br><span class="line">                            send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> STATE_TYPE: &#123; <span class="comment">// 调用 receive_data 接收数据类型。</span></span><br><span class="line">                        <span class="type">int</span> ret = receive_data(sockfd, &amp;has_partial, temp_buffer, &amp;temp_pos, &amp;data_type, &amp;total_written);</span><br><span class="line">                        <span class="comment">// -1 或 -2：socket 错误或连接关闭，关闭 socket。</span></span><br><span class="line">                        <span class="keyword">if</span> (ret == <span class="number">-1</span> || ret == <span class="number">-2</span>) &#123;</span><br><span class="line">                            LOG(LOG_LVL_INFO, <span class="string">&quot;STATE_TYPE(sockfd)...\n&quot;</span>);</span><br><span class="line">                            lwip_close(sockfd);</span><br><span class="line">                            sockfd = <span class="number">-1</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">-3</span>) &#123; <span class="comment">// -3：收到结束信号，切换回 STATE_IDLE</span></span><br><span class="line">                            LOG(LOG_LVL_ERROR, <span class="string">&quot;Unexpected end signal in STATE_TYPE\n&quot;</span>);</span><br><span class="line">                            state = STATE_IDLE;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 如果数据类型为 0x11（打印）或 0x12（音频），切换到对应状态并清空 data_type</span></span><br><span class="line">                        <span class="keyword">if</span> (data_type == <span class="number">0x11</span> || data_type == <span class="number">0x12</span>) &#123;</span><br><span class="line">                            state = (data_type == <span class="number">0x11</span>) ? STATE_PRINT : STATE_AUDIO;</span><br><span class="line">                            data_type = <span class="number">0</span>;<span class="comment">// 清空数据类型</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 打印逻辑</span></span><br><span class="line">                    <span class="keyword">case</span> STATE_PRINT: &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!is_get_sum_size) &#123; <span class="comment">// 获取打印数据总大小</span></span><br><span class="line">                            <span class="type">int</span> ret = receive_sum_size(sockfd, &amp;data_sum_size);</span><br><span class="line">                            <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">                                LOG(LOG_LVL_ERROR, <span class="string">&quot;receive_sum_size error\n&quot;</span>);</span><br><span class="line">                                lwip_close(sockfd);</span><br><span class="line">                                sockfd = <span class="number">-1</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (ret == <span class="number">1</span>) &#123;</span><br><span class="line">                                is_get_sum_size = <span class="number">1</span>;</span><br><span class="line">                                total_written = <span class="number">0</span>;</span><br><span class="line">                                last_data_time = OS_GetTicks();</span><br><span class="line">                                LOG(LOG_LVL_INFO, <span class="string">&quot;STATE_PRINT sum size: %u bytes\n&quot;</span>, data_sum_size);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="type">int</span> ret = receive_data(sockfd, &amp;has_partial, temp_buffer, &amp;temp_pos, &amp;data_type, &amp;total_written);</span><br><span class="line">                            <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123; <span class="comment">// socket 错误，关闭 socket。</span></span><br><span class="line">                                LOG(LOG_LVL_INFO, <span class="string">&quot;STATE_PRINT(sockfd)...\n&quot;</span>);</span><br><span class="line">                                lwip_close(sockfd);</span><br><span class="line">                                sockfd = <span class="number">-1</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">-2</span>) &#123; <span class="comment">// 服务器关闭连接，检查数据完整性后关闭 socket</span></span><br><span class="line">                                LOG(LOG_LVL_INFO, <span class="string">&quot;Server closed connection\n&quot;</span>);</span><br><span class="line">                                <span class="keyword">if</span> (total_written &lt; data_sum_size) &#123;</span><br><span class="line">                                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Incomplete print data: received %u of %u bytes\n&quot;</span>, total_written, data_sum_size);</span><br><span class="line">                                &#125;</span><br><span class="line">                                lwip_close(sockfd);</span><br><span class="line">                                sockfd = <span class="number">-1</span>;</span><br><span class="line">                                is_get_sum_size = <span class="number">0</span>;</span><br><span class="line">                                total_written = <span class="number">0</span>;</span><br><span class="line">                                print_write_pos = <span class="number">0</span>;</span><br><span class="line">                                print_read_pos = <span class="number">0</span>;</span><br><span class="line">                                state = STATE_IDLE;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">-3</span>) &#123; <span class="comment">// 收到结束信号，检查完整性后切换回 STATE_IDLE</span></span><br><span class="line">                                <span class="keyword">if</span> (total_written &lt; data_sum_size) &#123;</span><br><span class="line">                                    LOG(LOG_LVL_ERROR, <span class="string">&quot;print data not wz: received %u of %u bytes\n&quot;</span>, total_written, data_sum_size);</span><br><span class="line">                                &#125;</span><br><span class="line">                                is_get_sum_size = <span class="number">0</span>;</span><br><span class="line">                                total_written = <span class="number">0</span>;</span><br><span class="line">                                print_write_pos = <span class="number">0</span>;</span><br><span class="line">                                print_read_pos = <span class="number">0</span>;</span><br><span class="line">                                state = STATE_IDLE;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">1</span>) &#123;</span><br><span class="line">                                <span class="comment">// 结束信号后紧跟开始信号</span></span><br><span class="line">                                LOG(LOG_LVL_INFO, <span class="string">&quot;New session started after end signal\n&quot;</span>);</span><br><span class="line">                                total_written = <span class="number">0</span>;</span><br><span class="line">                                rx_write_pos = <span class="number">0</span>;</span><br><span class="line">                                rx_read_pos = <span class="number">0</span>;</span><br><span class="line">                                state = STATE_TYPE; <span class="comment">// 切换到类型状态处理新数据</span></span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">							<span class="comment">// 设置超时接收</span></span><br><span class="line">                            last_data_time = OS_GetTicks(); <span class="comment">// 获取当前时间戳</span></span><br><span class="line">                            <span class="comment">// 超时 5s,重置接收状态和缓冲区</span></span><br><span class="line">                            <span class="keyword">if</span> (OS_GetTicks() - last_data_time &gt; pdMS_TO_TICKS(<span class="number">5000</span>)) &#123;</span><br><span class="line">                                LOG(LOG_LVL_ERROR, <span class="string">&quot;Timeout waiting for print data\n&quot;</span>);</span><br><span class="line">                                lwip_close(sockfd);</span><br><span class="line">                                sockfd = <span class="number">-1</span>;</span><br><span class="line">                                is_get_sum_size = <span class="number">0</span>;</span><br><span class="line">                                total_written = <span class="number">0</span>;</span><br><span class="line">                                print_write_pos = <span class="number">0</span>;</span><br><span class="line">                                print_read_pos = <span class="number">0</span>;</span><br><span class="line">                                state = STATE_IDLE;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">							<span class="comment">// 打印接收进度。</span></span><br><span class="line">                            LOG(LOG_LVL_INFO, <span class="string">&quot;Received %u of %u bytes\n&quot;</span>, total_written, data_sum_size);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> STATE_AUDIO: &#123;</span><br><span class="line">                        <span class="type">int</span> ret = receive_data(sockfd, &amp;has_partial, temp_buffer, &amp;temp_pos, &amp;data_type, &amp;total_written);</span><br><span class="line">                        <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">                            LOG(LOG_LVL_INFO, <span class="string">&quot;lwip_close(sockfd)...\n&quot;</span>);</span><br><span class="line">                            lwip_close(sockfd);</span><br><span class="line">                            sockfd = <span class="number">-1</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">-2</span>) &#123;</span><br><span class="line">                            LOG(LOG_LVL_INFO, <span class="string">&quot;Server closed connection\n&quot;</span>);</span><br><span class="line">                            lwip_close(sockfd);</span><br><span class="line">                            sockfd = <span class="number">-1</span>;</span><br><span class="line">                            total_written = <span class="number">0</span>;</span><br><span class="line">                            rx_write_pos = <span class="number">0</span>;</span><br><span class="line">                            rx_read_pos = <span class="number">0</span>;</span><br><span class="line">                            state = STATE_IDLE;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">-3</span>) &#123;</span><br><span class="line">                            total_written = <span class="number">0</span>;</span><br><span class="line">                            rx_write_pos = <span class="number">0</span>;</span><br><span class="line">                            rx_read_pos = <span class="number">0</span>;</span><br><span class="line">                            state = STATE_IDLE;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">1</span>) &#123;</span><br><span class="line">                            <span class="comment">// 结束信号后紧跟开始信号</span></span><br><span class="line">                            LOG(LOG_LVL_INFO, <span class="string">&quot;New session started after end signal\n&quot;</span>);</span><br><span class="line">                            total_written = <span class="number">0</span>;</span><br><span class="line">                            rx_write_pos = <span class="number">0</span>;</span><br><span class="line">                            rx_read_pos = <span class="number">0</span>;</span><br><span class="line">                            state = STATE_TYPE; <span class="comment">// 切换到类型状态处理新数据</span></span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">					</span><br><span class="line">                        last_data_time = OS_GetTicks();</span><br><span class="line">                        <span class="keyword">if</span> (OS_GetTicks() - last_data_time &gt; pdMS_TO_TICKS(<span class="number">5000</span>)) &#123;</span><br><span class="line">                            LOG(LOG_LVL_ERROR, <span class="string">&quot;Timeout waiting for audio data\n&quot;</span>);</span><br><span class="line">                            lwip_close(sockfd);</span><br><span class="line">                            sockfd = <span class="number">-1</span>;</span><br><span class="line">                            total_written = <span class="number">0</span>;</span><br><span class="line">                            rx_write_pos = <span class="number">0</span>;</span><br><span class="line">                            rx_read_pos = <span class="number">0</span>;</span><br><span class="line">                            state = STATE_IDLE;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 从音频发送缓冲区（PCMBuffer_tx）读取数据，构造数据包，并通过 TCP socket 发送给服务器。</span></span><br><span class="line">                        <span class="comment">// 获取信号量</span></span><br><span class="line">                        <span class="keyword">if</span> (xSemaphoreTake(tx_data_ready_sem, pdMS_TO_TICKS(<span class="number">100</span>)) == pdTRUE) &#123;</span><br><span class="line">                            <span class="type">uint16_t</span> data_length = <span class="number">0</span>; <span class="comment">// 发送的数据长度</span></span><br><span class="line">                            <span class="type">int16_t</span> data[MAX_DATA_PER_PACKET / <span class="number">2</span>]; <span class="comment">// 存储从缓冲区读取的音频样本。</span></span><br><span class="line">                            taskENTER_CRITICAL();</span><br><span class="line">                            <span class="comment">// 计算 PCMBuffer_tx 中可用的样本数</span></span><br><span class="line">                            <span class="type">uint32_t</span> available = (tx_write_pos &gt;= tx_read_pos) ? (tx_write_pos - tx_read_pos) : (RING_BUFFER_SIZE - tx_read_pos + tx_write_pos);</span><br><span class="line">                            <span class="comment">// SEND_THRESHOLD 预定义的阈值，避免频繁发送</span></span><br><span class="line">                            <span class="keyword">if</span> (available &gt;= SEND_THRESHOLD / <span class="number">2</span>) &#123;</span><br><span class="line">                                data_length = (available &gt; MAX_DATA_PER_PACKET / <span class="number">2</span>) ? (MAX_DATA_PER_PACKET / <span class="number">2</span>) : available;</span><br><span class="line">                                <span class="comment">// 从 PCMBuffer_tx 中读取 data_length 个样本</span></span><br><span class="line">                                read_circular_buffer(PCMBuffer_tx, (<span class="type">uint32_t</span> *)&amp;tx_read_pos, (<span class="type">uint32_t</span> *)&amp;tx_write_pos, RING_BUFFER_SIZE, data, data_length, <span class="keyword">sizeof</span>(<span class="type">int16_t</span>));</span><br><span class="line">                            &#125;</span><br><span class="line">                            taskEXIT_CRITICAL();</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// 构造并发送数据包</span></span><br><span class="line">                            <span class="keyword">if</span> (data_length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="type">uint8_t</span> send_buffer[<span class="number">7</span> + MAX_DATA_PER_PACKET];</span><br><span class="line">                                send_buffer[<span class="number">0</span>] = <span class="number">0xAA</span>;</span><br><span class="line">                                send_buffer[<span class="number">1</span>] = <span class="number">0x12</span>;</span><br><span class="line">                                send_buffer[<span class="number">2</span>] = (data_length * <span class="number">2</span> &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">                                send_buffer[<span class="number">3</span>] = (data_length * <span class="number">2</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">                                <span class="built_in">memcpy</span>(&amp;send_buffer[<span class="number">4</span>], data, data_length * <span class="number">2</span>);</span><br><span class="line">                                <span class="type">uint16_t</span> crc = calculate_crc16((<span class="type">uint8_t</span> *)data, data_length * <span class="number">2</span>);</span><br><span class="line">                                send_buffer[<span class="number">4</span> + data_length * <span class="number">2</span>] = (crc &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">                                send_buffer[<span class="number">5</span> + data_length * <span class="number">2</span>] = crc &amp; <span class="number">0xFF</span>;</span><br><span class="line">                                send_buffer[<span class="number">6</span> + data_length * <span class="number">2</span>] = <span class="number">0xFF</span>;</span><br><span class="line"></span><br><span class="line">                                <span class="type">int</span> sent = lwip_send(sockfd, send_buffer, <span class="number">7</span> + data_length * <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">                                <span class="keyword">if</span> (sent != <span class="number">7</span> + data_length * <span class="number">2</span>) &#123;</span><br><span class="line">                                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Send data failed: expected %d, sent %d\n&quot;</span>, <span class="number">7</span> + data_length * <span class="number">2</span>, sent);</span><br><span class="line">                                    lwip_close(sockfd);</span><br><span class="line">                                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    LOG(LOG_LVL_INFO, <span class="string">&quot;Sent %d bytes (data length: %u)\n&quot;</span>, sent, data_length * <span class="number">2</span>);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                LOG(LOG_LVL_ERROR, <span class="string">&quot;Socket disconnect, retrying...\n&quot;</span>);</span><br><span class="line">                OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;WiFi disconnected, waiting...\n&quot;</span>);</span><br><span class="line">        OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">audio_task</span><span class="params">(<span class="type">void</span> *param)</span> &#123;</span><br><span class="line">    pwm_init(<span class="number">40000</span>, <span class="number">0</span>, PWM_CHA_0, GPIO_B, GPIO_PIN_5);</span><br><span class="line">    pwm_init(<span class="number">40000</span>, <span class="number">0</span>, PWM_CHA_1, GPIO_B, GPIO_PIN_6);</span><br><span class="line">    pwm_start(PWM_CHA_0);</span><br><span class="line">    pwm_start(PWM_CHA_1);</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> speaker_on = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">int16_t</span> samples[<span class="number">192</span>]; <span class="comment">// 每次处理 192 个样本，与 receive_data 一致</span></span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> samples_per_batch = <span class="number">192</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;Audio task sem, count=%lu\n&quot;</span>, uxSemaphoreGetCount(rx_data_ready_sem));</span><br><span class="line">        <span class="keyword">if</span> (xSemaphoreTake(rx_data_ready_sem, pdMS_TO_TICKS(<span class="number">10</span>)) == pdTRUE) &#123;</span><br><span class="line">            taskENTER_CRITICAL();</span><br><span class="line">            <span class="type">uint32_t</span> available = (rx_write_pos &gt;= rx_read_pos) ? </span><br><span class="line">                                 (rx_write_pos - rx_read_pos) : </span><br><span class="line">                                 (RING_BUFFER_SIZE - rx_read_pos + rx_write_pos);</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;Audio task: available=%u, write=%u, read=%u\n&quot;</span>, </span><br><span class="line">                available, rx_write_pos, rx_read_pos);</span><br><span class="line">            <span class="keyword">if</span> (available &gt;= samples_per_batch) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!speaker_on) &#123;</span><br><span class="line">                    pwm_start(PWM_CHA_0);</span><br><span class="line">                    pwm_start(PWM_CHA_1);</span><br><span class="line">                    speaker_on = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (read_circular_buffer(PCMBuffer_rx, (<span class="type">uint32_t</span> *)&amp;rx_read_pos, </span><br><span class="line">                                        (<span class="type">uint32_t</span> *)&amp;rx_write_pos, RING_BUFFER_SIZE, </span><br><span class="line">                                        samples, samples_per_batch, <span class="keyword">sizeof</span>(<span class="type">int16_t</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_INFO, <span class="string">&quot;Audio task read %u samples, new read=%u\n&quot;</span>, </span><br><span class="line">                        samples_per_batch, rx_read_pos);</span><br><span class="line">                    taskEXIT_CRITICAL();</span><br><span class="line">                    <span class="comment">// // 播放音频样本</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; samples_per_batch; i++) &#123;</span><br><span class="line">                        <span class="type">uint16_t</span> pwm_value = (samples[i] + <span class="number">32768</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">                        <span class="type">float</span> duty = (pwm_value / <span class="number">4095.0f</span>) * <span class="number">100.0f</span>;</span><br><span class="line">                        pwm_set_duty(PWM_CHA_0, duty);</span><br><span class="line">                        vTaskDelay(pdMS_TO_TICKS(<span class="number">1000</span> / <span class="number">16000</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Read from PCMBuffer_rx failed\n&quot;</span>);</span><br><span class="line">                    taskEXIT_CRITICAL();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                taskEXIT_CRITICAL();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;Audio task timeout, no data ready\n&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (speaker_on) &#123;</span><br><span class="line">                pwm_stop(PWM_CHA_0);</span><br><span class="line">                pwm_stop(PWM_CHA_1);</span><br><span class="line">                speaker_on = <span class="literal">false</span>;</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Speaker turned off due to no data\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        vTaskDelay(pdMS_TO_TICKS(<span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印任务</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_task</span><span class="params">(<span class="type">void</span> *param)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (xSemaphoreTake(print_data_ready_sem, portMAX_DELAY) == pdTRUE) &#123;</span><br><span class="line">            <span class="type">uint8_t</span> data[SUM_BUFFER_SIZE];</span><br><span class="line">            taskENTER_CRITICAL();</span><br><span class="line">            <span class="type">uint32_t</span> available = (print_write_pos &gt;= print_read_pos) ? </span><br><span class="line">                                 (print_write_pos - print_read_pos) : </span><br><span class="line">                                 (SUM_BUFFER_SIZE - print_read_pos + print_write_pos);</span><br><span class="line">            <span class="keyword">if</span> (available &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                read_circular_buffer(print_buffer, (<span class="type">uint32_t</span> *)&amp;print_read_pos, </span><br><span class="line">                                    (<span class="type">uint32_t</span> *)&amp;print_write_pos, SUM_BUFFER_SIZE, </span><br><span class="line">                                    data, available, <span class="keyword">sizeof</span>(<span class="type">uint8_t</span>));</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Print task processed %u bytes\n&quot;</span>, available);</span><br><span class="line">                xSemaphoreGive(print_data_ready_sem); <span class="comment">// ?????</span></span><br><span class="line">            &#125;</span><br><span class="line">            taskEXIT_CRITICAL();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">usr_app_task_entry</span><span class="params">(<span class="type">void</span> *params)</span>&#123;</span><br><span class="line">    rx_data_ready_sem = xSemaphoreCreateCounting(<span class="number">65535</span>, <span class="number">0</span>);;</span><br><span class="line">    tx_data_ready_sem = xSemaphoreCreateCounting(<span class="number">35535</span>, <span class="number">0</span>);;</span><br><span class="line">    print_data_ready_sem = xSemaphoreCreateCounting(<span class="number">35535</span>, <span class="number">0</span>);;</span><br><span class="line">    <span class="keyword">if</span> (rx_data_ready_sem == <span class="literal">NULL</span> || tx_data_ready_sem == <span class="literal">NULL</span> || </span><br><span class="line">        print_data_ready_sem == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;Semaphore creation failed!\n&quot;</span>);</span><br><span class="line">        <span class="comment">//return -1;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建 socket Task</span></span><br><span class="line">	<span class="keyword">if</span> (OS_OK != OS_ThreadCreate(&amp;g_socket_thread, <span class="string">&quot;SocketTask&quot;</span>, socket_task_entry, <span class="literal">NULL</span>, OS_PRIORITY_BELOW_NORMAL, USR_APP_TASK_STACK_SIZE)) &#123;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;SocketTask failed!\n&quot;</span>);</span><br><span class="line">		LN_ASSERT(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// audio task</span></span><br><span class="line">	<span class="keyword">if</span> (OS_OK != OS_ThreadCreate(&amp;g_audio_thread, <span class="string">&quot;AudioTask&quot;</span>, audio_task, <span class="literal">NULL</span>, OS_PRIORITY_BELOW_NORMAL, USR_APP_TASK_STACK_SIZE)) &#123;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;AudioTask failed!\n&quot;</span>);</span><br><span class="line">		LN_ASSERT(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//	// print task</span></span><br><span class="line"><span class="comment">//	if (OS_OK != OS_ThreadCreate(&amp;g_print_thread;, &quot;PrintTask&quot;, print_task, NULL, OS_PRIORITY_BELOW_NORMAL, USR_APP_TASK_STACK_SIZE)) &#123;</span></span><br><span class="line"><span class="comment">//        LN_ASSERT(1);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="456"><a href="#456" class="headerlink" title="456"></a>456</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">socket_task</span><span class="params">(<span class="type">void</span> *params)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    LN_UNUSED(params); <span class="comment">// ???????????????</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_addr</span>;</span> <span class="comment">// ?? IP ????</span></span><br><span class="line">    <span class="type">int</span> timeout_ms = <span class="number">5000</span>; <span class="comment">// ??????,???? 5s</span></span><br><span class="line">    <span class="type">int</span> sockfd = <span class="number">-1</span>; <span class="comment">// socket ?? -1 ???</span></span><br><span class="line">    <span class="type">int</span> has_partial = <span class="number">0</span>; <span class="comment">// ???,???????????????</span></span><br><span class="line">    <span class="comment">// ?????,??????,????? 0?</span></span><br><span class="line">    <span class="type">uint8_t</span> temp_buffer[TEMP_BUFFER_SIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">uint32_t</span> temp_pos = <span class="number">0</span>; <span class="comment">// ????????????</span></span><br><span class="line">    <span class="type">uint8_t</span> data_type = <span class="number">0</span>; <span class="comment">// ???????</span></span><br><span class="line">    <span class="type">uint32_t</span> total_written = <span class="number">0</span>; <span class="comment">// ????????(???????)</span></span><br><span class="line">    State_t state = STATE_IDLE; <span class="comment">// ?????,???????</span></span><br><span class="line">    <span class="type">uint32_t</span> data_sum_size = <span class="number">0</span>; <span class="comment">// ????????</span></span><br><span class="line">    <span class="type">uint8_t</span> is_get_sum_size = <span class="number">0</span>; <span class="comment">// ???,???????????????</span></span><br><span class="line">    <span class="comment">// ???????????,??????,?????????????</span></span><br><span class="line">    <span class="type">static</span> <span class="type">uint32_t</span> last_data_time = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// ?? MUC ????? IP ??(WiFi ????)</span></span><br><span class="line">        <span class="keyword">if</span> (!netdev_got_ip()) &#123;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;No IP, waiting for WiFi...\n&quot;</span>);</span><br><span class="line">            OS_MsDelay(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ??????(STA ??)? IP ??,?? IP ??????????</span></span><br><span class="line">        <span class="type">tcpip_ip_info_t</span> ip_info;</span><br><span class="line">        netdev_get_ip_info(NETIF_IDX_STA, &amp;ip_info);</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;IP: %s, Mask: %s, Gateway: %s\n&quot;</span>,</span><br><span class="line">            ip4addr_ntoa(&amp;ip_info.ip), ip4addr_ntoa(&amp;ip_info.netmask), ip4addr_ntoa(&amp;ip_info.gw));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ?? WiFi ????(RSSI,?? dBm),????</span></span><br><span class="line">        <span class="type">int8_t</span> rssi;</span><br><span class="line">        wifi_sta_get_rssi(&amp;rssi);</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;WiFi RSSI: %d dBm\n&quot;</span>, rssi);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ????????,???????? socket ????????</span></span><br><span class="line">        <span class="keyword">while</span> (netdev_got_ip()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123; <span class="comment">// ???,??? socket ??</span></span><br><span class="line">                sockfd = lwip_socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123; <span class="comment">// ???? 2s ??</span></span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Socket create error: %d\n&quot;</span>, errno);</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Socket create ID=%d\n&quot;</span>, sockfd);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ?? socket ??????(FIONBIO)???????</span></span><br><span class="line">                <span class="type">int</span> flags = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (lwip_ioctl(sockfd, FIONBIO, &amp;flags) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;socket ioctl error: %d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ???????</span></span><br><span class="line">                <span class="built_in">memset</span>(&amp;server_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">                server_addr.sin_family = AF_INET;</span><br><span class="line">                server_addr.sin_port = lwip_htons(<span class="number">8080</span>);</span><br><span class="line">                server_addr.sin_addr.s_addr = inet_addr(<span class="string">&quot;192.168.2.27&quot;</span>);</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Connecting to 192.168.2.27:8080...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ????? IP ? ??,???????? socket ??</span></span><br><span class="line">                <span class="type">int</span> connect_result = lwip_connect(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">                <span class="keyword">if</span> (connect_result &lt; <span class="number">0</span> &amp;&amp; errno != EINPROGRESS) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;lwip_connect failed: %d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ??????</span></span><br><span class="line">                fd_set writefds, exceptfds;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">                tv.tv_sec = <span class="number">10</span>;</span><br><span class="line">                tv.tv_usec = <span class="number">0</span>;</span><br><span class="line">                FD_ZERO(&amp;writefds);</span><br><span class="line">                FD_ZERO(&amp;exceptfds);</span><br><span class="line">                FD_SET(sockfd, &amp;writefds);</span><br><span class="line">                FD_SET(sockfd, &amp;exceptfds);</span><br><span class="line">                <span class="type">int</span> select_result = lwip_select(sockfd + <span class="number">1</span>, <span class="literal">NULL</span>, &amp;writefds, &amp;exceptfds, &amp;tv);</span><br><span class="line">                <span class="keyword">if</span> (select_result &lt;= <span class="number">0</span> || FD_ISSET(sockfd, &amp;exceptfds)) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Connect timed out or failed: %d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ??????</span></span><br><span class="line">                <span class="type">int</span> so_error = <span class="number">0</span>;</span><br><span class="line">                <span class="type">socklen_t</span> len = <span class="keyword">sizeof</span>(so_error);</span><br><span class="line">                <span class="keyword">if</span> (lwip_getsockopt(sockfd, SOL_SOCKET, SO_ERROR, &amp;so_error, &amp;len) &lt; <span class="number">0</span> || so_error != <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Connect failed with error: %d\n&quot;</span>, so_error);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ??????</span></span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Connected to 192.168.2.27:8080\n&quot;</span>);</span><br><span class="line">                tv.tv_sec = timeout_ms / <span class="number">1000</span>;</span><br><span class="line">                tv.tv_usec = (timeout_ms % <span class="number">1000</span>) * <span class="number">1000</span>;</span><br><span class="line">                <span class="keyword">if</span> (lwip_setsockopt(sockfd, SOL_SOCKET, SO_RCVTIMEO, &amp;tv, <span class="keyword">sizeof</span>(tv)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;setsockopt SO_RCVTIMEO failed: %d\n&quot;</span>, errno);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ????</span></span><br><span class="line">                state = STATE_IDLE;</span><br><span class="line">                has_partial = <span class="number">0</span>;</span><br><span class="line">                temp_pos = <span class="number">0</span>;</span><br><span class="line">                data_type = <span class="number">0</span>;</span><br><span class="line">                total_written = <span class="number">0</span>;</span><br><span class="line">                data_sum_size = <span class="number">0</span>;</span><br><span class="line">                is_get_sum_size = <span class="number">0</span>;</span><br><span class="line">                last_data_time = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// socket ? WiFi ????????</span></span><br><span class="line">            <span class="keyword">while</span> (sockfd &gt;= <span class="number">0</span> &amp;&amp; netdev_got_ip()) &#123;</span><br><span class="line">                <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">                    <span class="keyword">case</span> STATE_IDLE: &#123; <span class="comment">// ?? 3 ????????</span></span><br><span class="line">                        <span class="type">uint8_t</span> response[<span class="number">3</span>];</span><br><span class="line">                        <span class="type">int</span> len = lwip_recv(sockfd, response, <span class="keyword">sizeof</span>(response), <span class="number">0</span>);</span><br><span class="line">                        <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// ?????? break</span></span><br><span class="line">                            <span class="keyword">if</span> (errno == EAGAIN || errno == ETIMEDOUT) &#123;</span><br><span class="line">                                OS_MsDelay(<span class="number">100</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// ?????</span></span><br><span class="line">                            LOG(LOG_LVL_ERROR, <span class="string">&quot;STATE_IDLE len &lt; 0: %d\n&quot;</span>, errno);</span><br><span class="line">                            lwip_close(sockfd);</span><br><span class="line">                            sockfd = <span class="number">-1</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>) &#123; <span class="comment">// 0 ?????????</span></span><br><span class="line">                            LOG(LOG_LVL_INFO, <span class="string">&quot;Server closed connection\n&quot;</span>);</span><br><span class="line">                            lwip_close(sockfd);</span><br><span class="line">                            sockfd = <span class="number">-1</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// ????????????? 0xAA 0x01 0xFF</span></span><br><span class="line">                        <span class="keyword">if</span> (len == <span class="number">3</span> &amp;&amp; response[<span class="number">0</span>] == <span class="number">0xAA</span> &amp;&amp; response[<span class="number">1</span>] == <span class="number">0x01</span> &amp;&amp; response[<span class="number">2</span>] == <span class="number">0xFF</span>) &#123;</span><br><span class="line">                            LOG(LOG_LVL_INFO, <span class="string">&quot;recv start...\n&quot;</span>);</span><br><span class="line">                            send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">                            state = STATE_TYPE;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            LOG(LOG_LVL_ERROR, <span class="string">&quot;recv start error: %02X %02X %02X\n&quot;</span>, response[<span class="number">0</span>], response[<span class="number">1</span>], response[<span class="number">2</span>]);</span><br><span class="line">                            send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> STATE_TYPE: &#123; <span class="comment">// ?? receive_data ???????</span></span><br><span class="line">                        <span class="type">int</span> ret = receive_data(sockfd, &amp;has_partial, temp_buffer, &amp;temp_pos, &amp;data_type, &amp;total_written);</span><br><span class="line">                        <span class="comment">// -1 ? -2:socket ???????,?? socket?</span></span><br><span class="line">                        <span class="keyword">if</span> (ret == <span class="number">-1</span> || ret == <span class="number">-2</span>) &#123;</span><br><span class="line">                            LOG(LOG_LVL_INFO, <span class="string">&quot;STATE_TYPE(sockfd)...\n&quot;</span>);</span><br><span class="line">                            lwip_close(sockfd);</span><br><span class="line">                            sockfd = <span class="number">-1</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">-3</span>) &#123; <span class="comment">// -3:??????,??? STATE_IDLE</span></span><br><span class="line">                            LOG(LOG_LVL_ERROR, <span class="string">&quot;Unexpected end signal in STATE_TYPE\n&quot;</span>);</span><br><span class="line">                            state = STATE_IDLE;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// ??????? 0x11(??)? 0x12(??),?????????? data_type</span></span><br><span class="line">                        <span class="keyword">if</span> (data_type == <span class="number">0x11</span> || data_type == <span class="number">0x12</span>) &#123;</span><br><span class="line">                            state = (data_type == <span class="number">0x11</span>) ? STATE_PRINT : STATE_AUDIO;</span><br><span class="line">                            data_type = <span class="number">0</span>;<span class="comment">// ??????</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// ????</span></span><br><span class="line">                    <span class="keyword">case</span> STATE_PRINT: &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!is_get_sum_size) &#123; <span class="comment">// ?????????</span></span><br><span class="line">                            <span class="type">int</span> ret = receive_sum_size(sockfd, &amp;data_sum_size);</span><br><span class="line">                            <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">                                LOG(LOG_LVL_ERROR, <span class="string">&quot;receive_sum_size error\n&quot;</span>);</span><br><span class="line">                                lwip_close(sockfd);</span><br><span class="line">                                sockfd = <span class="number">-1</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (ret == <span class="number">1</span>) &#123;</span><br><span class="line">                                is_get_sum_size = <span class="number">1</span>;</span><br><span class="line">                                total_written = <span class="number">0</span>;</span><br><span class="line">                                last_data_time = OS_GetTicks();</span><br><span class="line">                                LOG(LOG_LVL_INFO, <span class="string">&quot;STATE_PRINT sum size: %u bytes\n&quot;</span>, data_sum_size);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="type">int</span> ret = receive_data(sockfd, &amp;has_partial, temp_buffer, &amp;temp_pos, &amp;data_type, &amp;total_written);</span><br><span class="line">                            <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123; <span class="comment">// socket ??,?? socket?</span></span><br><span class="line">                                LOG(LOG_LVL_INFO, <span class="string">&quot;STATE_PRINT(sockfd)...\n&quot;</span>);</span><br><span class="line">                                lwip_close(sockfd);</span><br><span class="line">                                sockfd = <span class="number">-1</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">-2</span>) &#123; <span class="comment">// ???????,?????????? socket</span></span><br><span class="line">                                LOG(LOG_LVL_INFO, <span class="string">&quot;Server closed connection\n&quot;</span>);</span><br><span class="line">                                <span class="keyword">if</span> (total_written &lt; data_sum_size) &#123;</span><br><span class="line">                                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Incomplete print data: received %u of %u bytes\n&quot;</span>, total_written, data_sum_size);</span><br><span class="line">                                &#125;</span><br><span class="line">                                lwip_close(sockfd);</span><br><span class="line">                                sockfd = <span class="number">-1</span>;</span><br><span class="line">                                is_get_sum_size = <span class="number">0</span>;</span><br><span class="line">                                total_written = <span class="number">0</span>;</span><br><span class="line">                                print_write_pos = <span class="number">0</span>;</span><br><span class="line">                                print_read_pos = <span class="number">0</span>;</span><br><span class="line">                                state = STATE_IDLE;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">-3</span>) &#123; <span class="comment">// ??????,????????? STATE_IDLE</span></span><br><span class="line">                                <span class="keyword">if</span> (total_written &lt; data_sum_size) &#123;</span><br><span class="line">                                    LOG(LOG_LVL_ERROR, <span class="string">&quot;print data not wz: received %u of %u bytes\n&quot;</span>, total_written, data_sum_size);</span><br><span class="line">                                &#125;</span><br><span class="line">                                is_get_sum_size = <span class="number">0</span>;</span><br><span class="line">                                total_written = <span class="number">0</span>;</span><br><span class="line">                                print_write_pos = <span class="number">0</span>;</span><br><span class="line">                                print_read_pos = <span class="number">0</span>;</span><br><span class="line">                                state = STATE_IDLE;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">1</span>) &#123;</span><br><span class="line">                                <span class="comment">// ???????????</span></span><br><span class="line">                                LOG(LOG_LVL_INFO, <span class="string">&quot;New session started after end signal\n&quot;</span>);</span><br><span class="line">                                total_written = <span class="number">0</span>;</span><br><span class="line">                                rx_write_pos = <span class="number">0</span>;</span><br><span class="line">                                rx_read_pos = <span class="number">0</span>;</span><br><span class="line">                                state = STATE_TYPE; <span class="comment">// ????????????</span></span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">							<span class="comment">// ??????</span></span><br><span class="line">                            last_data_time = OS_GetTicks(); <span class="comment">// ???????</span></span><br><span class="line">                            <span class="comment">// ?? 5s,??????????</span></span><br><span class="line">                            <span class="keyword">if</span> (OS_GetTicks() - last_data_time &gt; pdMS_TO_TICKS(<span class="number">5000</span>)) &#123;</span><br><span class="line">                                LOG(LOG_LVL_ERROR, <span class="string">&quot;Timeout waiting for print data\n&quot;</span>);</span><br><span class="line">                                lwip_close(sockfd);</span><br><span class="line">                                sockfd = <span class="number">-1</span>;</span><br><span class="line">                                is_get_sum_size = <span class="number">0</span>;</span><br><span class="line">                                total_written = <span class="number">0</span>;</span><br><span class="line">                                print_write_pos = <span class="number">0</span>;</span><br><span class="line">                                print_read_pos = <span class="number">0</span>;</span><br><span class="line">                                state = STATE_IDLE;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">							<span class="comment">// ???????</span></span><br><span class="line">                            LOG(LOG_LVL_INFO, <span class="string">&quot;Received %u of %u bytes\n&quot;</span>, total_written, data_sum_size);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> STATE_AUDIO: &#123;</span><br><span class="line">                        <span class="type">int</span> ret = receive_data(sockfd, &amp;has_partial, temp_buffer, &amp;temp_pos, &amp;data_type, &amp;total_written);</span><br><span class="line">                        <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">                            LOG(LOG_LVL_INFO, <span class="string">&quot;lwip_close(sockfd)...\n&quot;</span>);</span><br><span class="line">                            lwip_close(sockfd);</span><br><span class="line">                            sockfd = <span class="number">-1</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">-2</span>) &#123;</span><br><span class="line">                            LOG(LOG_LVL_INFO, <span class="string">&quot;Server closed connection\n&quot;</span>);</span><br><span class="line">                            lwip_close(sockfd);</span><br><span class="line">                            sockfd = <span class="number">-1</span>;</span><br><span class="line">                            total_written = <span class="number">0</span>;</span><br><span class="line">                            rx_write_pos = <span class="number">0</span>;</span><br><span class="line">                            rx_read_pos = <span class="number">0</span>;</span><br><span class="line">                            state = STATE_IDLE;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">-3</span>) &#123;</span><br><span class="line">                            total_written = <span class="number">0</span>;</span><br><span class="line">                            rx_write_pos = <span class="number">0</span>;</span><br><span class="line">                            rx_read_pos = <span class="number">0</span>;</span><br><span class="line">                            state = STATE_IDLE;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">1</span>) &#123;</span><br><span class="line">                            <span class="comment">// ???????????</span></span><br><span class="line">                            LOG(LOG_LVL_INFO, <span class="string">&quot;New session started after end signal\n&quot;</span>);</span><br><span class="line">                            total_written = <span class="number">0</span>;</span><br><span class="line">                            rx_write_pos = <span class="number">0</span>;</span><br><span class="line">                            rx_read_pos = <span class="number">0</span>;</span><br><span class="line">                            state = STATE_TYPE; <span class="comment">// ????????????</span></span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">					</span><br><span class="line">                        last_data_time = OS_GetTicks();</span><br><span class="line">                        <span class="keyword">if</span> (OS_GetTicks() - last_data_time &gt; pdMS_TO_TICKS(<span class="number">5000</span>)) &#123;</span><br><span class="line">                            LOG(LOG_LVL_ERROR, <span class="string">&quot;Timeout waiting for audio data\n&quot;</span>);</span><br><span class="line">                            lwip_close(sockfd);</span><br><span class="line">                            sockfd = <span class="number">-1</span>;</span><br><span class="line">                            total_written = <span class="number">0</span>;</span><br><span class="line">                            rx_write_pos = <span class="number">0</span>;</span><br><span class="line">                            rx_read_pos = <span class="number">0</span>;</span><br><span class="line">                            state = STATE_IDLE;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// ????????(PCMBuffer_tx)????,?????,??? TCP socket ???????</span></span><br><span class="line">                        <span class="comment">// ?????</span></span><br><span class="line">                        <span class="keyword">if</span> (xSemaphoreTake(tx_data_ready_sem, pdMS_TO_TICKS(<span class="number">100</span>)) == pdTRUE) &#123;</span><br><span class="line">                            <span class="type">uint16_t</span> data_length = <span class="number">0</span>; <span class="comment">// ???????</span></span><br><span class="line">                            <span class="type">int16_t</span> data[MAX_DATA_PER_PACKET / <span class="number">2</span>]; <span class="comment">// ??????????????</span></span><br><span class="line">                            taskENTER_CRITICAL();</span><br><span class="line">                            <span class="comment">// ?? PCMBuffer_tx ???????</span></span><br><span class="line">                            <span class="type">uint32_t</span> available = (tx_write_pos &gt;= tx_read_pos) ? (tx_write_pos - tx_read_pos) : (RING_BUFFER_SIZE - tx_read_pos + tx_write_pos);</span><br><span class="line">                            <span class="comment">// SEND_THRESHOLD ??????,??????</span></span><br><span class="line">                            <span class="keyword">if</span> (available &gt;= SEND_THRESHOLD / <span class="number">2</span>) &#123;</span><br><span class="line">                                data_length = (available &gt; MAX_DATA_PER_PACKET / <span class="number">2</span>) ? (MAX_DATA_PER_PACKET / <span class="number">2</span>) : available;</span><br><span class="line">                                <span class="comment">// ? PCMBuffer_tx ??? data_length ???</span></span><br><span class="line">                                read_circular_buffer(PCMBuffer_tx, (<span class="type">uint32_t</span> *)&amp;tx_read_pos, (<span class="type">uint32_t</span> *)&amp;tx_write_pos, RING_BUFFER_SIZE, data, data_length, <span class="keyword">sizeof</span>(<span class="type">int16_t</span>));</span><br><span class="line">                            &#125;</span><br><span class="line">                            taskEXIT_CRITICAL();</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// ????????</span></span><br><span class="line">                            <span class="keyword">if</span> (data_length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="type">uint8_t</span> send_buffer[<span class="number">7</span> + MAX_DATA_PER_PACKET];</span><br><span class="line">                                send_buffer[<span class="number">0</span>] = <span class="number">0xAA</span>;</span><br><span class="line">                                send_buffer[<span class="number">1</span>] = <span class="number">0x12</span>;</span><br><span class="line">                                send_buffer[<span class="number">2</span>] = (data_length * <span class="number">2</span> &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">                                send_buffer[<span class="number">3</span>] = (data_length * <span class="number">2</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">                                <span class="built_in">memcpy</span>(&amp;send_buffer[<span class="number">4</span>], data, data_length * <span class="number">2</span>);</span><br><span class="line">                                <span class="type">uint16_t</span> crc = calculate_crc16((<span class="type">uint8_t</span> *)data, data_length * <span class="number">2</span>);</span><br><span class="line">                                send_buffer[<span class="number">4</span> + data_length * <span class="number">2</span>] = (crc &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">                                send_buffer[<span class="number">5</span> + data_length * <span class="number">2</span>] = crc &amp; <span class="number">0xFF</span>;</span><br><span class="line">                                send_buffer[<span class="number">6</span> + data_length * <span class="number">2</span>] = <span class="number">0xFF</span>;</span><br><span class="line"></span><br><span class="line">                                <span class="type">int</span> sent = lwip_send(sockfd, send_buffer, <span class="number">7</span> + data_length * <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">                                <span class="keyword">if</span> (sent != <span class="number">7</span> + data_length * <span class="number">2</span>) &#123;</span><br><span class="line">                                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Send data failed: expected %d, sent %d\n&quot;</span>, <span class="number">7</span> + data_length * <span class="number">2</span>, sent);</span><br><span class="line">                                    lwip_close(sockfd);</span><br><span class="line">                                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    LOG(LOG_LVL_INFO, <span class="string">&quot;Sent %d bytes (data length: %u)\n&quot;</span>, sent, data_length * <span class="number">2</span>);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                LOG(LOG_LVL_ERROR, <span class="string">&quot;Socket disconnect, retrying...\n&quot;</span>);</span><br><span class="line">                OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;WiFi disconnected, waiting...\n&quot;</span>);</span><br><span class="line">        OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/about/">博主</a></li>
        
          <li><a href="/tags/">标签</a></li>
        
          <li><a href="/categories/">分类</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#LN882H%E5%AF%B9ADC%E7%9A%84%E6%94%AF%E6%8C%81"><span class="toc-number">1.</span> <span class="toc-text">LN882H对ADC的支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%B5%E8%B7%AF%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.</span> <span class="toc-text">电路设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">3.</span> <span class="toc-text">实现思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FFT"><span class="toc-number">4.</span> <span class="toc-text">FFT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.</span> <span class="toc-text">软件实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#123"><span class="toc-number">6.</span> <span class="toc-text">123</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#456"><span class="toc-number">6.1.</span> <span class="toc-text">456</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/&text=麦克风"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/&title=麦克风"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/&is_video=false&description=麦克风"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=麦克风&body=Check out this article: https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/&title=麦克风"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/&title=麦克风"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/&title=麦克风"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/&title=麦克风"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/&name=麦克风&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E9%BA%A6%E5%85%8B%E9%A3%8E/&t=麦克风"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024-2025
    kay
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">博主</a></li><!--
     --><!--
       --><li><a href="/tags/">标签</a></li><!--
     --><!--
       --><li><a href="/categories/">分类</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
