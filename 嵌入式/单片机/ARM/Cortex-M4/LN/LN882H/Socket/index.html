<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Socket（套接字） 是一种编程接口（API），用于在计算机网络中实现不同主机之间通信，允许不同设备或同一设备上的不同程序通过网络发送和接收数据。 本质：Socket 是网络通信的端点，类似于电话系统中的“插座”，连接应用程序和底层网络协议。 用途：  客户端与服务器通信（如你的 MCU 和 Python 服务器）。 数据传输（例如 HTTP、FTP、邮件等协议都基于 Socket）。  类型：">
<meta property="og:type" content="article">
<meta property="og:title" content="Socket">
<meta property="og:url" content="https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/index.html">
<meta property="og:site_name" content="流年不知心底事">
<meta property="og:description" content="Socket（套接字） 是一种编程接口（API），用于在计算机网络中实现不同主机之间通信，允许不同设备或同一设备上的不同程序通过网络发送和接收数据。 本质：Socket 是网络通信的端点，类似于电话系统中的“插座”，连接应用程序和底层网络协议。 用途：  客户端与服务器通信（如你的 MCU 和 Python 服务器）。 数据传输（例如 HTTP、FTP、邮件等协议都基于 Socket）。  类型：">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.tooupper.org/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ARM/Cortex-M4/LN882H/socketlc.png">
<meta property="article:published_time" content="2025-03-05T06:19:00.000Z">
<meta property="article:modified_time" content="2025-03-29T07:40:15.214Z">
<meta property="article:author" content="kay">
<meta property="article:tag" content="LN">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.tooupper.org/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ARM/Cortex-M4/LN882H/socketlc.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Socket</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">博主</a></li><!--
     --><!--
       --><li><a href="/tags/">标签</a></li><!--
     --><!--
       --><li><a href="/categories/">分类</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E5%96%87%E5%8F%AD/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/%E5%BC%82%E5%B8%B8%E6%80%BB%E7%BB%93/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/&text=Socket"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/&title=Socket"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/&is_video=false&description=Socket"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Socket&body=Check out this article: https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/&title=Socket"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/&title=Socket"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/&title=Socket"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/&title=Socket"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/&name=Socket&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/&t=Socket"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E4%BF%A1%E4%B8%AD-IP-%E5%92%8C%E7%AB%AF%E5%8F%A3%E7%9A%84%E9%9C%80%E6%B1%82"><span class="toc-number">1.</span> <span class="toc-text">通信中 IP 和端口的需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%BB%E5%A1%9E%E4%B8%8E%E9%9D%9E%E9%98%BB%E5%A1%9E"><span class="toc-number">2.</span> <span class="toc-text">阻塞与非阻塞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%80"><span class="toc-number">4.</span> <span class="toc-text">实现一</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%8C"><span class="toc-number">5.</span> <span class="toc-text">实现二</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%8C-%E6%94%B9"><span class="toc-number">6.</span> <span class="toc-text">实现二(改)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%89"><span class="toc-number">7.</span> <span class="toc-text">实现三</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%9B%9B"><span class="toc-number">8.</span> <span class="toc-text">实现四</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7"><span class="toc-number">9.</span> <span class="toc-text">测试工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87"><span class="toc-number">10.</span> <span class="toc-text">目标</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Socket
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">kay</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-03-05T06:19:00.000Z" class="dt-published" itemprop="datePublished">2025-03-05</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/ARM/">ARM</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/LN/" rel="tag">LN</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p><strong>Socket（套接字）</strong> 是一种编程接口（API），用于在计算机网络中实现不同主机之间通信，允许不同设备或同一设备上的不同程序通过网络发送和接收数据。</p>
<p><strong>本质</strong>：Socket 是网络通信的端点，类似于电话系统中的“插座”，连接应用程序和底层网络协议。</p>
<p><strong>用途</strong>：</p>
<ul>
<li>客户端与服务器通信（如你的 MCU 和 Python 服务器）。</li>
<li>数据传输（例如 HTTP、FTP、邮件等协议都基于 Socket）。</li>
</ul>
<p><strong>类型</strong>：</p>
<ul>
<li><strong>流套接字（SOCK_STREAM）</strong>：基于 TCP，提供可靠、面向连接的通信（你的代码中使用）。</li>
<li><strong>数据报套接字（SOCK_DGRAM）</strong>：基于 UDP，无连接、不可靠但快速。</li>
<li>其他类型（如原始套接字 SOCK_RAW，用于特殊用途）。</li>
</ul>
<p><img src="/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ARM/Cortex-M4/LN882H/socketlc.png" alt="socketlc"></p>
<p>Socket 实现通信的方式很简单，客户端和服务器只需要知道彼此的 <strong>IP 地址</strong> 和<strong>端口号</strong>，即可建立连接并进行数据传输。</p>
<h2 id="通信中-IP-和端口的需求"><a href="#通信中-IP-和端口的需求" class="headerlink" title="通信中 IP 和端口的需求"></a>通信中 IP 和端口的需求</h2><ol>
<li><strong>服务器端</strong></li>
</ol>
<ul>
<li>需要知道自己的 IP 和端口：<ul>
<li>服务器必须绑定到一个特定的 IP 和端口，以便客户端可以找到它。</li>
<li>示例：你的 Python 代码中 server.bind((“192.168.2.54”, 8080)) 指定了服务器的 IP（192.168.2.54）和端口（8080）。</li>
<li><strong>原因</strong>：服务器需要监听这个地址，等待客户端连接。</li>
</ul>
</li>
<li>不需要知道客户端的 IP 和端口：<ul>
<li>服务器通过 accept() 接受连接后，自动获取客户端的 IP 和端口（例如 conn, addr &#x3D; server.accept() 返回的 addr）。</li>
<li>示例：你的 Python 输出 Connected by (‘192.168.2.52’, xxxx)，其中 192.168.2.52 是 MCU 的 IP，xxxx 是动态分配的端口。</li>
<li><strong>原因</strong>：客户端主动发起连接，服务器被动接受，无需预先知道客户端地址。</li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>客户端</strong></li>
</ol>
<ul>
<li>需要知道服务器的 IP 和端口：<ul>
<li>客户端必须明确指定目标服务器的 IP 和端口，才能发起连接。</li>
<li>示例：你的 MCU 代码中 server_addr.sin_addr.s_addr &#x3D; inet_addr(“192.168.2.54”) 和 server_addr.sin_port &#x3D; lwip_htons(8080) 指定了服务器地址。</li>
<li><strong>原因</strong>：客户端通过 connect() 建立连接，需要知道服务器的“地址簿”才能拨通“电话”。</li>
</ul>
</li>
<li>不需要知道自己的 IP 和端口：<ul>
<li>客户端的 IP 由网络接口自动分配（例如你的 MCU 获取到 192.168.2.52）。</li>
<li>客户端的端口由操作系统动态分配（临时端口，例如 49152-65535 范围内的某个值），无需手动指定。</li>
<li>示例：你的 MCU 不需要显式设置本地端口，lwip_connect() 自动处理。</li>
<li><strong>原因</strong>：客户端的本地地址在连接时由协议栈管理，服务器通过连接自动获知。</li>
</ul>
</li>
</ul>
<p>所以一般情况下我们只需要知道服务端的 IP 和端口号即可，服务端会被动接受客户端的地址。</p>
<h2 id="阻塞与非阻塞"><a href="#阻塞与非阻塞" class="headerlink" title="阻塞与非阻塞"></a>阻塞与非阻塞</h2><p>阻塞与非阻塞是对一个文件描述符指定的文件或设备的两种工作方式。 阻塞的意思是指，<strong>当试图对该文件描述符进行读写时，如果当时没有东西可读或者暂时不可写，程序就进入等待状态，直到有东西可读或者可写为止。</strong> 非阻塞的意思是，<strong>当没有东西可读或者不可写时，读写函数就马上返回，而不会等待。</strong></p>
<p>现在来理解什么是阻塞socket，什么是非阻塞socket。每个通过socket()函数创建的socket，本质就是一个文件描述符，所以对该文件描述符的 <strong>IO 操作</strong>方式不同，就有了阻塞socket和非阻塞socket。 </p>
<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p><strong>创建</strong>：客户端和服务器分别创建 Socket（socket()）。</p>
<p><strong>绑定与监听</strong>：服务器绑定 IP 和端口（bind()），监听连接（listen()）。</p>
<p><strong>连接</strong>：客户端连接服务器（connect()），通过 TCP 三次握手建立连接。</p>
<p><strong>数据传输</strong>：双方通过 send() 和 recv() 交换数据，TCP 保证可靠传输。</p>
<p><strong>关闭</strong>：通信结束时关闭 Socket（close()），通过四次挥手释放连接。</p>
<h2 id="实现一"><a href="#实现一" class="headerlink" title="实现一"></a>实现一</h2><p>该实现是基于亮牛 LN882H 芯片，示例模板为 wifi_mcu_basic_example </p>
<p>需求一、连通 WiFi 保证 Socket 通信：<br>可以随时监听来自指定 IP 和端口的信息，并且每 5s 向对方发送一句 Hello from MCU!</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">socket_task_entry</span><span class="params">(<span class="type">void</span> *params)</span> &#123;</span><br><span class="line">    <span class="comment">// 没什么意义，params不用会提示警告，用于去除警告</span></span><br><span class="line">    LN_UNUSED(params);</span><br><span class="line">    <span class="comment">// Socket ID，初始化为 -1，表示未创建。</span></span><br><span class="line">    <span class="type">int</span> sockfd = <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">// 存储服务端地址（IP 和端口）。</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_addr</span>;</span></span><br><span class="line">    <span class="comment">// 定义连接和接收的超时时间为 5 秒（5000 毫秒）。</span></span><br><span class="line">    <span class="type">int</span> timeout_ms = <span class="number">5000</span>;</span><br><span class="line">    <span class="comment">// 控制 MCU 向服务端发送数据的频率。</span></span><br><span class="line">    <span class="type">int</span> send_interval_ms = <span class="number">5000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="comment">// 检查 WiFi 是否获取到 IP 地址，返回 true 表示已连接并有 IP。 </span></span><br><span class="line">        <span class="keyword">if</span> (!netdev_got_ip()) &#123;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;Socket task: No IP Address, waiting for WiFi...\n&quot;</span>);</span><br><span class="line">            OS_MsDelay(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">continue</span>; <span class="comment">// 跳回主循环开头，继续检查 IP 状态。</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 存储网络信息。</span></span><br><span class="line">        <span class="type">tcpip_ip_info_t</span> ip_info;</span><br><span class="line">        <span class="comment">// 获取 STA（客户端）模式的网络信息。</span></span><br><span class="line">        netdev_get_ip_info(NETIF_IDX_STA, &amp;ip_info);</span><br><span class="line">        <span class="comment">// 打印分配的 IP 地址、子网掩码和网关。说明已经配网成功</span></span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;Socket task: IP assigned: %s, Mask: %s, Gateway: %s\n&quot;</span>,</span><br><span class="line">            ip4addr_ntoa(&amp;ip_info.ip),</span><br><span class="line">            ip4addr_ntoa(&amp;ip_info.netmask),</span><br><span class="line">            ip4addr_ntoa(&amp;ip_info.gw));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取并打印当前 WiFi 信号强度。</span></span><br><span class="line">        <span class="comment">// dBm数值越接近0，表明信号越强。</span></span><br><span class="line">        <span class="type">int8_t</span> rssi;</span><br><span class="line">        wifi_sta_get_rssi(&amp;rssi);</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;WiFi RSSI: %d dBm\n&quot;</span>, rssi);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 确保 WiFi 连接有效时才执行 Socket 操作。</span></span><br><span class="line">        <span class="keyword">while</span> (netdev_got_ip()) &#123;</span><br><span class="line">            <span class="comment">// 小于 0 表示需要创建新 Socket。</span></span><br><span class="line">            <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 创建 TCP Socket。返回值：成功为非负整数，失败为 -1。</span></span><br><span class="line">                sockfd = lwip_socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Socket Creation Failed: %d\n&quot;</span>, errno);</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 创建成功时打印 Socket 文件描述符。</span></span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Socket created ID=%d\n&quot;</span>, sockfd);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将 Socket 设置为非阻塞模式。</span></span><br><span class="line">                <span class="type">int</span> flags = <span class="number">1</span>; </span><br><span class="line">                <span class="comment">// FIONBIO：非阻塞标志。flags = 1：启用非阻塞。</span></span><br><span class="line">                <span class="keyword">if</span> (lwip_ioctl(sockfd, FIONBIO, &amp;flags) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;lwip_ioctl failed: %d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 配置服务端地址。</span></span><br><span class="line">                <span class="built_in">memset</span>(&amp;server_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">                server_addr.sin_family = AF_INET; <span class="comment">// 设置 IPv4</span></span><br><span class="line">                server_addr.sin_port = lwip_htons(<span class="number">8080</span>);</span><br><span class="line">                server_addr.sin_addr.s_addr = inet_addr(<span class="string">&quot;192.168.2.51&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 尝试连接服务端。 </span></span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Attempting to connect to 192.168.2.51:8080...\n&quot;</span>);</span><br><span class="line">                <span class="type">int</span> connect_result = lwip_connect(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">                <span class="comment">// 非 EINPROGRESS 的错误表示连接失败（例如服务端不可达）。</span></span><br><span class="line">                <span class="keyword">if</span> (connect_result &lt; <span class="number">0</span> &amp;&amp; errno != EINPROGRESS) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;lwip_connect immediate failure: %d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 使用 select 检查连接状态。</span></span><br><span class="line">                fd_set writefds, exceptfds;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">                tv.tv_sec = <span class="number">5</span>;</span><br><span class="line">                tv.tv_usec = <span class="number">0</span>;</span><br><span class="line">                FD_ZERO(&amp;writefds);</span><br><span class="line">                FD_ZERO(&amp;exceptfds);</span><br><span class="line">                FD_SET(sockfd, &amp;writefds);</span><br><span class="line">                FD_SET(sockfd, &amp;exceptfds);</span><br><span class="line">                <span class="type">int</span> select_result = lwip_select(sockfd + <span class="number">1</span>, <span class="literal">NULL</span>, &amp;writefds, &amp;exceptfds, &amp;tv);</span><br><span class="line">                <span class="comment">// 检查 select 结果。</span></span><br><span class="line">                <span class="comment">// select_result &lt;= 0：超时或错误。</span></span><br><span class="line">                <span class="comment">// FD_ISSET(sockfd, &amp;exceptfds)：异常。</span></span><br><span class="line">                <span class="keyword">if</span> (select_result &lt;= <span class="number">0</span> || FD_ISSET(sockfd, &amp;exceptfds)) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Socket Connect timed out or failed after 5s, errno=%d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 检查 Socket 连接的最终状态。</span></span><br><span class="line">                <span class="type">int</span> so_error = <span class="number">0</span>;</span><br><span class="line">                <span class="type">socklen_t</span> len = <span class="keyword">sizeof</span>(so_error);</span><br><span class="line">                <span class="comment">// SO_ERROR：获取连接错误码。</span></span><br><span class="line">                <span class="keyword">if</span> (lwip_getsockopt(sockfd, SOL_SOCKET, SO_ERROR, &amp;so_error, &amp;len) &lt; <span class="number">0</span> || so_error != <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;lwip_connect failed with error: %d\n&quot;</span>, so_error);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">				<span class="comment">// 连接成功后设置接收超时。</span></span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Connected to 192.168.2.51:8080\n&quot;</span>);</span><br><span class="line">                tv.tv_sec = timeout_ms / <span class="number">1000</span>;</span><br><span class="line">                tv.tv_usec = (timeout_ms % <span class="number">1000</span>) * <span class="number">1000</span>;</span><br><span class="line">                <span class="comment">// SO_RCVTIMEO：接收超时 5 秒。</span></span><br><span class="line">                <span class="keyword">if</span> (lwip_setsockopt(sockfd, SOL_SOCKET, SO_RCVTIMEO, &amp;tv, <span class="keyword">sizeof</span>(tv)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;lwip_setsockopt SO_RCVTIMEO failed: %d\n&quot;</span>, errno);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 定义发送消息和时间戳。</span></span><br><span class="line">            <span class="type">char</span> *msg = <span class="string">&quot;Hello from MCU!&quot;</span>;</span><br><span class="line">            <span class="type">uint32_t</span> last_send_time = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 检查 Socket 和 WiFi 状态，确保通信有效。</span></span><br><span class="line">            <span class="keyword">while</span> (sockfd &gt;= <span class="number">0</span> &amp;&amp; netdev_got_ip()) &#123;</span><br><span class="line">                <span class="comment">// 获取当前时间戳</span></span><br><span class="line">                <span class="type">uint32_t</span> current_time = OS_GetTicks();</span><br><span class="line">                <span class="comment">// 每隔 5s 发送一次</span></span><br><span class="line">                <span class="keyword">if</span> (current_time - last_send_time &gt;= send_interval_ms) &#123;</span><br><span class="line">                    <span class="type">int</span> sent = lwip_send(sockfd, msg, <span class="built_in">strlen</span>(msg), <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">if</span> (sent &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        LOG(LOG_LVL_ERROR, <span class="string">&quot;lwip_send failed: %d\n&quot;</span>, errno);</span><br><span class="line">                        lwip_close(sockfd);</span><br><span class="line">                        sockfd = <span class="number">-1</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    LOG(LOG_LVL_INFO, <span class="string">&quot;Sent: %s (%d bytes)\n&quot;</span>, msg, sent);</span><br><span class="line">                    last_send_time = current_time;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 接收服务端数据。最多 127 个字节</span></span><br><span class="line">                <span class="type">char</span> buffer[<span class="number">128</span>];</span><br><span class="line">                <span class="type">int</span> len = lwip_recv(sockfd, buffer, <span class="keyword">sizeof</span>(buffer) - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123; <span class="comment">// len &gt; 0：接收成功。</span></span><br><span class="line">                    buffer[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                    LOG(LOG_LVL_INFO, <span class="string">&quot;Received: %s\n&quot;</span>, buffer);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>) &#123; <span class="comment">// len == 0：服务端关闭。</span></span><br><span class="line">                    LOG(LOG_LVL_INFO, <span class="string">&quot;Server closed connection\n&quot;</span>);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// EAGAIN/ETIMEDOUT：超时，延时 100ms。</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (errno == EAGAIN || errno == ETIMEDOUT) &#123;</span><br><span class="line">                    OS_MsDelay(<span class="number">100</span>);</span><br><span class="line">                <span class="comment">// 其他错误：关闭 Socket。    </span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;lwip_recv failed: %d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 收发循环中监控 RSSI，实时检查 WiFi 状态。</span></span><br><span class="line">                wifi_sta_get_rssi(&amp;rssi);</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;WiFi RSSI: %d dBm\n&quot;</span>, rssi);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Socket 断开时延时重试。</span></span><br><span class="line">            <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                LOG(LOG_LVL_ERROR, <span class="string">&quot;Socket disconnected, retrying...\n&quot;</span>);</span><br><span class="line">                OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// WiFi 断开时打印延时后等待重试。</span></span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;WiFi disconnected, waiting for reconnect...\n&quot;</span>);</span><br><span class="line">        OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现二"><a href="#实现二" class="headerlink" title="实现二"></a>实现二</h2><p>需求二、接收服务端发送过来的打印数据，存入全局缓冲区(共用蓝牙的那一个)，打印业务会读取进行打印</p>
<p>​	Socket 通信：因为 Sokcet 要区分不同的数据类型(打印数据、音频数据、…)，使用 {“type”:”text”} 这样的 JSON 进行区分<br>​	数据存入的逻辑：保持 BLE 原有业务不动，调用 BLE 原来的 API，将 JOSN 解析后对应的数据写入缓冲区</p>
<p>注意：</p>
<p>​	JSON 传输格式必须按要求传输 {“type”:”text”,”data”:[打印数据]}、 {“type”:”sudio”,”data”:”音频数据”}(暂不实现)<br>​	JSON 格式的解析，只需要 data 中相关的数据<br>​	由于 Socket 基于 TCP 流式传输，无法保证数据包的边界。因此，发送的多个独立 JSON 数据（如 319 字节和 398 字节）可能会在网络层被合并成一个数据包，导致我们 JSON 分割的失败，这里要特别注意。<br>​	由于图片大小不确定，我们无法预留足够大的空间来存放图片。因此，缓冲区需要设置为环形缓冲区。同时，需要注意写入和读取之间的时机和速度关系，以确保数据的正确处理。(可以与 BLE 公用一个)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 缓存大小定义，如果和 BLE 共用缓冲区可以去掉</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TEXT_BUFFER_SIZE   20480</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AUDIO_BUFFER_SIZE  20480</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> text_buffer[TEXT_BUFFER_SIZE];  <span class="comment">// 静态分配环形缓冲区</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录写入数据</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> write_pos = <span class="number">0</span>;  <span class="comment">// 写入位置</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> read_pos = <span class="number">0</span>;   <span class="comment">// 读取位置（由打印函数更新，初始为 0）</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> text_used = <span class="number">0</span>;  <span class="comment">// 当前缓冲区中有效数据量</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于 Socket 数据接收的临时缓冲区</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> temp_buffer[<span class="number">1024</span>];</span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> temp_pos = <span class="number">0</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 比较 data 中从 offset 开始的子字符串是否与目标字符串 target 匹配。</span></span><br><span class="line"><span class="comment">// 成功匹配：返回匹配后新的偏移量（offset + target_len）。</span></span><br><span class="line"><span class="comment">// 失败：返回 -1。</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">match_string</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">uint16_t</span> len, <span class="type">uint16_t</span> offset, <span class="type">const</span> <span class="type">char</span> *target)</span> &#123;</span><br><span class="line">    <span class="type">uint16_t</span> target_len = <span class="built_in">strlen</span>(target);</span><br><span class="line">    <span class="keyword">if</span> (offset + target_len &gt; len) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strncmp</span>((<span class="type">const</span> <span class="type">char</span> *)(data + offset), target, target_len) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> offset + target_len;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳过 data 中从 offset 开始的空白字符。</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> <span class="title function_">skip_whitespace</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">uint16_t</span> len, <span class="type">uint16_t</span> offset)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (offset &lt; len &amp;&amp; (data[offset] == <span class="string">&#x27; &#x27;</span> || data[offset] == <span class="string">&#x27;\t&#x27;</span> || data[offset] == <span class="string">&#x27;\n&#x27;</span> || data[offset] == <span class="string">&#x27;\r&#x27;</span>)) &#123;</span><br><span class="line">        offset++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> offset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JSON解析（处理二进制数据流）</span></span><br><span class="line"><span class="comment">// data：JSON 缓冲区指针、len：数据长度</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">parse_json</span><span class="params">(<span class="type">uint8_t</span> *data, <span class="type">uint16_t</span> len)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    LOG(LOG_LVL_INFO, <span class="string">&quot;JSON parsing started, len=%d\n&quot;</span>, len);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查 &#123;&#125; 格式是正确，data[len] = &#x27;\0&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">2</span> || data[<span class="number">0</span>] != <span class="string">&#x27;&#123;&#x27;</span> || data[len - <span class="number">1</span>] != <span class="string">&#x27;&#125;&#x27;</span>) &#123;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot; JSON format Error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跳过开头的 &#123; 和其后的空格</span></span><br><span class="line">    <span class="type">uint16_t</span> offset = <span class="number">1</span>;</span><br><span class="line">    offset = skip_whitespace(data, len, offset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否包含 &quot;type&quot;:&quot;，记录其偏移量</span></span><br><span class="line">    <span class="type">int</span> new_offset;</span><br><span class="line">    <span class="keyword">if</span> ((new_offset = match_string(data, len, offset, <span class="string">&quot;\&quot;type\&quot;:\&quot;&quot;</span>)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;Missing type field\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    offset = new_offset; <span class="comment">// 跳过 &quot;type&quot;:&quot; </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否是 text</span></span><br><span class="line">    <span class="type">uint8_t</span> is_text = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 检查值是否为 text</span></span><br><span class="line">    <span class="keyword">if</span> ((new_offset = match_string(data, len, offset, <span class="string">&quot;text&quot;</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">        is_text = <span class="number">1</span>;</span><br><span class="line">        offset = new_offset; <span class="comment">// 偏移到 text&quot; 的位置</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 检查值是否为 audio</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((new_offset = match_string(data, len, offset, <span class="string">&quot;audio&quot;</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">        is_text = <span class="number">0</span>;</span><br><span class="line">        offset = new_offset; <span class="comment">// 位置偏移</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; <span class="comment">// 不识别的类型</span></span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;type value Error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 当前是否指向 &quot;</span></span><br><span class="line">    <span class="keyword">if</span> (offset &gt;= len || data[offset] != <span class="string">&#x27;&quot;&#x27;</span>) &#123;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;Missing closing quote after type value\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    offset++; <span class="comment">// 跳过 &quot;</span></span><br><span class="line">    offset = skip_whitespace(data, len, offset);</span><br><span class="line">    <span class="keyword">if</span> (offset &gt;= len || data[offset] != <span class="string">&#x27;,&#x27;</span>) &#123;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;Missing comma after type\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跳过空格和其后的空白</span></span><br><span class="line">    offset++;</span><br><span class="line">    offset = skip_whitespace(data, len, offset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否是 &quot;data&quot;: 如果正确就偏移跳过，包括其后的空白</span></span><br><span class="line">    <span class="keyword">if</span> ((new_offset = match_string(data, len, offset, <span class="string">&quot;\&quot;data\&quot;:&quot;</span>)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;Missing data field\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    offset = new_offset; </span><br><span class="line">    offset = skip_whitespace(data, len, offset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可用空间 = 总缓冲区大小 - 已使用空间</span></span><br><span class="line">    <span class="type">uint16_t</span> available_space = TEXT_BUFFER_SIZE - text_used;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印处理的逻辑</span></span><br><span class="line">    <span class="keyword">if</span> (is_text) &#123;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;Type: text detected, parsing array\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 跳过 [ 和其后的空格</span></span><br><span class="line">        <span class="keyword">if</span> (offset &gt;= len || data[offset] != <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;Missing opening bracket for data array\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        offset++; </span><br><span class="line">        offset = skip_whitespace(data, len, offset);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 数组元素计数</span></span><br><span class="line">        <span class="type">uint16_t</span> data_count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (offset &lt; len &amp;&amp; data[offset] != <span class="string">&#x27;]&#x27;</span>) &#123;</span><br><span class="line">            <span class="type">uint8_t</span> value;</span><br><span class="line">            <span class="type">int</span> num = <span class="number">0</span>; <span class="comment">// 存储当前解析的数字</span></span><br><span class="line">			<span class="comment">// 检查字符是否为 0~9</span></span><br><span class="line">            <span class="keyword">if</span> (offset &gt;= len || (data[offset] &lt; <span class="string">&#x27;0&#x27;</span> || data[offset] &gt; <span class="string">&#x27;9&#x27;</span>)) &#123;</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;data[offset] Error offset=%d\n&quot;</span>, offset);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (offset &lt; len &amp;&amp; (data[offset] &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; data[offset] &lt;= <span class="string">&#x27;9&#x27;</span>)) &#123;</span><br><span class="line">                num = num * <span class="number">10</span> + (data[offset] - <span class="string">&#x27;0&#x27;</span>);  <span class="comment">// 将连续的数字字符转为整数</span></span><br><span class="line">                offset++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检查是否超出范围 unit8_t 0~255</span></span><br><span class="line">            <span class="keyword">if</span> (num &gt; <span class="number">255</span>) &#123;</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Number out of range at offset=%d\n&quot;</span>, offset);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检查剩余缓冲区是否足够存储新数据</span></span><br><span class="line">            <span class="keyword">if</span> (data_count &gt;= available_space) &#123;</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Buffer not enough, count=%d, available=%d\n&quot;</span>, data_count, available_space);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 循环存入缓冲区</span></span><br><span class="line">            text_buffer[(write_pos + data_count) % TEXT_BUFFER_SIZE] = (<span class="type">uint8_t</span>)num;</span><br><span class="line">            data_count++; <span class="comment">// 计数++</span></span><br><span class="line">			</span><br><span class="line">            <span class="comment">// 跳过逗号和其后的空白字符</span></span><br><span class="line">            offset = skip_whitespace(data, len, offset);</span><br><span class="line">            <span class="keyword">if</span> (offset &lt; len &amp;&amp; data[offset] == <span class="string">&#x27;,&#x27;</span>) &#123;</span><br><span class="line">                offset++; <span class="comment">// 跳过逗号</span></span><br><span class="line">                offset = skip_whitespace(data, len, offset);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析完成后检查 ] 并且跳过其后的空白字符</span></span><br><span class="line">        <span class="keyword">if</span> (offset &gt;= len || data[offset] != <span class="string">&#x27;]&#x27;</span>) &#123;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;Missing closing bracket for data array\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        offset++; <span class="comment">// 跳过 ]</span></span><br><span class="line">        offset = skip_whitespace(data, len, offset);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (offset != len - <span class="number">1</span>) &#123;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;Extra data after array\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新缓冲区状态</span></span><br><span class="line">        <span class="comment">// write_pos，写入位置</span></span><br><span class="line">        <span class="comment">// text_used 已使用字节数。</span></span><br><span class="line">        write_pos = (write_pos + data_count) % TEXT_BUFFER_SIZE;</span><br><span class="line">        text_used += data_count;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;Text data parsed, count=%d, write_pos=%d, text_used=%d\n&quot;</span>, </span><br><span class="line">            data_count, write_pos, text_used);</span><br><span class="line">		</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 除打印数据外的信息数据(暂未实现，只是一个模板，但是原理同上面是一样的，只是[]换成了&quot;&quot;)</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;Type: audio detected, parsing string\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (offset &gt;= len || data[offset] != <span class="string">&#x27;&quot;&#x27;</span>) &#123;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;Missing opening quote for data string\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        offset++;</span><br><span class="line">        offset = skip_whitespace(data, len, offset);</span><br><span class="line"></span><br><span class="line">        <span class="type">uint16_t</span> data_len = <span class="number">0</span>;</span><br><span class="line">        <span class="type">uint16_t</span> start_offset = offset;</span><br><span class="line">        <span class="keyword">while</span> (offset &lt; len &amp;&amp; data[offset] != <span class="string">&#x27;&quot;&#x27;</span>) &#123;</span><br><span class="line">            offset++;</span><br><span class="line">            data_len++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (offset &gt;= len || data[offset] != <span class="string">&#x27;&quot;&#x27;</span>) &#123;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;Missing closing quote for data string\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        offset++;</span><br><span class="line">        offset = skip_whitespace(data, len, offset);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (offset != len - <span class="number">1</span>) &#123;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;Extra data after string\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (data_len &gt; available_space) &#123;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;Buffer not enough, data_len=%d, available=%d\n&quot;</span>, data_len, available_space);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">uint16_t</span> i = <span class="number">0</span>; i &lt; data_len; i++) &#123;</span><br><span class="line">            text_buffer[(write_pos + i) % TEXT_BUFFER_SIZE] = data[start_offset + i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        write_pos = (write_pos + data_len) % TEXT_BUFFER_SIZE;</span><br><span class="line">        text_used += data_len;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;Audio data parsed, len=%d, write_pos=%d, text_used=%d\n&quot;</span>, </span><br><span class="line">            data_len, write_pos, text_used);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">socket_task_entry</span><span class="params">(<span class="type">void</span> *params)</span> &#123;</span><br><span class="line">	<span class="comment">// 避免编译器警告</span></span><br><span class="line">    LN_UNUSED(params);</span><br><span class="line">	<span class="comment">// socket 句柄，初始化为 -1（未连接状态）</span></span><br><span class="line">    <span class="type">int</span> sockfd = <span class="number">-1</span>;</span><br><span class="line">	<span class="comment">// 存储 IP 和端口信息</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_addr</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> timeout_ms = <span class="number">5000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="comment">// 检查网络设备是否已获取 IP 地址。</span></span><br><span class="line">        <span class="keyword">if</span> (!netdev_got_ip()) &#123;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;Socket task: No IP Address, waiting for WiFi...\n&quot;</span>);</span><br><span class="line">            OS_MsDelay(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 获取网络接口的 IP 信息</span></span><br><span class="line">        <span class="type">tcpip_ip_info_t</span> ip_info; </span><br><span class="line">        netdev_get_ip_info(NETIF_IDX_STA, &amp;ip_info);</span><br><span class="line">		<span class="comment">// 打印当前 IP 配置。</span></span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;Socket task: IP assigned: %s, Mask: %s, Gateway: %s\n&quot;</span>,</span><br><span class="line">            ip4addr_ntoa(&amp;ip_info.ip),</span><br><span class="line">            ip4addr_ntoa(&amp;ip_info.netmask),</span><br><span class="line">            ip4addr_ntoa(&amp;ip_info.gw));</span><br><span class="line"></span><br><span class="line"><span class="comment">//		  信号强度显示	</span></span><br><span class="line"><span class="comment">//        int8_t rssi;</span></span><br><span class="line"><span class="comment">//        wifi_sta_get_rssi(&amp;rssi);</span></span><br><span class="line"><span class="comment">//        LOG(LOG_LVL_INFO, &quot;WiFi RSSI: %d dBm\n&quot;, rssi);</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 在 WiFi 连接状态下，进入 socket 操作循环。</span></span><br><span class="line">        <span class="keyword">while</span> (netdev_got_ip()) &#123;</span><br><span class="line">			<span class="comment">// 检查 socket 状态</span></span><br><span class="line">            <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="comment">// 创建 Socket</span></span><br><span class="line">                sockfd = lwip_socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Socket Creation Failed: %d\n&quot;</span>, errno);</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"> 				<span class="comment">// 打印创建成功的 socket ID。</span></span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Socket created ID=%d\n&quot;</span>, sockfd);</span><br><span class="line"></span><br><span class="line"> 				<span class="comment">// 设置 socket 为非阻塞模式。</span></span><br><span class="line">                <span class="type">int</span> flags = <span class="number">1</span>; <span class="comment">// 启用非阻塞</span></span><br><span class="line">                <span class="keyword">if</span> (lwip_ioctl(sockfd, FIONBIO, &amp;flags) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;lwip_ioctl failed: %d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 配置服务器地址。memset 用于清空结构体</span></span><br><span class="line">                <span class="built_in">memset</span>(&amp;server_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">                server_addr.sin_family = AF_INET; <span class="comment">// IPv4</span></span><br><span class="line">                server_addr.sin_port = lwip_htons(<span class="number">8080</span>);</span><br><span class="line">                server_addr.sin_addr.s_addr = inet_addr(<span class="string">&quot;192.168.2.51&quot;</span>);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 尝试连接服务器</span></span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Attempting to connect to 192.168.2.51:8080...\n&quot;</span>);</span><br><span class="line">                <span class="type">int</span> connect_result = lwip_connect(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">				<span class="comment">// 检查连接是否立即失败。</span></span><br><span class="line">                <span class="keyword">if</span> (connect_result &lt; <span class="number">0</span> &amp;&amp; errno != EINPROGRESS) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;lwip_connect immediate failure: %d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 使用 select 检查连接状态。</span></span><br><span class="line">                fd_set writefds, exceptfds;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">                tv.tv_sec = <span class="number">5</span>;</span><br><span class="line">                tv.tv_usec = <span class="number">0</span>;</span><br><span class="line">                FD_ZERO(&amp;writefds);</span><br><span class="line">                FD_ZERO(&amp;exceptfds);</span><br><span class="line">                FD_SET(sockfd, &amp;writefds);</span><br><span class="line">                FD_SET(sockfd, &amp;exceptfds);</span><br><span class="line">                <span class="type">int</span> select_result = lwip_select(sockfd + <span class="number">1</span>, <span class="literal">NULL</span>, &amp;writefds, &amp;exceptfds, &amp;tv);</span><br><span class="line">				<span class="comment">// 检查 select 结果。</span></span><br><span class="line">                <span class="comment">// &lt;= 0 超时或错误，FD_ISSET(sockfd, &amp;exceptfds)：异常发生</span></span><br><span class="line">                <span class="keyword">if</span> (select_result &lt;= <span class="number">0</span> || FD_ISSET(sockfd, &amp;exceptfds)) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Socket Connect timed out or failed after 5s, errno=%d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 检查 socket 的错误状态</span></span><br><span class="line">                <span class="comment">// SO_ERROR：获取连接的错误码</span></span><br><span class="line">                <span class="comment">// 如果有错误，关闭 socket 并重试。</span></span><br><span class="line">                <span class="type">int</span> so_error = <span class="number">0</span>;</span><br><span class="line">                <span class="type">socklen_t</span> len = <span class="keyword">sizeof</span>(so_error);</span><br><span class="line">                <span class="keyword">if</span> (lwip_getsockopt(sockfd, SOL_SOCKET, SO_ERROR, &amp;so_error, &amp;len) &lt; <span class="number">0</span> || so_error != <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;lwip_connect failed with error: %d\n&quot;</span>, so_error);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 连接成功，设置接收超时。超时设置为 5S</span></span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Connected to 192.168.2.51:8080\n&quot;</span>);<span class="comment">//192.168.2.51</span></span><br><span class="line">                tv.tv_sec = timeout_ms / <span class="number">1000</span>;</span><br><span class="line">                tv.tv_usec = (timeout_ms % <span class="number">1000</span>) * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (lwip_setsockopt(sockfd, SOL_SOCKET, SO_RCVTIMEO, &amp;tv, <span class="keyword">sizeof</span>(tv)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;lwip_setsockopt SO_RCVTIMEO failed: %d\n&quot;</span>, errno);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 在 socket 连接有效且 WiFi 正常时，处理数据。</span></span><br><span class="line">            <span class="keyword">while</span> (sockfd &gt;= <span class="number">0</span> &amp;&amp; netdev_got_ip()) &#123;</span><br><span class="line">				<span class="comment">// 接收服务器数据，缓冲区大小为 512		</span></span><br><span class="line">                <span class="type">char</span> buffer[<span class="number">512</span>];</span><br><span class="line">                <span class="type">int</span> len = lwip_recv(sockfd, buffer, <span class="keyword">sizeof</span>(buffer) - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123; <span class="comment">// len &gt; </span></span><br><span class="line">					buffer[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                    <span class="comment">// 检查临时缓冲区是否够</span></span><br><span class="line">                    <span class="comment">// temp_pos：当前写入位置。</span></span><br><span class="line">					<span class="keyword">if</span> (temp_pos + len &lt; <span class="keyword">sizeof</span>(temp_buffer))&#123;</span><br><span class="line">						<span class="comment">// 将接收到的数据追加到 temp_buffer</span></span><br><span class="line">						<span class="built_in">memcpy</span>(temp_buffer + temp_pos, buffer, len);</span><br><span class="line">						temp_pos += len; <span class="comment">//写入长度 + len</span></span><br><span class="line">						</span><br><span class="line">                        <span class="comment">// 解析 JSON。</span></span><br><span class="line">						<span class="type">char</span> *json_start = temp_buffer;</span><br><span class="line">						<span class="keyword">while</span> (json_start &lt; temp_buffer + temp_pos) &#123;</span><br><span class="line">							<span class="type">char</span> *json_end = <span class="built_in">memchr</span>(json_start, <span class="string">&#x27;&#125;&#x27;</span>, temp_pos - (json_start - temp_buffer));</span><br><span class="line">							<span class="keyword">if</span> (!json_end) &#123;</span><br><span class="line">								LOG(LOG_LVL_INFO, <span class="string">&quot;Incomplete JSON, waiting for more data\n&quot;</span>);</span><br><span class="line">								<span class="keyword">break</span>;</span><br><span class="line">							&#125;</span><br><span class="line"></span><br><span class="line">							<span class="type">uint16_t</span> json_len = json_end - json_start + <span class="number">1</span>;</span><br><span class="line">							<span class="keyword">if</span> (json_len &gt;= <span class="number">2</span> &amp;&amp; json_start[<span class="number">0</span>] == <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">								LOG(LOG_LVL_INFO, <span class="string">&quot;Parsing JSON, len=%d: %.*s\n&quot;</span>, json_len, json_len, json_start);</span><br><span class="line">								parse_json((<span class="type">uint8_t</span>*)json_start, json_len);</span><br><span class="line">							&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">								LOG(LOG_LVL_ERROR, <span class="string">&quot;Invalid JSON start, skipping: %.*s\n&quot;</span>, json_len, json_start);</span><br><span class="line">							&#125;</span><br><span class="line"></span><br><span class="line">							json_start = json_end + <span class="number">1</span>;</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">						<span class="type">uint16_t</span> processed = json_start - temp_buffer;</span><br><span class="line">						<span class="keyword">if</span> (processed &gt; <span class="number">0</span>) &#123;</span><br><span class="line">							<span class="type">uint16_t</span> remaining = temp_pos - processed;</span><br><span class="line">							<span class="keyword">if</span> (remaining &gt; <span class="number">0</span>) &#123;</span><br><span class="line">								memmove(temp_buffer, json_start, remaining);</span><br><span class="line">							&#125;</span><br><span class="line">							temp_pos = remaining;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						LOG(LOG_LVL_ERROR, <span class="string">&quot;Temp buffer overflow, resetting\n&quot;</span>);</span><br><span class="line">						temp_pos = <span class="number">0</span>;</span><br><span class="line">					&#125;</span><br><span class="line">                    <span class="comment">// 这段是测试用的，因为传递过来的图片 JOSN 刚好是 24965</span></span><br><span class="line">                    <span class="comment">// 所以此处就写死回传回去</span></span><br><span class="line">					<span class="keyword">if</span>(text_used == <span class="number">24965</span>)&#123;</span><br><span class="line">						<span class="type">int</span> total_sent = <span class="number">0</span>;</span><br><span class="line">						<span class="keyword">while</span> (total_sent &lt; text_used) &#123;</span><br><span class="line">							<span class="type">int</span> chunk_size = (text_used - total_sent &gt; <span class="number">521</span>) ? <span class="number">521</span> : (text_used - total_sent);</span><br><span class="line">							<span class="type">int</span> sent = lwip_send(sockfd, text_buffer + total_sent, chunk_size, <span class="number">0</span>);</span><br><span class="line">							</span><br><span class="line">							<span class="keyword">if</span> (sent &lt; <span class="number">0</span>) &#123;</span><br><span class="line">								LOG(LOG_LVL_ERROR, <span class="string">&quot;Send error: %d&quot;</span>, errno);</span><br><span class="line">								<span class="keyword">break</span>;</span><br><span class="line">							&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">								total_sent += sent;</span><br><span class="line">								LOG(LOG_LVL_INFO, <span class="string">&quot;Sent %d bytes, total sent: %d bytes&quot;</span>, sent, total_sent);</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>) &#123; <span class="comment">// len == 0:?????</span></span><br><span class="line">                    LOG(LOG_LVL_INFO, <span class="string">&quot;Server closed connection\n&quot;</span>);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (errno == EAGAIN || errno == ETIMEDOUT) &#123;</span><br><span class="line">                    OS_MsDelay(<span class="number">100</span>);</span><br><span class="line">                <span class="comment">// ????:?? Socket?    </span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;lwip_recv failed: %d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//                wifi_sta_get_rssi(&amp;rssi);</span></span><br><span class="line"><span class="comment">//                LOG(LOG_LVL_INFO, &quot;WiFi RSSI: %d dBm\n&quot;, rssi);</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                LOG(LOG_LVL_ERROR, <span class="string">&quot;Socket disconnect, retrying...\n&quot;</span>);</span><br><span class="line">                OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;WiFi disconnected, waiting for reconnect...\n&quot;</span>);</span><br><span class="line">        OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现二-改"><a href="#实现二-改" class="headerlink" title="实现二(改)"></a>实现二(改)</h2><p>基于实现二发现使用 JSON 会有数据量变大、类型相关的问题(接收 JSON 字符串，发送二进制数据)；所以这里将其修改为统一使用二进制进行传输；</p>
<p>自定义数据格式如下：[0xAA] [Type] [2 bytes Length] [Data] [CRC16] [0xFF]</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>0xAA</td>
<td><strong>起始字节</strong>，标识数据包开始</td>
</tr>
<tr>
<td>Type</td>
<td><strong>指令类型</strong>，决定数据的处理方式</td>
</tr>
<tr>
<td>Length</td>
<td><strong>2 字节数据长度</strong>，指示 Escaped Data 的大小</td>
</tr>
<tr>
<td>Data</td>
<td><strong>转义后的数据</strong>，防止特殊字符干扰</td>
</tr>
<tr>
<td>CRC16</td>
<td><strong>校验码</strong>，用于完整性校验(只校验 Data 部分)，CRC16_IBM</td>
</tr>
<tr>
<td>0xFF</td>
<td><strong>结束字节</strong>，标识数据包结束</td>
</tr>
</tbody></table>
<p>自定义响应格式：[0xAA] [response_type] [0xFF]</p>
<table>
<thead>
<tr>
<th>0xAA</th>
<th><strong>起始字节</strong>，标识数据包开始</th>
</tr>
</thead>
<tbody><tr>
<td>response_type</td>
<td><strong>响应类型</strong>，指示服务器的响应结果</td>
</tr>
<tr>
<td>0xFF</td>
<td><strong>结束字节</strong>，标识数据包结束</td>
</tr>
</tbody></table>
<p>特殊要求：发送前客户端会发送整个图片的字节数(32 位变量，4 字节)，存入 MCU；通过累加 [2 bytes Length] 判断是否接收一整个图片完成。</p>
<p><strong>收发流程</strong></p>
<p>以缓冲区 30k 为例：(打印数据)</p>
<p>以缓冲区 30k 为例：(音频数据)<br>超过缓冲区一半，就把数据给喇叭<br>写入缓冲区，超过一半给喇叭</p>
<p>问题：</p>
<p>WiFi 连接正常，但是 socket 一直超时，因为我们使用的非阻塞模式，当 recv 返回 -1 的时候我们不要手动关闭 socket 可减少此类事件的发生；<br>我们当前使用的 socket 是基于 TCP 协议，所以要注意数据粘包的问题；<br>基于环形缓冲区，要注意写入和读取的问题；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SUM_BUFFER_SIZE 30000    <span class="comment">// 循环缓冲区</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TEMP_BUFFER_SIZE 512    <span class="comment">// 临时缓冲区</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_DATA_PER_PACKET 505 <span class="comment">// 单个数据包允许的最大数据长度</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> temp_buffer[TEMP_BUFFER_SIZE];   <span class="comment">// 临时缓冲区</span></span><br><span class="line"><span class="type">uint32_t</span> temp_pos = <span class="number">0</span>;					 <span class="comment">// temp_buffer 写入位置</span></span><br><span class="line"><span class="type">uint32_t</span> data_sum_size = <span class="number">0</span>;				 <span class="comment">// 一段数据大小综合</span></span><br><span class="line"><span class="type">uint8_t</span> is_get_sum_size = <span class="number">0</span>;			 <span class="comment">// 标记是否获取了 data_sum_size</span></span><br><span class="line"><span class="type">uint8_t</span> data_type = <span class="number">0</span>;			         <span class="comment">// 数据类型</span></span><br><span class="line"><span class="type">uint8_t</span> text_buffer[SUM_BUFFER_SIZE];    <span class="comment">// 循环缓冲区</span></span><br><span class="line"><span class="type">uint32_t</span> write_pos = <span class="number">0</span>;					 <span class="comment">// 循环缓冲区的写入位置</span></span><br><span class="line"><span class="type">uint32_t</span> read_pos = <span class="number">0</span>;					 <span class="comment">// 循环缓冲区的读取位置。</span></span><br><span class="line"><span class="type">uint32_t</span> total_written = <span class="number">0</span>;				 <span class="comment">// 已经接收并存储的数据总量。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算 CRC16 校验码(CRC16_IBM 初始值0x0000，低位在前，高位在后，结果与0x0000异或)</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> <span class="title function_">calculate_crc16</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">uint16_t</span> length)</span> &#123;</span><br><span class="line">    <span class="type">uint16_t</span> crc = <span class="number">0x0000</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint16_t</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        crc ^= (<span class="type">uint16_t</span>)data[i] &lt;&lt; <span class="number">8</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">uint8_t</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (crc &amp; <span class="number">0x8000</span>) crc = (crc &lt;&lt; <span class="number">1</span>) ^ <span class="number">0x8005</span>; <span class="keyword">else</span> crc &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> crc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证数据包的格式，</span></span><br><span class="line"><span class="comment">// buffer：指向数据缓冲区的指针（uint8_t *）</span></span><br><span class="line"><span class="comment">// pos: 当前缓冲区中已接收的数据长度</span></span><br><span class="line"><span class="comment">// 1 数据长度不足，-1 数据格式错误，2数据包格式正确</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">validate_format</span><span class="params">(<span class="type">uint8_t</span> *buffer, <span class="type">uint32_t</span> pos)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pos &lt; <span class="number">7</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="type">uint16_t</span> data_length = (buffer[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | buffer[<span class="number">3</span>]; <span class="comment">// 数据长度</span></span><br><span class="line">    <span class="comment">// 数据长度不合法</span></span><br><span class="line">    <span class="keyword">if</span> (data_length &gt; TEMP_BUFFER_SIZE - <span class="number">7</span>) &#123;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;Data length to big langth: %u\n&quot;</span>, data_length);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">uint16_t</span> expected_pos = <span class="number">4</span> + data_length + <span class="number">2</span> + <span class="number">1</span>; <span class="comment">// 完整数据包长度</span></span><br><span class="line">    <span class="keyword">if</span> (pos &lt; expected_pos) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (buffer[<span class="number">0</span>] != <span class="number">0xAA</span> || buffer[expected_pos - <span class="number">1</span>] != <span class="number">0xFF</span> || pos != expected_pos) &#123;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;Data format error: head=0x%02X, tail=0x%02X, pos=%u, expected=%u\n&quot;</span>,</span><br><span class="line">            buffer[<span class="number">0</span>], buffer[pos - <span class="number">1</span>], pos, expected_pos);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>; <span class="comment">// 完整数据包</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送 ACK/NACK 0xAA 代表成功，0xEE 代表失败</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">send_ACK</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">uint8_t</span> response_type)</span> &#123;</span><br><span class="line">    <span class="type">uint8_t</span> response[<span class="number">3</span>] = &#123;<span class="number">0xAA</span>, response_type, <span class="number">0xFF</span>&#125;;</span><br><span class="line">    <span class="type">int</span> attempts = <span class="number">5</span>;</span><br><span class="line">    <span class="type">int</span> sent;</span><br><span class="line">    <span class="comment">// 重试发送循环</span></span><br><span class="line">    <span class="comment">// 循环最多执行 5 次，每次循环减少 attempts，直到成功发送或尝试次数耗尽。</span></span><br><span class="line">    <span class="keyword">while</span> (attempts-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        sent = lwip_send(sockfd, response, <span class="keyword">sizeof</span>(response), <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 错误处理</span></span><br><span class="line">        <span class="keyword">if</span> (sent &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            LOG(LOG_LVL_ERROR, <span class="string">&quot;send_ACK error, errno=%d, attempts left=%d\n&quot;</span>, errno, attempts);</span><br><span class="line">            <span class="keyword">if</span> (errno == EAGAIN || errno == ETIMEDOUT) &#123;</span><br><span class="line">                OS_MsDelay(<span class="number">50</span>); <span class="comment">// 延迟一下再发</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 如果发送的字节数 sent 不等于预期长度 3，记录错误并退出循环。    </span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sent != <span class="keyword">sizeof</span>(response)) &#123;</span><br><span class="line">            LOG(LOG_LVL_ERROR, <span class="string">&quot;Partial ACK send: expected 3, sent %d\n&quot;</span>, sent);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 如果发送成功（sent == 3），记录日志并返回。    </span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;Sent %s\n&quot;</span>, response_type == <span class="number">0xAA</span> ? <span class="string">&quot;ACK&quot;</span> : <span class="string">&quot;NACK&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>; <span class="comment">// ????</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    LOG(LOG_LVL_ERROR, <span class="string">&quot;Failed to send ACK after retries\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收 4 字节的 sum_size（总数据大小）。</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">receive_sum_size</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">uint32_t</span> *sum_size)</span> &#123;</span><br><span class="line">    <span class="type">uint8_t</span> size_buffer[<span class="number">4</span>];</span><br><span class="line">    <span class="type">int</span> size_pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">4</span>];</span><br><span class="line">    <span class="type">int</span> len = lwip_recv(sockfd, buffer, <span class="keyword">sizeof</span>(buffer), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//LOG(LOG_LVL_ERROR, &quot; recv_sum_size error: %d\n&quot;, errno);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;receive_sum_size len: %d\n&quot;</span>, len);</span><br><span class="line">        <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; len &amp;&amp; size_pos &lt; <span class="number">4</span>) &#123;</span><br><span class="line">            size_buffer[size_pos] = buffer[i];</span><br><span class="line">            size_pos++;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (size_pos == <span class="number">4</span>) &#123;</span><br><span class="line">            *sum_size = ((<span class="type">uint32_t</span>)size_buffer[<span class="number">0</span>] &lt;&lt; <span class="number">24</span>) | ((<span class="type">uint32_t</span>)size_buffer[<span class="number">1</span>] &lt;&lt; <span class="number">16</span>) |</span><br><span class="line">                        ((<span class="type">uint32_t</span>)size_buffer[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | (<span class="type">uint32_t</span>)size_buffer[<span class="number">3</span>];</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;Received total size: %u bytes\n&quot;</span>, *sum_size);</span><br><span class="line">            send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">            size_pos = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取可用剩余空间</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint32_t</span> <span class="title function_">get_free_space</span><span class="params">(<span class="type">uint32_t</span> write_pos, <span class="type">uint32_t</span> read_pos)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((write_pos + <span class="number">1</span>) % SUM_BUFFER_SIZE == read_pos) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 缓冲区满</span></span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span> (write_pos &gt;= read_pos) &#123;</span><br><span class="line">        <span class="keyword">return</span> SUM_BUFFER_SIZE - (write_pos - read_pos) - <span class="number">1</span>; <span class="comment">// 预留 1 个字节空间</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> read_pos - write_pos - <span class="number">1</span>; <span class="comment">// 预留 1 个字节空间</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 入环形缓冲区，如果超出结尾，则分两次写入。</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">write_circular_buffer</span><span class="params">(<span class="type">uint8_t</span> *buffer, <span class="type">uint32_t</span> *write_pos, <span class="type">uint32_t</span> *read_pos, <span class="type">uint8_t</span> *data, <span class="type">uint16_t</span> data_length)</span> &#123;</span><br><span class="line">    <span class="type">uint32_t</span> free_space = get_free_space(*write_pos, *read_pos);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 预留一个字节以确保环形缓冲区不会满</span></span><br><span class="line">    <span class="keyword">if</span> (free_space &lt;= data_length) &#123; </span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;Not enough space: available=%u, required=%u\n&quot;</span>, free_space, data_length);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> space_to_end = SUM_BUFFER_SIZE - *write_pos;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (space_to_end &gt;= data_length) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;buffer[*write_pos], data, data_length);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;buffer[*write_pos], data, space_to_end);</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;buffer[<span class="number">0</span>], data + space_to_end, data_length - space_to_end);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新写指针</span></span><br><span class="line">    *write_pos = (*write_pos + data_length) % SUM_BUFFER_SIZE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sokcet 数据接收</span></span><br><span class="line"><span class="comment">// 0 超时等待，-1 len &lt;= 0</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">receive_data</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">uint32_t</span> sum_size, <span class="type">uint8_t</span> *text_buffer, <span class="type">uint32_t</span> *write_pos, <span class="type">uint32_t</span> *read_pos)</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">uint8_t</span> buffer[<span class="number">512</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> len = lwip_recv(sockfd, buffer, <span class="keyword">sizeof</span>(buffer), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EAGAIN || errno == ETIMEDOUT) &#123;</span><br><span class="line">            OS_MsDelay(<span class="number">100</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 继续等待</span></span><br><span class="line">        &#125;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;receive_data failed: %d\n&quot;</span>, errno);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>) &#123;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;Server closed connection\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	LOG(LOG_LVL_INFO, <span class="string">&quot;Received_data %d bytes...\n&quot;</span>, len);</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; len) &#123;</span><br><span class="line">        <span class="keyword">if</span> (temp_pos &lt; TEMP_BUFFER_SIZE) &#123;</span><br><span class="line">            temp_buffer[temp_pos] = buffer[i];</span><br><span class="line">            temp_pos++;</span><br><span class="line">            <span class="type">int</span> validation_result = validate_format(temp_buffer, temp_pos);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (validation_result == <span class="number">-1</span>) &#123; <span class="comment">// 校验失败，丢弃数据</span></span><br><span class="line">                send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">                temp_pos = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (validation_result == <span class="number">2</span>) &#123; <span class="comment">// 完整数据包</span></span><br><span class="line">                <span class="type">uint16_t</span> data_length = (temp_buffer[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | temp_buffer[<span class="number">3</span>];</span><br><span class="line">                data_type = temp_buffer[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">                <span class="type">uint8_t</span> *data = &amp;temp_buffer[<span class="number">4</span>];</span><br><span class="line">                <span class="type">uint16_t</span> recv_crc = (temp_buffer[<span class="number">4</span> + data_length] &lt;&lt; <span class="number">8</span>) | temp_buffer[<span class="number">5</span> + data_length];</span><br><span class="line">                <span class="type">uint16_t</span> calculated_crc = calculate_crc16(data, data_length);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (calculated_crc != recv_crc) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;CRC16 mismatch: received=0x%04X, calculated=0x%04X\n&quot;</span>, recv_crc, calculated_crc);</span><br><span class="line">                    send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (write_circular_buffer(text_buffer, write_pos, read_pos, data, data_length) != <span class="number">0</span>) &#123;</span><br><span class="line">                        LOG(LOG_LVL_ERROR, <span class="string">&quot;Write to buffer failed\n&quot;</span>);</span><br><span class="line">                        send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        total_written += data_length;</span><br><span class="line">                        send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">                        <span class="keyword">if</span>()</span><br><span class="line">                        LOG(LOG_LVL_INFO, <span class="string">&quot;CRC match, total_written=%u\n&quot;</span>, total_written);</span><br><span class="line">                        temp_pos = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">2</span>; <span class="comment">// 数据包成功处理</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                temp_pos = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">            temp_pos = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">send_data</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">uint8_t</span> type, <span class="type">uint16_t</span> length, <span class="type">uint8_t</span> *data)</span> &#123;</span><br><span class="line">    <span class="type">uint16_t</span> remaining_length = length;         <span class="comment">// 剩余待发送的数据长度</span></span><br><span class="line">    <span class="type">uint8_t</span> *data_ptr = data;                   <span class="comment">// 数据指针，指向当前发送位置</span></span><br><span class="line">    <span class="type">uint8_t</span> send_buffer[<span class="number">7</span> + MAX_DATA_PER_PACKET]; <span class="comment">// 缓冲区，最大支持 512 字节</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (remaining_length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 计算本次发送的数据长度，最大 505 字节（确保总包长 &lt;= 512 字节）</span></span><br><span class="line">        <span class="type">uint16_t</span> chunk_length = (remaining_length &gt; MAX_DATA_PER_PACKET) ? MAX_DATA_PER_PACKET : remaining_length;</span><br><span class="line">        <span class="type">uint16_t</span> total_packet_length = <span class="number">7</span> + chunk_length; <span class="comment">// 总包长 = 7（头尾）+ 数据长度</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构建数据包</span></span><br><span class="line">        send_buffer[<span class="number">0</span>] = <span class="number">0xAA</span>;                    <span class="comment">// 帧头</span></span><br><span class="line">        send_buffer[<span class="number">1</span>] = type;                    <span class="comment">// 数据类型</span></span><br><span class="line">        send_buffer[<span class="number">2</span>] = (chunk_length &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>; <span class="comment">// 长度高字节</span></span><br><span class="line">        send_buffer[<span class="number">3</span>] = chunk_length &amp; <span class="number">0xFF</span>;     <span class="comment">// 长度低字节</span></span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;send_buffer[<span class="number">4</span>], data_ptr, chunk_length); <span class="comment">// 复制数据</span></span><br><span class="line">        <span class="type">uint16_t</span> crc = calculate_crc16(data_ptr, chunk_length); <span class="comment">// 计算 CRC16</span></span><br><span class="line">        send_buffer[<span class="number">4</span> + chunk_length] = (crc &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>; <span class="comment">// CRC 高字节</span></span><br><span class="line">        send_buffer[<span class="number">5</span> + chunk_length] = crc &amp; <span class="number">0xFF</span>; <span class="comment">// CRC 低字节</span></span><br><span class="line">        send_buffer[<span class="number">6</span> + chunk_length] = <span class="number">0xFF</span>;     <span class="comment">// 帧尾</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送数据包</span></span><br><span class="line">        <span class="type">int</span> sent = lwip_send(sockfd, send_buffer, total_packet_length, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (sent &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            LOG(LOG_LVL_ERROR, <span class="string">&quot;Send error: %d\n&quot;</span>, errno);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sent != total_packet_length) &#123;</span><br><span class="line">            LOG(LOG_LVL_ERROR, <span class="string">&quot;Partial send: expected %d, sent %d\n&quot;</span>, total_packet_length, sent);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;Sent %d bytes (data length: %u)\n&quot;</span>, sent, chunk_length);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新指针和剩余长度</span></span><br><span class="line">        remaining_length -= chunk_length;</span><br><span class="line">        data_ptr += chunk_length;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 短暂延迟，避免发送过快（可选，根据需求调整）</span></span><br><span class="line">        OS_MsDelay(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">socket_task_entry</span><span class="params">(<span class="type">void</span> *params)</span> &#123;</span><br><span class="line">    LN_UNUSED(params);</span><br><span class="line">    <span class="type">int</span> sockfd = <span class="number">-1</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_addr</span>;</span></span><br><span class="line">    <span class="type">int</span> timeout_ms = <span class="number">5000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!netdev_got_ip()) &#123;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;No IP, waiting for WiFi...\n&quot;</span>);</span><br><span class="line">            OS_MsDelay(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">tcpip_ip_info_t</span> ip_info;</span><br><span class="line">        netdev_get_ip_info(NETIF_IDX_STA, &amp;ip_info);</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;IP: %s, Mask: %s, Gateway: %s\n&quot;</span>,</span><br><span class="line">            ip4addr_ntoa(&amp;ip_info.ip), ip4addr_ntoa(&amp;ip_info.netmask), ip4addr_ntoa(&amp;ip_info.gw));</span><br><span class="line">        </span><br><span class="line">        <span class="type">int8_t</span> rssi;</span><br><span class="line">        wifi_sta_get_rssi(&amp;rssi);</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;WiFi RSSI: %d dBm\n&quot;</span>, rssi);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (netdev_got_ip()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                sockfd = lwip_socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Socket creation failed: %d\n&quot;</span>, errno);</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Socket create ID=%d\n&quot;</span>, sockfd);</span><br><span class="line">                <span class="comment">// 设置为非阻塞模式</span></span><br><span class="line">                <span class="type">int</span> flags = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (lwip_ioctl(sockfd, FIONBIO, &amp;flags) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;socket ioctl error: %d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">memset</span>(&amp;server_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">                server_addr.sin_family = AF_INET;</span><br><span class="line">                server_addr.sin_port = lwip_htons(<span class="number">8080</span>);</span><br><span class="line">                server_addr.sin_addr.s_addr = inet_addr(<span class="string">&quot;192.168.106.181&quot;</span>);</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Connecting to 192.168.106.181:8080...\n&quot;</span>);</span><br><span class="line">                <span class="type">int</span> connect_result = lwip_connect(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">                <span class="keyword">if</span> (connect_result &lt; <span class="number">0</span> &amp;&amp; errno != EINPROGRESS) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;lwip_connect failed: %d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                fd_set writefds, exceptfds;</span><br><span class="line">                <span class="comment">//struct timeval tv = &#123;5, 0&#125;;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">                tv.tv_sec = <span class="number">10</span>;</span><br><span class="line">                tv.tv_usec = <span class="number">0</span>;</span><br><span class="line">                FD_ZERO(&amp;writefds);</span><br><span class="line">                FD_ZERO(&amp;exceptfds);</span><br><span class="line">                FD_SET(sockfd, &amp;writefds);</span><br><span class="line">                FD_SET(sockfd, &amp;exceptfds);</span><br><span class="line">                <span class="type">int</span> select_result = lwip_select(sockfd + <span class="number">1</span>, <span class="literal">NULL</span>, &amp;writefds, &amp;exceptfds, &amp;tv);</span><br><span class="line">                <span class="keyword">if</span> (select_result &lt;= <span class="number">0</span> || FD_ISSET(sockfd, &amp;exceptfds)) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Connect timed out or failed: %d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">int</span> so_error = <span class="number">0</span>;</span><br><span class="line">                <span class="type">socklen_t</span> len = <span class="keyword">sizeof</span>(so_error);</span><br><span class="line">                <span class="keyword">if</span> (lwip_getsockopt(sockfd, SOL_SOCKET, SO_ERROR, &amp;so_error, &amp;len) &lt; <span class="number">0</span> || so_error != <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Connect failed with error: %d\n&quot;</span>, so_error);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Connected to 192.168.106.181:8080\n&quot;</span>);</span><br><span class="line">                tv.tv_sec = timeout_ms / <span class="number">1000</span>;</span><br><span class="line">                tv.tv_usec = (timeout_ms % <span class="number">1000</span>) * <span class="number">1000</span>;</span><br><span class="line">                <span class="keyword">if</span> (lwip_setsockopt(sockfd, SOL_SOCKET, SO_RCVTIMEO, &amp;tv, <span class="keyword">sizeof</span>(tv)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;setsockopt SO_RCVTIMEO failed: %d\n&quot;</span>, errno);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (sockfd &gt;= <span class="number">0</span> &amp;&amp; netdev_got_ip()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!is_get_sum_size) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (receive_sum_size(sockfd, &amp;data_sum_size) == <span class="number">1</span>) &#123;</span><br><span class="line">                        is_get_sum_size = <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 接收数据</span></span><br><span class="line">                    <span class="type">int</span> result = receive_data(sockfd, data_sum_size, text_buffer, &amp;write_pos, &amp;read_pos);</span><br><span class="line">                    <span class="keyword">if</span> (result == <span class="number">-1</span>) &#123;</span><br><span class="line">                        LOG(LOG_LVL_ERROR, <span class="string">&quot;receive_data result -1...\n&quot;</span>);</span><br><span class="line">                        lwip_close(sockfd);</span><br><span class="line">                        sockfd = <span class="number">-1</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 数据包写入成功处理时，检查是否需要发送</span></span><br><span class="line">                    <span class="keyword">if</span> (result == <span class="number">2</span>) &#123;</span><br><span class="line">                        <span class="comment">// 计算环形缓冲区中当前可读取的数据量（即已写入但尚未发送的数据）。</span></span><br><span class="line">                        <span class="comment">//write_pos 是环形缓冲区的写入指针，表示最新的写入位置。</span></span><br><span class="line">						<span class="comment">//read_pos 是环形缓冲区的读取指针，表示下一次读取的起始位置。</span></span><br><span class="line">						<span class="comment">//SUM_BUFFER_SIZE 是环形缓冲区的总容量（例如 30000 字节）。</span></span><br><span class="line">                        <span class="type">uint32_t</span> available_data = (write_pos &gt;= read_pos) </span><br><span class="line">                            ? (write_pos - read_pos) </span><br><span class="line">                            : (SUM_BUFFER_SIZE - read_pos + write_pos);</span><br><span class="line">                        LOG(LOG_LVL_INFO, <span class="string">&quot;available_data=%u\n&quot;</span>, available_data);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 计算一个动态发送阈值，用于决定何时触发数据发送</span></span><br><span class="line">                        <span class="type">uint32_t</span> send_threshold;</span><br><span class="line">                        <span class="keyword">if</span> (data_sum_size &gt;= SUM_BUFFER_SIZE / <span class="number">2</span>) &#123;</span><br><span class="line">                            send_threshold = SUM_BUFFER_SIZE / <span class="number">2</span>; <span class="comment">// 缓冲区一半满时发送</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            send_threshold = data_sum_size; <span class="comment">// 小于一半时，全部数据到达时发送</span></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//判断当前可读取的数据量是否大于等于发送阈值。</span></span><br><span class="line">                        <span class="keyword">if</span> (available_data &gt;= send_threshold) &#123;</span><br><span class="line">                            <span class="type">uint16_t</span> length = available_data;</span><br><span class="line">                            <span class="keyword">if</span> (length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                send_data(sockfd, data_type, length, &amp;text_buffer[read_pos]);</span><br><span class="line">                                read_pos = (read_pos + length) % SUM_BUFFER_SIZE;</span><br><span class="line">                                LOG(LOG_LVL_INFO, <span class="string">&quot;Sent %u bytes, new read_pos=%u\n&quot;</span>, length, read_pos);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (total_written &gt;= data_sum_size) &#123;</span><br><span class="line">                        <span class="type">uint32_t</span> available_data = (write_pos &gt;= read_pos) </span><br><span class="line">                            ? (write_pos - read_pos) </span><br><span class="line">                            : (SUM_BUFFER_SIZE - read_pos + write_pos);</span><br><span class="line">                        <span class="keyword">if</span> (available_data &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            send_data(sockfd, data_type, available_data, &amp;text_buffer[read_pos]);</span><br><span class="line">                            read_pos = (read_pos + available_data) % SUM_BUFFER_SIZE;</span><br><span class="line">                            LOG(LOG_LVL_INFO, <span class="string">&quot;Final send: Sent %u bytes, new read_pos=%u\n&quot;</span>, available_data, read_pos);</span><br><span class="line">                        &#125;</span><br><span class="line">                        is_get_sum_size = <span class="number">0</span>;</span><br><span class="line">                        total_written = <span class="number">0</span>;</span><br><span class="line">                        write_pos = <span class="number">0</span>;</span><br><span class="line">                        read_pos = <span class="number">0</span>; <span class="comment">// 重置</span></span><br><span class="line">                        LOG(LOG_LVL_INFO, <span class="string">&quot;Reset state for next transmission\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;                    </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                LOG(LOG_LVL_ERROR, <span class="string">&quot;Socket disconnect, retrying...\n&quot;</span>);</span><br><span class="line">                OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;WiFi disconnected, waiting...\n&quot;</span>);</span><br><span class="line">        OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现三"><a href="#实现三" class="headerlink" title="实现三"></a>实现三</h2><p>要区分打印数据和音频数据，利用现用自定义格式重新规划收发流程：</p>
<p>收发流程如下：<br><strong>引导阶段</strong>：<br>MCU 接收一个响应包 [0xAA][0x01][0xFF]，表示数据传输开始。<br>紧接着接收一个数据包：</p>
<ul>
<li>[0xAA][0x11][0x00][0x00][CRC16][0xFF]：打印数据引导。</li>
<li>[0xAA][0x12][0x00][0x00][CRC16][0xFF]：音频数据引导。</li>
</ul>
<p><strong>数据接收阶段</strong>：</p>
<ul>
<li>打印数据（0x11）：<ul>
<li>接收 4 字节总长度。</li>
<li>根据总长度接收后续数据包（如 [0xAA][0x11][Length][Data][CRC16][0xFF]）。</li>
<li>每包回写 [0xAA][0xAA][0xFF]（ACK）或 [0xAA][0xEE][0xFF]（NACK）。</li>
</ul>
</li>
<li>音频数据（0x12）：<ul>
<li>直接接收数据包（如 [0xAA][0x12][Length][Data][CRC16][0xFF]）。</li>
<li>每包回写 ACK&#x2F;NACK。</li>
<li>无需总长度，动态累积数据。</li>
</ul>
</li>
</ul>
<p><strong>结束阶段</strong>：</p>
<ul>
<li>发送端发送 [0xAA][0x02][0xFF] 表示传输结束。</li>
<li>MCU 检测到此包后停止接收。</li>
</ul>
<p><strong>拆包与粘包</strong><br>在 TCP 传输中，由于<strong>流式</strong>传输的特性，数据可能会被拆分成多个小包发送（拆包）或者多个小包合并成一个大包接收（粘包）<br>拆包：如果 send(1024)，recv(512)，TCP 在协议层面会将一个 1024 大小的包拆成两个 512 大小的包<br>粘包：如果 send(512)，recv(1024)，TCP 在协议层面会将 两个 512 大小的包组合成一个 1024 大小的包</p>
<p><strong>数据流示例</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 打印数据</span></span><br><span class="line">[<span class="number">0xAA</span>][<span class="number">0x01</span>][<span class="number">0xFF</span>]                     <span class="comment">// 引导开始</span></span><br><span class="line">[<span class="number">0xAA</span>][<span class="number">0xAA</span>][<span class="number">0xFF</span>]                     <span class="comment">// ACK</span></span><br><span class="line">[<span class="number">0xAA</span>][<span class="number">0x11</span>][<span class="number">0x00</span>][<span class="number">0x00</span>][CRC16][<span class="number">0xFF</span>]  <span class="comment">// 打印引导</span></span><br><span class="line">[<span class="number">0xAA</span>][<span class="number">0xAA</span>][<span class="number">0xFF</span>]                     <span class="comment">// ACK</span></span><br><span class="line">[<span class="number">0x00</span>][<span class="number">0x00</span>][<span class="number">0x61</span>][<span class="number">0xB5</span>]               <span class="comment">// 总长度 24965</span></span><br><span class="line">[<span class="number">0xAA</span>][<span class="number">0x11</span>][<span class="number">0x01</span>][<span class="number">0xF9</span>][Data <span class="number">505</span>][CRC16][<span class="number">0xFF</span>]  <span class="comment">// 数据包1</span></span><br><span class="line">[<span class="number">0xAA</span>][<span class="number">0xAA</span>][<span class="number">0xFF</span>]                     <span class="comment">// ACK</span></span><br><span class="line">...</span><br><span class="line">[<span class="number">0xAA</span>][<span class="number">0x02</span>][<span class="number">0xFF</span>]                     <span class="comment">// 结束</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 音频数据</span></span><br><span class="line">[<span class="number">0xAA</span>][<span class="number">0x01</span>][<span class="number">0xFF</span>]                     <span class="comment">// 引导开始</span></span><br><span class="line">[<span class="number">0xAA</span>][<span class="number">0xAA</span>][<span class="number">0xFF</span>]                     <span class="comment">// ACK</span></span><br><span class="line">[<span class="number">0xAA</span>][<span class="number">0x12</span>][<span class="number">0x00</span>][<span class="number">0x00</span>][CRC16][<span class="number">0xFF</span>]  <span class="comment">// 音频引导</span></span><br><span class="line">[<span class="number">0xAA</span>][<span class="number">0xAA</span>][<span class="number">0xFF</span>]                     <span class="comment">// ACK</span></span><br><span class="line">[<span class="number">0xAA</span>][<span class="number">0x12</span>][<span class="number">0x01</span>][<span class="number">0xF9</span>][Data <span class="number">505</span>][CRC16][<span class="number">0xFF</span>]  <span class="comment">// 数据包1</span></span><br><span class="line">[<span class="number">0xAA</span>][<span class="number">0xAA</span>][<span class="number">0xFF</span>]                     <span class="comment">// ACK</span></span><br><span class="line">...</span><br><span class="line">[<span class="number">0xAA</span>][<span class="number">0x02</span>][<span class="number">0xFF</span>]                     <span class="comment">// 结束</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SUM_BUFFER_SIZE 30000    <span class="comment">// 循环缓冲区</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TEMP_BUFFER_SIZE 512     <span class="comment">// 临时缓冲区</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_DATA_PER_PACKET 505  <span class="comment">// 单个数据包允许的最大数据长度</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 状态定义</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    STATE_IDLE,      <span class="comment">// 等待开始信号</span></span><br><span class="line">    STATE_TYPE,      <span class="comment">// 等待类型包</span></span><br><span class="line">    STATE_PRINT,     <span class="comment">// 打印数据模式</span></span><br><span class="line">    STATE_AUDIO      <span class="comment">// 音频数据模式</span></span><br><span class="line">&#125; State_t;</span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> temp_buffer[TEMP_BUFFER_SIZE];   <span class="comment">// 临时缓冲区</span></span><br><span class="line"><span class="type">uint32_t</span> temp_pos = <span class="number">0</span>;                   <span class="comment">// temp_buffer 写入位置</span></span><br><span class="line"><span class="type">uint32_t</span> data_sum_size = <span class="number">0</span>;              <span class="comment">// 总数据大小（打印模式）</span></span><br><span class="line"><span class="type">uint8_t</span> is_get_sum_size = <span class="number">0</span>;             <span class="comment">// 是否获取总长度</span></span><br><span class="line"><span class="type">uint8_t</span> data_type = <span class="number">0</span>;                   <span class="comment">// 数据类型</span></span><br><span class="line"><span class="type">uint8_t</span> text_buffer[SUM_BUFFER_SIZE];    <span class="comment">// 循环缓冲区</span></span><br><span class="line"><span class="type">uint32_t</span> write_pos = <span class="number">0</span>;                  <span class="comment">// 写入位置</span></span><br><span class="line"><span class="type">uint32_t</span> read_pos = <span class="number">0</span>;                   <span class="comment">// 读取位置</span></span><br><span class="line"><span class="type">uint32_t</span> total_written = <span class="number">0</span>;              <span class="comment">// 已接收数据总量</span></span><br><span class="line">State_t state = STATE_IDLE;              <span class="comment">// 当前状态</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算 CRC16</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">calculate_crc16</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">uint16_t</span> length)</span> &#123;</span><br><span class="line">    <span class="type">uint16_t</span> crc = <span class="number">0x0000</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint16_t</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        crc ^= (<span class="type">uint16_t</span>)data[i] &lt;&lt; <span class="number">8</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">uint8_t</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (crc &amp; <span class="number">0x8000</span>) crc = (crc &lt;&lt; <span class="number">1</span>) ^ <span class="number">0x8005</span>; <span class="keyword">else</span> crc &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> crc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证数据包格式</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">validate_format</span><span class="params">(<span class="type">uint8_t</span> *buffer, <span class="type">uint32_t</span> pos)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pos &lt; <span class="number">7</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="type">uint16_t</span> data_length = (buffer[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | buffer[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">if</span> (data_length &gt; TEMP_BUFFER_SIZE - <span class="number">7</span>) &#123;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;Data length too big: %u\n&quot;</span>, data_length);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">uint16_t</span> expected_pos = <span class="number">4</span> + data_length + <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (pos &lt; expected_pos) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (buffer[<span class="number">0</span>] != <span class="number">0xAA</span> || buffer[expected_pos - <span class="number">1</span>] != <span class="number">0xFF</span> || pos != expected_pos) &#123;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;Data format error: head=0x%02X, tail=0x%02X, pos=%u, expected=%u\n&quot;</span>,</span><br><span class="line">            buffer[<span class="number">0</span>], buffer[pos - <span class="number">1</span>], pos, expected_pos);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送 ACK/NACK</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">send_ACK</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">uint8_t</span> response_type)</span> &#123;</span><br><span class="line">    <span class="type">uint8_t</span> response[<span class="number">3</span>] = &#123;<span class="number">0xAA</span>, response_type, <span class="number">0xFF</span>&#125;;</span><br><span class="line">    <span class="type">int</span> attempts = <span class="number">5</span>;</span><br><span class="line">    <span class="type">int</span> sent;</span><br><span class="line">    <span class="keyword">while</span> (attempts-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        sent = lwip_send(sockfd, response, <span class="keyword">sizeof</span>(response), <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (sent &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            LOG(LOG_LVL_ERROR, <span class="string">&quot;send_ACK error, errno=%d, attempts left=%d\n&quot;</span>, errno, attempts);</span><br><span class="line">            <span class="keyword">if</span> (errno == EAGAIN || errno == ETIMEDOUT) &#123;</span><br><span class="line">                OS_MsDelay(<span class="number">50</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sent != <span class="keyword">sizeof</span>(response)) &#123;</span><br><span class="line">            LOG(LOG_LVL_ERROR, <span class="string">&quot;Partial ACK send: expected 3, sent %d\n&quot;</span>, sent);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span>(response_type)&#123;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">0xAA</span>: LOG(LOG_LVL_INFO, <span class="string">&quot;Sent %s\n&quot;</span>, <span class="string">&quot;ACK_0xAA&quot;</span>);<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">0xEE</span>: LOG(LOG_LVL_INFO, <span class="string">&quot;Sent %s\n&quot;</span>, <span class="string">&quot;NACK_0xEE&quot;</span>);<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">0x02</span>: LOG(LOG_LVL_INFO, <span class="string">&quot;Sent %s\n&quot;</span>, <span class="string">&quot;ACK_0x02&quot;</span>);<span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0x01</span>: LOG(LOG_LVL_INFO, <span class="string">&quot;Sent %s\n&quot;</span>, <span class="string">&quot;ACK_0x01&quot;</span>);<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    LOG(LOG_LVL_ERROR, <span class="string">&quot;Failed to send ACK after retries\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收 4 字节总长度</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">receive_sum_size</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">uint32_t</span> *sum_size)</span> &#123;</span><br><span class="line">    <span class="type">uint8_t</span> size_buffer[<span class="number">4</span>];</span><br><span class="line">    <span class="type">int</span> size_pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">4</span>];</span><br><span class="line">    <span class="type">int</span> len = lwip_recv(sockfd, buffer, <span class="keyword">sizeof</span>(buffer), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//LOG(LOG_LVL_ERROR, &quot; failed: %d\n&quot;, errno);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;receive_sum_size len: %d\n&quot;</span>, len);</span><br><span class="line">        <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; len &amp;&amp; size_pos &lt; <span class="number">4</span>) &#123;</span><br><span class="line">            size_buffer[size_pos] = buffer[i];</span><br><span class="line">            size_pos++;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (size_pos == <span class="number">4</span>) &#123;</span><br><span class="line">            *sum_size = ((<span class="type">uint32_t</span>)size_buffer[<span class="number">0</span>] &lt;&lt; <span class="number">24</span>) | ((<span class="type">uint32_t</span>)size_buffer[<span class="number">1</span>] &lt;&lt; <span class="number">16</span>) |</span><br><span class="line">                        ((<span class="type">uint32_t</span>)size_buffer[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | (<span class="type">uint32_t</span>)size_buffer[<span class="number">3</span>];</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;Received total size: %u bytes\n&quot;</span>, *sum_size);</span><br><span class="line">            send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取环形缓冲区剩余空间</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">get_free_space</span><span class="params">(<span class="type">uint32_t</span> write_pos, <span class="type">uint32_t</span> read_pos)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((write_pos + <span class="number">1</span>) % SUM_BUFFER_SIZE == read_pos) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (write_pos &gt;= read_pos) &#123;</span><br><span class="line">        <span class="keyword">return</span> SUM_BUFFER_SIZE - (write_pos - read_pos) - <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> read_pos - write_pos - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写入环形缓冲区</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> <span class="title function_">write_circular_buffer</span><span class="params">(<span class="type">uint8_t</span> *buffer, <span class="type">uint32_t</span> *write_pos, <span class="type">uint32_t</span> *read_pos, <span class="type">uint8_t</span> *data, <span class="type">uint16_t</span> data_length)</span> &#123;</span><br><span class="line">    <span class="type">uint32_t</span> free_space = get_free_space(*write_pos, *read_pos);</span><br><span class="line">    <span class="keyword">if</span> (free_space &lt;= data_length) &#123;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;Not enough space: available=%u, required=%u\n&quot;</span>, free_space, data_length);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">uint32_t</span> space_to_end = SUM_BUFFER_SIZE - *write_pos;</span><br><span class="line">    <span class="keyword">if</span> (space_to_end &gt;= data_length) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;buffer[*write_pos], data, data_length);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;buffer[*write_pos], data, space_to_end);</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;buffer[<span class="number">0</span>], data + space_to_end, data_length - space_to_end);</span><br><span class="line">    &#125;</span><br><span class="line">    *write_pos = (*write_pos + data_length) % SUM_BUFFER_SIZE;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收数据(包含粘包处理逻辑)</span></span><br><span class="line"><span class="comment">// 0: ，-1:表示服务端关闭连接</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">receive_data</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">uint8_t</span> *text_buffer, <span class="type">uint32_t</span> *write_pos, <span class="type">uint32_t</span> *read_pos)</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">uint8_t</span> buffer[<span class="number">1024</span>];           <span class="comment">// 接收缓冲区</span></span><br><span class="line">    <span class="type">static</span> <span class="type">uint8_t</span> temp_buffer[<span class="number">1024</span>];      <span class="comment">// 临时缓冲区，用于累积和拼接数据</span></span><br><span class="line">    <span class="type">static</span> <span class="type">uint32_t</span> temp_pos = <span class="number">0</span>;         <span class="comment">// 临时缓冲区的写位置</span></span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> has_partial = <span class="number">0</span>;           <span class="comment">// 标志：是否有未完成的半包数据</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果有未处理的包，先尝试处理</span></span><br><span class="line">    <span class="comment">// has_partial = 1说明有未处理的包，</span></span><br><span class="line">    <span class="comment">// temp_pos 说明缓冲区中还有没用写入全局缓存区的数据</span></span><br><span class="line">    <span class="keyword">if</span> (has_partial &amp;&amp; temp_pos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 验证未写入的数据是否是整包</span></span><br><span class="line">        <span class="type">int</span> validation_result = validate_format(temp_buffer, temp_pos);</span><br><span class="line">        <span class="keyword">if</span> (validation_result == <span class="number">2</span>) &#123; <span class="comment">// 整包的处理逻辑</span></span><br><span class="line">            <span class="comment">// 处理完整的半包数据</span></span><br><span class="line">            <span class="type">uint16_t</span> data_length = (temp_buffer[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | temp_buffer[<span class="number">3</span>];</span><br><span class="line">            <span class="type">uint8_t</span> data_type = temp_buffer[<span class="number">1</span>];</span><br><span class="line">            <span class="type">uint8_t</span> *data = &amp;temp_buffer[<span class="number">4</span>];</span><br><span class="line">            <span class="type">uint16_t</span> recv_crc = (temp_buffer[<span class="number">4</span> + data_length] &lt;&lt; <span class="number">8</span>) | temp_buffer[<span class="number">5</span> + data_length];</span><br><span class="line">            <span class="type">uint16_t</span> calculated_crc = calculate_crc16(data, data_length);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (calculated_crc != recv_crc) &#123;</span><br><span class="line">                LOG(LOG_LVL_ERROR, <span class="string">&quot;CRC16 mismatch: received=0x%04X, calculated=0x%04X\n&quot;</span>, recv_crc, calculated_crc);</span><br><span class="line">                send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (data_length == <span class="number">0</span> &amp;&amp; (data_type == <span class="number">0x11</span> || data_type == <span class="number">0x12</span>)) &#123;</span><br><span class="line">                    LOG(LOG_LVL_INFO, <span class="string">&quot;recv type : 0x%02X\n&quot;</span>, data_type);</span><br><span class="line">                    send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">                    state = (data_type == <span class="number">0x11</span>) ? STATE_PRINT : STATE_AUDIO;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (write_circular_buffer(text_buffer, write_pos, read_pos, data, data_length) != <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Write to buffer failed\n&quot;</span>);</span><br><span class="line">                    send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    total_written += data_length;</span><br><span class="line">                    send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">                    LOG(LOG_LVL_INFO, <span class="string">&quot;CRC match, total_written=%u\n&quot;</span>, total_written);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            temp_pos = <span class="number">0</span>;</span><br><span class="line">            has_partial = <span class="number">0</span>; <span class="comment">// 重置半包标志</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (validation_result == <span class="number">-1</span>) &#123; <span class="comment">// 数据包格式错误</span></span><br><span class="line">            send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">            temp_pos = <span class="number">0</span>;</span><br><span class="line">            has_partial = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果仍不完整，继续等待新数据</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接收新数据</span></span><br><span class="line">    <span class="type">int</span> len = lwip_recv(sockfd, buffer, <span class="keyword">sizeof</span>(buffer), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EAGAIN || errno == ETIMEDOUT) &#123;</span><br><span class="line">            OS_MsDelay(<span class="number">100</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;receive_data len &lt; 0: %d\n&quot;</span>, errno);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>) &#123;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;Server closed connection\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; len) &#123;</span><br><span class="line">        <span class="comment">// 如果 temp_buffer 已满，丢弃并重置</span></span><br><span class="line">        <span class="keyword">if</span> (temp_pos &gt;= <span class="keyword">sizeof</span>(temp_buffer)) &#123;</span><br><span class="line">            send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">            temp_pos = <span class="number">0</span>;</span><br><span class="line">            has_partial = <span class="number">0</span>;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;temp_pos &gt;= sizeof(temp_buffer)...\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将新字节追加到 temp_buffer</span></span><br><span class="line">        temp_buffer[temp_pos] = buffer[i];</span><br><span class="line">        temp_pos++;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> validation_result = validate_format(temp_buffer, temp_pos);</span><br><span class="line">        <span class="keyword">if</span> (validation_result == <span class="number">-1</span>) &#123;</span><br><span class="line">            send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">            temp_pos = <span class="number">0</span>;</span><br><span class="line">            has_partial = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (validation_result == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 处理完整包</span></span><br><span class="line">            <span class="type">uint16_t</span> data_length = (temp_buffer[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | temp_buffer[<span class="number">3</span>];</span><br><span class="line">            <span class="type">uint8_t</span> data_type = temp_buffer[<span class="number">1</span>];</span><br><span class="line">            <span class="type">uint8_t</span> *data = &amp;temp_buffer[<span class="number">4</span>];</span><br><span class="line">            <span class="type">uint16_t</span> recv_crc = (temp_buffer[<span class="number">4</span> + data_length] &lt;&lt; <span class="number">8</span>) | temp_buffer[<span class="number">5</span> + data_length];</span><br><span class="line">            <span class="type">uint16_t</span> calculated_crc = calculate_crc16(data, data_length);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (calculated_crc != recv_crc) &#123;</span><br><span class="line">                LOG(LOG_LVL_ERROR, <span class="string">&quot;CRC16 mismatch: received=0x%04X, calculated=0x%04X\n&quot;</span>, recv_crc, calculated_crc);</span><br><span class="line">                send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (data_length == <span class="number">0</span> &amp;&amp; (data_type == <span class="number">0x11</span> || data_type == <span class="number">0x12</span>)) &#123;</span><br><span class="line">                    LOG(LOG_LVL_INFO, <span class="string">&quot;recv type : 0x%02X\n&quot;</span>, data_type);</span><br><span class="line">                    send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">                    state = (data_type == <span class="number">0x11</span>) ? STATE_PRINT : STATE_AUDIO;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (write_circular_buffer(text_buffer, write_pos, read_pos, data, data_length) != <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Write to buffer failed\n&quot;</span>);</span><br><span class="line">                    send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    total_written += data_length;</span><br><span class="line">                    send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">                    LOG(LOG_LVL_INFO, <span class="string">&quot;CRC match, total_written=%u\n&quot;</span>, total_written);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            temp_pos = <span class="number">0</span>;</span><br><span class="line">            has_partial = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检查剩余字节是否为新包的开始</span></span><br><span class="line">            <span class="keyword">if</span> (i + <span class="number">1</span> &lt; len) &#123;</span><br><span class="line">                <span class="keyword">if</span> (buffer[i + <span class="number">1</span>] != <span class="number">0xAA</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_INFO, <span class="string">&quot;Discarding invalid data after packet: %02X\n&quot;</span>, buffer[i + <span class="number">1</span>]);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 丢弃后续脏数据</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果是 0xAA，继续循环处理下一包</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否以 0xAA 结尾且不完整（半包）</span></span><br><span class="line">    <span class="keyword">if</span> (temp_pos &gt; <span class="number">0</span> &amp;&amp; temp_buffer[temp_pos - <span class="number">1</span>] == <span class="number">0xAA</span> &amp;&amp; validate_format(temp_buffer, temp_pos) != <span class="number">2</span>) &#123;</span><br><span class="line">        has_partial = <span class="number">1</span>; <span class="comment">// 标记为半包，等待下次拼接</span></span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;Partial packet detected, waiting for more data\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送数据</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">send_data</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">uint8_t</span> type, <span class="type">uint16_t</span> length, <span class="type">uint8_t</span> *data)</span> &#123;</span><br><span class="line">    <span class="type">uint8_t</span> send_buffer[<span class="number">7</span> + MAX_DATA_PER_PACKET];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送开始响应包</span></span><br><span class="line">    send_ACK(sockfd, <span class="number">0x01</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送类型引导包</span></span><br><span class="line">    send_buffer[<span class="number">0</span>] = <span class="number">0xAA</span>;</span><br><span class="line">    send_buffer[<span class="number">1</span>] = type;</span><br><span class="line">    send_buffer[<span class="number">2</span>] = <span class="number">0x00</span>;</span><br><span class="line">    send_buffer[<span class="number">3</span>] = <span class="number">0x00</span>;</span><br><span class="line">    <span class="type">uint16_t</span> crc = calculate_crc16(&amp;send_buffer[<span class="number">4</span>], <span class="number">0</span>); <span class="comment">// 长度为 0，数据为空</span></span><br><span class="line">    send_buffer[<span class="number">4</span>] = (crc &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">    send_buffer[<span class="number">5</span>] = crc &amp; <span class="number">0xFF</span>;</span><br><span class="line">    send_buffer[<span class="number">6</span>] = <span class="number">0xFF</span>;</span><br><span class="line">    <span class="type">int</span> sent = lwip_send(sockfd, send_buffer, <span class="number">7</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sent != <span class="number">7</span>) &#123;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;Send type guide failed: expected 7, sent %d\n&quot;</span>, sent);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    LOG(LOG_LVL_INFO, <span class="string">&quot;Sent type guide: 0x%02X\n&quot;</span>, type);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送数据包</span></span><br><span class="line">    <span class="type">uint16_t</span> remaining_length = length;</span><br><span class="line">    <span class="type">uint8_t</span> *data_ptr = data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (remaining_length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">uint16_t</span> chunk_length = (remaining_length &gt; MAX_DATA_PER_PACKET) ? MAX_DATA_PER_PACKET : remaining_length;</span><br><span class="line">        <span class="type">uint16_t</span> total_packet_length = <span class="number">7</span> + chunk_length;</span><br><span class="line"></span><br><span class="line">        send_buffer[<span class="number">0</span>] = <span class="number">0xAA</span>;</span><br><span class="line">        send_buffer[<span class="number">1</span>] = type;</span><br><span class="line">        send_buffer[<span class="number">2</span>] = (chunk_length &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        send_buffer[<span class="number">3</span>] = chunk_length &amp; <span class="number">0xFF</span>;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;send_buffer[<span class="number">4</span>], data_ptr, chunk_length);</span><br><span class="line">        crc = calculate_crc16(data_ptr, chunk_length);</span><br><span class="line">        send_buffer[<span class="number">4</span> + chunk_length] = (crc &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        send_buffer[<span class="number">5</span> + chunk_length] = crc &amp; <span class="number">0xFF</span>;</span><br><span class="line">        send_buffer[<span class="number">6</span> + chunk_length] = <span class="number">0xFF</span>;</span><br><span class="line"></span><br><span class="line">        sent = lwip_send(sockfd, send_buffer, total_packet_length, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (sent != total_packet_length) &#123;</span><br><span class="line">            LOG(LOG_LVL_ERROR, <span class="string">&quot;Send data failed: expected %d, sent %d\n&quot;</span>, total_packet_length, sent);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;Sent %d bytes (data length: %u)\n&quot;</span>, sent, chunk_length);</span><br><span class="line"></span><br><span class="line">        remaining_length -= chunk_length;</span><br><span class="line">        data_ptr += chunk_length;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主任务</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">socket_task_entry</span><span class="params">(<span class="type">void</span> *params)</span> &#123;</span><br><span class="line">    LN_UNUSED(params);</span><br><span class="line">    <span class="type">int</span> sockfd = <span class="number">-1</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_addr</span>;</span></span><br><span class="line">    <span class="type">int</span> timeout_ms = <span class="number">5000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!netdev_got_ip()) &#123;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;No IP, waiting for WiFi...\n&quot;</span>);</span><br><span class="line">            OS_MsDelay(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">tcpip_ip_info_t</span> ip_info;</span><br><span class="line">        netdev_get_ip_info(NETIF_IDX_STA, &amp;ip_info);</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;IP: %s, Mask: %s, Gateway: %s\n&quot;</span>,</span><br><span class="line">            ip4addr_ntoa(&amp;ip_info.ip), ip4addr_ntoa(&amp;ip_info.netmask), ip4addr_ntoa(&amp;ip_info.gw));</span><br><span class="line"></span><br><span class="line">        <span class="type">int8_t</span> rssi;</span><br><span class="line">        wifi_sta_get_rssi(&amp;rssi);</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;WiFi RSSI: %d dBm\n&quot;</span>, rssi);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (netdev_got_ip()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                sockfd = lwip_socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Socket creation failed: %d\n&quot;</span>, errno);</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Socket create ID=%d\n&quot;</span>, sockfd);</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> flags = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (lwip_ioctl(sockfd, FIONBIO, &amp;flags) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;socket ioctl error: %d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">memset</span>(&amp;server_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">                server_addr.sin_family = AF_INET;</span><br><span class="line">                server_addr.sin_port = lwip_htons(<span class="number">8080</span>);</span><br><span class="line">                server_addr.sin_addr.s_addr = inet_addr(<span class="string">&quot;192.168.106.181&quot;</span>);</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Connecting to 192.168.106.181:8080...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> connect_result = lwip_connect(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">                <span class="keyword">if</span> (connect_result &lt; <span class="number">0</span> &amp;&amp; errno != EINPROGRESS) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;lwip_connect failed: %d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                fd_set writefds, exceptfds;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">                tv.tv_sec = <span class="number">10</span>;</span><br><span class="line">                tv.tv_usec = <span class="number">0</span>;</span><br><span class="line">                FD_ZERO(&amp;writefds);</span><br><span class="line">                FD_ZERO(&amp;exceptfds);</span><br><span class="line">                FD_SET(sockfd, &amp;writefds);</span><br><span class="line">                FD_SET(sockfd, &amp;exceptfds);</span><br><span class="line">                <span class="type">int</span> select_result = lwip_select(sockfd + <span class="number">1</span>, <span class="literal">NULL</span>, &amp;writefds, &amp;exceptfds, &amp;tv);</span><br><span class="line">                <span class="keyword">if</span> (select_result &lt;= <span class="number">0</span> || FD_ISSET(sockfd, &amp;exceptfds)) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Connect timed out or failed: %d\n&quot;</span>, errno);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> so_error = <span class="number">0</span>;</span><br><span class="line">                <span class="type">socklen_t</span> len = <span class="keyword">sizeof</span>(so_error);</span><br><span class="line">                <span class="keyword">if</span> (lwip_getsockopt(sockfd, SOL_SOCKET, SO_ERROR, &amp;so_error, &amp;len) &lt; <span class="number">0</span> || so_error != <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Connect failed with error: %d\n&quot;</span>, so_error);</span><br><span class="line">                    lwip_close(sockfd);</span><br><span class="line">                    sockfd = <span class="number">-1</span>;</span><br><span class="line">                    OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Connected to 192.168.106.181:8080\n&quot;</span>);</span><br><span class="line">                tv.tv_sec = timeout_ms / <span class="number">1000</span>;</span><br><span class="line">                tv.tv_usec = (timeout_ms % <span class="number">1000</span>) * <span class="number">1000</span>;</span><br><span class="line">                <span class="keyword">if</span> (lwip_setsockopt(sockfd, SOL_SOCKET, SO_RCVTIMEO, &amp;tv, <span class="keyword">sizeof</span>(tv)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;setsockopt SO_RCVTIMEO failed: %d\n&quot;</span>, errno);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (sockfd &gt;= <span class="number">0</span> &amp;&amp; netdev_got_ip()) &#123;</span><br><span class="line">                <span class="type">uint8_t</span> response[<span class="number">3</span>];</span><br><span class="line">                <span class="type">int</span> len;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">                    <span class="keyword">case</span> STATE_IDLE: <span class="comment">// 等待开始信号</span></span><br><span class="line">                        len = lwip_recv(sockfd, response, <span class="number">3</span>, <span class="number">0</span>);</span><br><span class="line">                        <span class="keyword">if</span> (len == <span class="number">3</span> &amp;&amp; response[<span class="number">0</span>] == <span class="number">0xAA</span> &amp;&amp; response[<span class="number">1</span>] == <span class="number">0x01</span> &amp;&amp; response[<span class="number">2</span>] == <span class="number">0xFF</span>) &#123;</span><br><span class="line">                            LOG(LOG_LVL_INFO, <span class="string">&quot;Received start signal\n&quot;</span>);</span><br><span class="line">                            send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">                            state = STATE_TYPE;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> STATE_TYPE: <span class="comment">// 等待类型包</span></span><br><span class="line">                        receive_data(sockfd, text_buffer, &amp;write_pos, &amp;read_pos);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> STATE_PRINT: <span class="comment">// 打印业务</span></span><br><span class="line">                        <span class="keyword">if</span> (!is_get_sum_size) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (receive_sum_size(sockfd, &amp;data_sum_size) == <span class="number">1</span>) &#123;</span><br><span class="line">                                is_get_sum_size = <span class="number">1</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="type">int</span> result = receive_data(sockfd, text_buffer, &amp;write_pos, &amp;read_pos);</span><br><span class="line">                            <span class="keyword">if</span> (result == <span class="number">-1</span>) &#123; <span class="comment">// -1 recv 返回 0</span></span><br><span class="line">                                lwip_close(sockfd);</span><br><span class="line">                                sockfd = <span class="number">-1</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (result == <span class="number">0</span>) &#123; <span class="comment">// </span></span><br><span class="line">                                len = lwip_recv(sockfd, response, <span class="number">3</span>, <span class="number">0</span>);</span><br><span class="line">                                <span class="keyword">if</span> (len == <span class="number">3</span> &amp;&amp; response[<span class="number">0</span>] == <span class="number">0xAA</span> &amp;&amp; response[<span class="number">1</span>] == <span class="number">0x02</span> &amp;&amp; response[<span class="number">2</span>] == <span class="number">0xFF</span>) &#123;</span><br><span class="line">                                    LOG(LOG_LVL_INFO, <span class="string">&quot;Received end signal\n&quot;</span>);</span><br><span class="line">                                    send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">                                    state = STATE_IDLE;</span><br><span class="line">                                    is_get_sum_size = <span class="number">0</span>;</span><br><span class="line">                                    total_written = <span class="number">0</span>;</span><br><span class="line">                                    write_pos = <span class="number">0</span>;</span><br><span class="line">                                    read_pos = <span class="number">0</span>;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (total_written &gt;= data_sum_size) &#123;</span><br><span class="line">                                <span class="type">uint32_t</span> available_data = (write_pos &gt;= read_pos) </span><br><span class="line">                                    ? (write_pos - read_pos) </span><br><span class="line">                                    : (SUM_BUFFER_SIZE - read_pos + write_pos);</span><br><span class="line">                                <span class="keyword">if</span> (available_data &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                    send_data(sockfd, data_type, available_data, &amp;text_buffer[read_pos]);</span><br><span class="line">                                    read_pos = (read_pos + available_data) % SUM_BUFFER_SIZE;</span><br><span class="line">                                    LOG(LOG_LVL_INFO, <span class="string">&quot;Final send: Sent %u bytes, new read_pos=%u\n&quot;</span>, available_data, read_pos);</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="comment">// 等待结束信号</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> STATE_AUDIO:  <span class="comment">// 音频业务</span></span><br><span class="line">                        <span class="type">int</span> result = receive_data(sockfd, text_buffer, &amp;write_pos, &amp;read_pos);</span><br><span class="line">                        <span class="keyword">if</span> (result == <span class="number">-1</span>) &#123;</span><br><span class="line">                            lwip_close(sockfd);</span><br><span class="line">                            sockfd = <span class="number">-1</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (result == <span class="number">0</span>) &#123;</span><br><span class="line">                            len = lwip_recv(sockfd, response, <span class="number">3</span>, <span class="number">0</span>);</span><br><span class="line">                            <span class="keyword">if</span> (len == <span class="number">3</span> &amp;&amp; response[<span class="number">0</span>] == <span class="number">0xAA</span> &amp;&amp; response[<span class="number">1</span>] == <span class="number">0x02</span> &amp;&amp; response[<span class="number">2</span>] == <span class="number">0xFF</span>) &#123;</span><br><span class="line">                                LOG(LOG_LVL_INFO, <span class="string">&quot;Received end signal\n&quot;</span>);</span><br><span class="line">                                send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">                                <span class="type">uint32_t</span> available_data = (write_pos &gt;= read_pos) </span><br><span class="line">                                    ? (write_pos - read_pos) </span><br><span class="line">                                    : (SUM_BUFFER_SIZE - read_pos + write_pos);</span><br><span class="line">                                <span class="keyword">if</span> (available_data &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                    send_data(sockfd, data_type, available_data, &amp;text_buffer[read_pos]);</span><br><span class="line">                                    read_pos = (read_pos + available_data) % SUM_BUFFER_SIZE;</span><br><span class="line">                                    LOG(LOG_LVL_INFO, <span class="string">&quot;Final send: Sent %u bytes, new read_pos=%u\n&quot;</span>, available_data, read_pos);</span><br><span class="line">                                &#125;</span><br><span class="line">                                state = STATE_IDLE;</span><br><span class="line">                                total_written = <span class="number">0</span>;</span><br><span class="line">                                write_pos = <span class="number">0</span>;</span><br><span class="line">                                read_pos = <span class="number">0</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="type">uint32_t</span> available_data = (write_pos &gt;= read_pos) </span><br><span class="line">                            ? (write_pos - read_pos) </span><br><span class="line">                            : (SUM_BUFFER_SIZE - read_pos + write_pos);</span><br><span class="line">                        <span class="keyword">if</span> (available_data &gt;= SUM_BUFFER_SIZE / <span class="number">2</span>) &#123;</span><br><span class="line">                            send_data(sockfd, data_type, available_data, &amp;text_buffer[read_pos]);</span><br><span class="line">                            read_pos = (read_pos + available_data) % SUM_BUFFER_SIZE;</span><br><span class="line">                            LOG(LOG_LVL_INFO, <span class="string">&quot;Sent %u bytes, new read_pos=%u\n&quot;</span>, available_data, read_pos);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                LOG(LOG_LVL_ERROR, <span class="string">&quot;Socket disconnect, retrying...\n&quot;</span>);</span><br><span class="line">                OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;WiFi disconnected, waiting...\n&quot;</span>);</span><br><span class="line">        OS_MsDelay(<span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>流程简单说明</strong></p>
<p><strong>状态机引入</strong></p>
<ul>
<li><strong>STATE_IDLE</strong>：等待 [0xAA][0x01][0xFF]，收到后切换到 STATE_TYPE。</li>
<li><strong>STATE_TYPE</strong>：接收类型引导包，设置 data_type 并切换到 STATE_PRINT 或 STATE_AUDIO。</li>
<li><strong>STATE_PRINT</strong>：接收总长度和打印数据。</li>
<li><strong>STATE_AUDIO</strong>：直接接收音频数据。</li>
</ul>
<p><strong>引导包处理</strong></p>
<ul>
<li>在 receive_data 中，检测长度为 0 的包：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (data_length == <span class="number">0</span> &amp;&amp; (data_type == <span class="number">0x11</span> || data_type == <span class="number">0x12</span>)) &#123;</span><br><span class="line">    state = (data_type == <span class="number">0x11</span>) ? STATE_PRINT : STATE_AUDIO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>打印模式</strong></p>
<ul>
<li>保留 receive_sum_size 获取总长度。</li>
<li>接收数据直到 total_written &gt;&#x3D; data_sum_size，然后发送剩余数据。</li>
<li>检测 [0xAA][0x02][0xFF] 结束。</li>
</ul>
<p><strong>音频模式</strong></p>
<ul>
<li>跳过总长度，直接接收数据。</li>
<li>当缓冲区超过一半（15000 字节）时发送数据。</li>
<li>检测 [0xAA][0x02][0xFF] 结束并发送剩余数据。</li>
</ul>
<p><strong>结束处理</strong></p>
<ul>
<li>两种模式下，收到 [0xAA][0x02][0xFF] 后重置状态和缓冲区。</li>
</ul>
<h2 id="实现四"><a href="#实现四" class="headerlink" title="实现四"></a>实现四</h2><p><strong>打印逻辑与音频逻辑</strong></p>
<p>音频业务<br>空放与欠载的问题(数据流控)<br>空放：音频缓冲区中的数据被播放设备消费得过快，而新的音频数据未能及时填充，导致播放设备没有足够的数据进行播放，进而可能会出现<strong>卡顿、静音或丢帧</strong>的现象。<br>欠载：音频缓冲区被填充的数据过多，超出了其存储容量，导致新写入的数据无法存储，可能会导致数据丢失或者覆盖已有的数据，影响音频质量。</p>
<p>任务间关系分析<br>Socket 任务：接收网络数据，写入 text_buffer，需要更新 write_pos 更改缓冲区内容。<br>audio 任务：读取 text_buffer，播放到喇叭，需要更新 read_pos 读取缓冲区内容。<br>共享资源：text_buffer(暂定 30K)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">audio_task</span><span class="params">(<span class="type">void</span> *param)</span> &#123;</span><br><span class="line">    pwm_init(<span class="number">40000</span>, <span class="number">0</span>, PWM_CHA_0, GPIO_B, GPIO_PIN_5);</span><br><span class="line">    pwm_init(<span class="number">40000</span>, <span class="number">0</span>, PWM_CHA_1, GPIO_B, GPIO_PIN_6);</span><br><span class="line">    pwm_start(PWM_CHA_0);</span><br><span class="line">    pwm_start(PWM_CHA_1);</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> speaker_on = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">int16_t</span> samples[<span class="number">192</span>]; <span class="comment">// ???? 192 ???,? receive_data ??</span></span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> samples_per_batch = <span class="number">192</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;Audio task sem, count=%lu\n&quot;</span>, uxSemaphoreGetCount(rx_data_ready_sem));</span><br><span class="line">        <span class="keyword">if</span> (xSemaphoreTake(rx_data_ready_sem, pdMS_TO_TICKS(<span class="number">10</span>)) == pdTRUE) &#123;</span><br><span class="line">            taskENTER_CRITICAL();</span><br><span class="line">            <span class="type">uint32_t</span> available = (rx_write_pos &gt;= rx_read_pos) ? </span><br><span class="line">                                 (rx_write_pos - rx_read_pos) : </span><br><span class="line">                                 (RING_BUFFER_SIZE - rx_read_pos + rx_write_pos);</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;Audio task: available=%u, write=%u, read=%u\n&quot;</span>, </span><br><span class="line">                available, rx_write_pos, rx_read_pos);</span><br><span class="line">            <span class="keyword">if</span> (available &gt;= samples_per_batch) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!speaker_on) &#123;</span><br><span class="line">                    pwm_start(PWM_CHA_0);</span><br><span class="line">                    pwm_start(PWM_CHA_1);</span><br><span class="line">                    speaker_on = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (read_circular_buffer(PCMBuffer_rx, (<span class="type">uint32_t</span> *)&amp;rx_read_pos, </span><br><span class="line">                                        (<span class="type">uint32_t</span> *)&amp;rx_write_pos, RING_BUFFER_SIZE, </span><br><span class="line">                                        samples, samples_per_batch, <span class="keyword">sizeof</span>(<span class="type">int16_t</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG(LOG_LVL_INFO, <span class="string">&quot;Audio task read %u samples, new read=%u\n&quot;</span>, </span><br><span class="line">                        samples_per_batch, rx_read_pos);</span><br><span class="line">                    taskEXIT_CRITICAL();</span><br><span class="line">                    <span class="comment">// // ??????</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; samples_per_batch; i++) &#123;</span><br><span class="line">                        <span class="type">uint16_t</span> pwm_value = (samples[i] + <span class="number">32768</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">                        <span class="type">float</span> duty = (pwm_value / <span class="number">4095.0f</span>) * <span class="number">100.0f</span>;</span><br><span class="line">                        pwm_set_duty(PWM_CHA_0, duty);</span><br><span class="line">                        vTaskDelay(pdMS_TO_TICKS(<span class="number">1000</span> / <span class="number">16000</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;Read from PCMBuffer_rx failed\n&quot;</span>);</span><br><span class="line">                    taskEXIT_CRITICAL();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                taskEXIT_CRITICAL();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;Audio task timeout, no data ready\n&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (speaker_on) &#123;</span><br><span class="line">                pwm_stop(PWM_CHA_0);</span><br><span class="line">                pwm_stop(PWM_CHA_1);</span><br><span class="line">                speaker_on = <span class="literal">false</span>;</span><br><span class="line">                LOG(LOG_LVL_INFO, <span class="string">&quot;Speaker turned off due to no data\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        vTaskDelay(pdMS_TO_TICKS(<span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="测试工具"><a href="#测试工具" class="headerlink" title="测试工具"></a>测试工具</h2><p>一个 python 编写的测试工具，只需要修改文件中的 IP 和端口号即可；</p>
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>鉴权：安全，mac地址，SN,app写入，flash</p>
<p>mac-&gt;sn，sn-&gt;mac，一个设备一个SN，socketid给我，登陆状态</p>
<p>UUIDD</p>
<p>响应0.2s</p>
<p>TTS LLM 语音合成，一边合成一边推送</p>
<p>打断功能；</p>
<p>同时，多个socket列表</p>
<p>播放数据的问题，怎么解决？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接收数据</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">receive_data</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">uint8_t</span> *text_buffer, <span class="type">uint32_t</span> *write_pos, <span class="type">uint32_t</span> *read_pos)</span> &#123;</span><br><span class="line">    <span class="comment">// 接收缓冲区</span></span><br><span class="line">    <span class="type">static</span> <span class="type">uint8_t</span> buffer[<span class="number">512</span>];</span><br><span class="line">    <span class="comment">// 接收的数据长度</span></span><br><span class="line">    <span class="comment">// 接收 sizeof(buffer) 长度的内容到 buffer 中</span></span><br><span class="line">    <span class="type">int</span> len = lwip_recv(sockfd, buffer, <span class="keyword">sizeof</span>(buffer), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123; <span class="comment">// 非阻塞模式下无数据会返回小于0的长度</span></span><br><span class="line">        <span class="keyword">if</span> (errno == EAGAIN || errno == ETIMEDOUT) &#123;</span><br><span class="line">            OS_MsDelay(<span class="number">100</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        LOG(LOG_LVL_ERROR, <span class="string">&quot;receive_data len &lt; 0: %d\n&quot;</span>, errno);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>) &#123; <span class="comment">// socket 关闭</span></span><br><span class="line">        LOG(LOG_LVL_INFO, <span class="string">&quot;Server closed connection\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; len) &#123;</span><br><span class="line">        <span class="keyword">if</span> (temp_pos &lt; TEMP_BUFFER_SIZE) &#123;</span><br><span class="line">            temp_buffer[temp_pos] = buffer[i];</span><br><span class="line">            temp_pos++;</span><br><span class="line">            LOG(LOG_LVL_INFO, <span class="string">&quot;uint8_t = %d\n&quot;</span>,buffer[i]);</span><br><span class="line">            <span class="type">int</span> validation_result = validate_format(temp_buffer, temp_pos);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (validation_result == <span class="number">-1</span>) &#123;</span><br><span class="line">                send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">                temp_pos = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (validation_result == <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="type">uint16_t</span> data_length = (temp_buffer[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | temp_buffer[<span class="number">3</span>];</span><br><span class="line">                data_type = temp_buffer[<span class="number">1</span>];</span><br><span class="line">                <span class="type">uint8_t</span> *data = &amp;temp_buffer[<span class="number">4</span>];</span><br><span class="line">                <span class="type">uint16_t</span> recv_crc = (temp_buffer[<span class="number">4</span> + data_length] &lt;&lt; <span class="number">8</span>) | temp_buffer[<span class="number">5</span> + data_length];</span><br><span class="line">                <span class="type">uint16_t</span> calculated_crc = calculate_crc16(data, data_length);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (calculated_crc != recv_crc) &#123;</span><br><span class="line">                    LOG(LOG_LVL_ERROR, <span class="string">&quot;CRC16 mismatch: received=0x%04X, calculated=0x%04X\n&quot;</span>, recv_crc, calculated_crc);</span><br><span class="line">                    send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (data_length == <span class="number">0</span> &amp;&amp; (data_type == <span class="number">0x11</span> || data_type == <span class="number">0x12</span>)) &#123;</span><br><span class="line">                        <span class="comment">// 引导包</span></span><br><span class="line">                        LOG(LOG_LVL_INFO, <span class="string">&quot;recv type : 0x%02X\n&quot;</span>, data_type);</span><br><span class="line">                        send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">                        <span class="comment">// 状态修改，打印业务还是音频业务</span></span><br><span class="line">                        state = (data_type == <span class="number">0x11</span>) ? STATE_PRINT : STATE_AUDIO;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (write_circular_buffer(text_buffer, write_pos, read_pos, data, data_length) != <span class="number">0</span>) &#123;</span><br><span class="line">                        LOG(LOG_LVL_ERROR, <span class="string">&quot;Write to buffer failed\n&quot;</span>);</span><br><span class="line">                        send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        total_written += data_length;</span><br><span class="line">                        send_ACK(sockfd, <span class="number">0xAA</span>);</span><br><span class="line">                        LOG(LOG_LVL_INFO, <span class="string">&quot;CRC match, total_written=%u\n&quot;</span>, total_written);</span><br><span class="line">                        <span class="comment">// return 2;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                temp_pos = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            send_ACK(sockfd, <span class="number">0xEE</span>);</span><br><span class="line">            temp_pos = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/about/">博主</a></li>
        
          <li><a href="/tags/">标签</a></li>
        
          <li><a href="/categories/">分类</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E4%BF%A1%E4%B8%AD-IP-%E5%92%8C%E7%AB%AF%E5%8F%A3%E7%9A%84%E9%9C%80%E6%B1%82"><span class="toc-number">1.</span> <span class="toc-text">通信中 IP 和端口的需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%BB%E5%A1%9E%E4%B8%8E%E9%9D%9E%E9%98%BB%E5%A1%9E"><span class="toc-number">2.</span> <span class="toc-text">阻塞与非阻塞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%80"><span class="toc-number">4.</span> <span class="toc-text">实现一</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%8C"><span class="toc-number">5.</span> <span class="toc-text">实现二</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%8C-%E6%94%B9"><span class="toc-number">6.</span> <span class="toc-text">实现二(改)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%89"><span class="toc-number">7.</span> <span class="toc-text">实现三</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%9B%9B"><span class="toc-number">8.</span> <span class="toc-text">实现四</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7"><span class="toc-number">9.</span> <span class="toc-text">测试工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87"><span class="toc-number">10.</span> <span class="toc-text">目标</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/&text=Socket"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/&title=Socket"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/&is_video=false&description=Socket"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Socket&body=Check out this article: https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/&title=Socket"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/&title=Socket"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/&title=Socket"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/&title=Socket"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/&name=Socket&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ARM/Cortex-M4/LN/LN882H/Socket/&t=Socket"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024-2025
    kay
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">博主</a></li><!--
     --><!--
       --><li><a href="/tags/">标签</a></li><!--
     --><!--
       --><li><a href="/categories/">分类</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
