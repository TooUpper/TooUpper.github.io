<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="BLE（Bluetooth Low Energy，蓝牙低功耗）是一种无线技术标准，旨在提供低功耗和低延迟的无线通信。它是蓝牙技术的一种变体，特别适用于对电池寿命和功耗有严格要求的应用。 BLE 的特点  低功耗：BLE 设备在待机状态下消耗极少的电量，适合长时间运行的设备。 短距离通信：典型的通信范围为 10 米至 100 米，具体取决于环境和设备。 快速连接：BLE 设备能够快速连接和断开，适合">
<meta property="og:type" content="article">
<meta property="og:title" content="BLE蓝牙">
<meta property="og:url" content="https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/index.html">
<meta property="og:site_name" content="流年不知心底事">
<meta property="og:description" content="BLE（Bluetooth Low Energy，蓝牙低功耗）是一种无线技术标准，旨在提供低功耗和低延迟的无线通信。它是蓝牙技术的一种变体，特别适用于对电池寿命和功耗有严格要求的应用。 BLE 的特点  低功耗：BLE 设备在待机状态下消耗极少的电量，适合长时间运行的设备。 短距离通信：典型的通信范围为 10 米至 100 米，具体取决于环境和设备。 快速连接：BLE 设备能够快速连接和断开，适合">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.tooupper.org/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ESP32/ESP32S3/GPAxieyijiagou.png">
<meta property="og:image" content="https://www.tooupper.org/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ESP32/ESP32S3/bleattxy.png">
<meta property="og:image" content="https://www.tooupper.org/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ESP32/ESP32S3/ADStructuregeshi.png">
<meta property="og:image" content="https://www.tooupper.org/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ESP32/ESP32S3/blegblx.png">
<meta property="og:image" content="https://www.tooupper.org/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ESP32/ESP32S3/bletxxd.png">
<meta property="og:image" content="https://www.tooupper.org/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ESP32/ESP32S3/blelygbjg.png">
<meta property="og:image" content="c:\Users\kay\AppData\Roaming\Typora\typora-user-images\image-20250120211959363.png">
<meta property="og:image" content="c:\Users\kay\AppData\Roaming\Typora\typora-user-images\image-20250120213226853.png">
<meta property="article:published_time" content="2024-12-10T11:13:00.000Z">
<meta property="article:modified_time" content="2025-01-31T09:07:59.507Z">
<meta property="article:author" content="kay">
<meta property="article:tag" content="ESP32-S3">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.tooupper.org/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ESP32/ESP32S3/GPAxieyijiagou.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>BLE蓝牙</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">博主</a></li><!--
     --><!--
       --><li><a href="/tags/">标签</a></li><!--
     --><!--
       --><li><a href="/categories/">分类</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/C%E6%A8%A1%E5%9D%97/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/&text=BLE蓝牙"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/&title=BLE蓝牙"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/&is_video=false&description=BLE蓝牙"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=BLE蓝牙&body=Check out this article: https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/&title=BLE蓝牙"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/&title=BLE蓝牙"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/&title=BLE蓝牙"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/&title=BLE蓝牙"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/&name=BLE蓝牙&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/&t=BLE蓝牙"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%8F%E8%AE%AE%E6%A0%88"><span class="toc-number">1.</span> <span class="toc-text">协议栈</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GAP-%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.1.</span> <span class="toc-text">GAP 协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GATT%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.2.</span> <span class="toc-text">GATT协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ATT%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.3.</span> <span class="toc-text">ATT协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%F0%9F%99%83%F0%9F%99%83%F0%9F%99%83"><span class="toc-number">1.4.</span> <span class="toc-text">总结🙃🙃🙃</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%BF%E6%92%AD%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F"><span class="toc-number">2.</span> <span class="toc-text">广播数据包格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%93%9D%E7%89%99%E9%80%9A%E4%BF%A1%E4%B8%AD%E7%9A%84%E8%A7%92%E8%89%B2"><span class="toc-number">3.1.</span> <span class="toc-text">蓝牙通信中的角色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BLE%E9%80%9A%E4%BF%A1%E4%BF%A1%E9%81%93"><span class="toc-number">3.2.</span> <span class="toc-text">BLE通信信道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%BF%E6%92%AD%E9%97%B4%E9%9A%94%E5%92%8C%E5%B9%BF%E6%92%AD%E4%BA%8B%E4%BB%B6"><span class="toc-number">3.3.</span> <span class="toc-text">广播间隔和广播事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BLE%E8%BF%9E%E6%8E%A5%E5%90%8E"><span class="toc-number">3.4.</span> <span class="toc-text">BLE连接后</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">3.5.</span> <span class="toc-text">代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">4.</span> <span class="toc-text">问题</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        BLE蓝牙
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">kay</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-12-10T11:13:00.000Z" class="dt-published" itemprop="datePublished">2024-12-10</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/ESP32/">ESP32</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/ESP32-S3/" rel="tag">ESP32-S3</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>BLE（Bluetooth Low Energy，蓝牙低功耗）是一种无线技术标准，旨在提供低功耗和低延迟的无线通信。它是蓝牙技术的一种变体，特别适用于对电池寿命和功耗有严格要求的应用。</p>
<p><strong>BLE 的特点</strong></p>
<ul>
<li>低功耗：BLE 设备在待机状态下消耗极少的电量，适合长时间运行的设备。</li>
<li>短距离通信：典型的通信范围为 10 米至 100 米，具体取决于环境和设备。</li>
<li>快速连接：BLE 设备能够快速连接和断开，适合需要快速响应的应用。</li>
<li>多设备连接：支持多个设备同时连接，适合物联网（IoT）场景。</li>
</ul>
<h2 id="协议栈"><a href="#协议栈" class="headerlink" title="协议栈"></a>协议栈</h2><p>BLE 蓝牙协议栈是蓝牙设备之间通信的基础架构。它定义了数据的传输方式、设备的发现机制、连接过程以及应用层的服务交互。蓝牙协议栈通常分为多个层级，每个层次实现不同的功能，确保设备之间的可靠通信。以下是BLE协议栈的一个大致分层架构：</p>
<p><strong>物理层（Physical Layer, PHY）</strong></p>
<p>物理层是 BLE 协议栈的最低层，定义了如何通过无线电波传输数据。BLE 使用的频段为 2.4 GHz ISM（工业、科学和医学）频段，具体划分为 40 个通道（其中 3 个是用于广告数据的）。每个通道的带宽为1 MHz，传输速度最高为 1 Mbps。</p>
<ul>
<li>传输模式：基于频率跳跃的扩频技术（FHSS），避免干扰。</li>
<li>信号编码：采用GFSK（Gaussian Frequency Shift Keying）调制技术，支持较低的功耗。</li>
</ul>
<p><strong>链路层（Link Layer）</strong></p>
<p>链路层负责数据包的格式、信道管理、设备发现、连接建立和连接维持等任务。它处理 BLE 设备之间的基础通信，负责信号的发送、接收和处理低层数据。</p>
<ul>
<li>设备发现：BLE 设备会广播自己的存在，其他设备可以扫描这些广告包来发现目标设备。</li>
<li>连接管理：链路层还负责连接的建立、断开、连接参数的协商和维护。</li>
<li>分包与重传：链路层实现了数据包的分割和重传机制，确保数据的完整传输。</li>
</ul>
<p><strong>控制器层（Controller Layer）</strong></p>
<p>控制器层通常包括物理层和链路层，它负责所有与硬件直接交互的功能。在一些高端应用中，控制器层可能是单独的硬件模块，负责处理BLE 信号的传输和接收。控制器层和主机层通过 HCI（Host Controller Interface）进行通信。</p>
<p><strong>主机层（Host Layer）</strong>⭐</p>
<p>主机层位于协议栈的上方，负责处理高层应用和管理设备的连接、服务发现、数据传输等任务。主机层实现了以下几个关键协议：</p>
<ul>
<li><p>GAP（Generic Access Profile）：负责设备间的发现、连接管理以及角色定义。GAP 协议定义了设备如何通过广播进行自我公开、如何扫描并建立连接，以及如何处理设备的连接和断开。它是 BLE 协议栈中管理设备访问行为的关键协议，确保设备能够在蓝牙网络中进行有效的通信。</p>
</li>
<li><p>L2CAP（Logical Link Control and Adaptation Protocol）：提供数据分段、组装和传输的功能，允许多个应用层协议共享底层链路。</p>
</li>
<li><p>ATT（Attribute Protocol）：用于设备间的属性数据交换。ATT 定义了如何存取蓝牙设备的各种数据（例如，传感器数据），通过服务和特性进行访问。</p>
</li>
<li><p>GATT（Generic Attribute Profile）：基于 ATT 协议之上的高层协议，定义了 BLE 设备之间数据交互的标准化方式。GATT 使用“服务”和“特性”模型，设备通过特性（characteristic）交换数据。</p>
</li>
</ul>
<p><strong>应用层（Application Layer）</strong></p>
<p>应用层是 BLE 协议栈的最高层，负责根据特定的应用需求处理业务逻辑。开发者可以在这一层设计 BLE 通信的具体行为，如控制设备、传输数据或处理用户输入等。应用层主要通过 GATT 协议进行操作，可以定义特定的服务和特性。例如：</p>
<ul>
<li>心率监测器服务（Heart Rate Service）</li>
<li>电池服务（Battery Service）</li>
<li>自定义服务（例如，温度传感器）</li>
</ul>
<p>此外，应用层也可以使用以下协议进行更高级的功能：</p>
<ul>
<li>SM（Security Manager）：用于加密和认证设备间的通信，确保数据的安全性。</li>
<li>L2CAP：提供面向连接的传输服务。</li>
</ul>
<ol start="6">
<li>安全管理层（Security Manager, SM）</li>
</ol>
<p>安全管理层负责对设备进行配对、身份验证和加密。BLE 设备可以通过配对建立加密连接，以确保数据在传输过程中的机密性和完整性。常见的安全机制包括：</p>
<ul>
<li>身份验证：通过 PIN 码、键盘、显示器或其他方式进行身份认证。</li>
<li>加密：采用 AES 加密算法保证数据的安全。</li>
<li>隐私：BLE 设备支持地址隐私，以避免设备被追踪。</li>
</ul>
<p><strong>在蓝牙通信过程中，GAP（Generic Access Profile）和 GATT（Generic Attribute Profile）是两个核心协议。二者又分别依赖于 ATT（Attribute Protocol）和 L2CAP（Logical Link Control and Adaptation Protocol）协议。</strong></p>
<ul>
<li><strong>GAP</strong>：管理设备的广播、扫描、连接建立和断开，决定设备的通信角色（中心、外围、广播者、观察者）。它是所有蓝牙连接的基础。</li>
<li><strong>GATT</strong>：依赖 GAP 协议建立的连接，负责数据的标准化交互。它基于 ATT 协议，提供数据读取、写入等功能，使用“服务”和“特性”的模型进行数据传输。GATT 将 ATT 中 attribute 的内容分为服务、特征、值或描述。</li>
</ul>
<p><img src="/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ESP32/ESP32S3/GPAxieyijiagou.png" alt="GPAxieyijiagou"></p>
<blockquote>
<p><strong>这张图很好地展示了两者的关系：</strong></p>
<ol>
<li><strong>GAP</strong> 位于较高的逻辑层，主要处理设备发现、连接和访问角色管理。它依赖于下层协议（如L2CAP）来完成数据传输的支持。</li>
<li><strong>GATT</strong> 基于 ATT 协议，用于具体的数据交互。它在 GAP 建立的连接基础上工作，服务于应用数据的传输。</li>
</ol>
</blockquote>
<h3 id="GAP-协议"><a href="#GAP-协议" class="headerlink" title="GAP 协议"></a>GAP 协议</h3><p>GAP（Generic Access Profile）是蓝牙低功耗（BLE）协议栈的一部分，属于主机层（Host Layer）。它定义了<strong>设备如何发现彼此、如何连接、如何广播信息以及如何设置通信角色。</strong></p>
<p><strong>主要特点：</strong></p>
<p>GAP 协议定义了 BLE 设备的四种角色，角色的选择决定了设备在通信中的行为。</p>
<ul>
<li><p>设备角色：GAP定义了设备在BLE通信中的角色，包括：</p>
<ul>
<li><p>广播设备（Advertiser）：发送广播包以进行设备发现。</p>
</li>
<li><p>扫描设备（Scanner）：监听并响应广播包，发现其他设备。</p>
</li>
<li><p>主设备（Central）：发起连接的设备（通常是手机或主控制器）。</p>
</li>
<li><p>从设备（Peripheral）：被连接的设备（如传感器、穿戴设备）。</p>
</li>
</ul>
</li>
<li><p>设备发现：GAP定义了设备如何通过广播和扫描发现其他设备。设备可以处于可发现模式或不可发现模式。</p>
</li>
<li><p>连接管理：GAP负责建立、管理和终止连接。它处理连接间隔、超时和其他连接参数。</p>
</li>
</ul>
<p><strong>应用场景：</strong></p>
<p>GAP 广泛应用于各种 BLE 设备之间的发现和连接过程，确保设备能够有效地找到并连接到彼此。</p>
<h3 id="GATT协议"><a href="#GATT协议" class="headerlink" title="GATT协议"></a>GATT协议</h3><p>GATT（Generic Attribute Profile）位于蓝牙低功耗（BLE）协议栈中的主机层（Host Layer），位于ATT（Attribute Protocol）之上。<br>它定义了设备之间如何交换数据和互动的规则，并使用“服务”和“特性”这种方式来规范通信，让不同设备可以按照统一的标准进行数据传输和操作。</p>
<p>GATT 定义了一个框架，将 ATT 的属性结构组织起来，分为服务、特征、值或描述。</p>
<p><strong>主要特点：</strong></p>
<ul>
<li><p>服务和特性：GATT 基于服务和特性构建，服务是一组相关的特性。每个服务和特性都有唯一的UUID标识符。</p>
</li>
<li><p>数据模型：GATT 使用层次结构的数据模型，设备通过服务和特性与其他设备进行交互。</p>
</li>
<li><p>数据传输方式：GATT 支持读取、写入、通知和指示等操作：</p>
<ul>
<li><p>读取（Read）：客户端可以请求服务器读取特性值。</p>
</li>
<li><p>写入（Write）：客户端可以向服务器写入特性值。</p>
</li>
<li><p>通知（Notify）：服务器可以主动向客户端发送特性值的变化。</p>
</li>
<li><p>指示（Indicate）：服务器向客户端发送特性值的变化，并等待客户端的确认。</p>
</li>
</ul>
</li>
</ul>
<p><strong>应用场景：</strong></p>
<p>GATT通常用于传感器、健康设备、智能家居设备等场景，如心率监测器、温度传感器等。这些设备通过GATT服务和特性与其他BLE设备（如手机应用）进行数据交换。</p>
<h3 id="ATT协议"><a href="#ATT协议" class="headerlink" title="ATT协议"></a>ATT协议</h3><p><strong>ATT</strong>（<strong>Attribute Protocol</strong>）其实就是一种<strong>蓝牙设备间交换数据的规则</strong>。在蓝牙低能耗（BLE）设备之间通信时，数据通常是以“属性”（Attribute）的形式进行组织和交换的。ATT 协议就是管理这些数据的“规则本”，它规定了如何读取、写入或者修改这些属性。</p>
<p>ATT 协议中的<strong>属性</strong>就是数据的基本单位。每个属性都有一个“名字”（也就是<strong>UUID</strong>，可以理解为“标签”）和一些<strong>数据</strong>。</p>
<p><strong>属性的构成</strong></p>
<p><img src="/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ESP32/ESP32S3/bleattxy.png" alt="bleattxy"></p>
<ul>
<li><p><strong>属性句柄（Attribute Handle）</strong>：唯一标识属性的编号，用于访问属性。</p>
</li>
<li><p><strong>属性类型（Attribute Type）</strong>：标识属性的种类（如电池电量、心率等也就是我们说的 UUID）。</p>
</li>
<li><p><strong>属性值（Attribute Value）</strong>：存储实际的数据（如电池百分比、温度值等）。</p>
</li>
<li><p><strong>属性权限（Attribute Permissions）</strong>：定义对属性的访问权限（如可读、可写、通知等）。</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://www.corenchip.com/2280.html">UUID 查询表</a></p>
<h3 id="总结🙃🙃🙃"><a href="#总结🙃🙃🙃" class="headerlink" title="总结🙃🙃🙃"></a>总结🙃🙃🙃</h3><ul>
<li><strong>GAP</strong>：负责设备发现和连接管理，定义设备的角色和连接过程。</li>
<li><strong>GATT</strong>：负责设备之间的数据交换和数据组织，通过服务和特性来定义如何读取、写入和通知数据。</li>
<li><strong>ATT</strong>：负责在设备之间传输<strong>具体的数据单元（属性）</strong>，通过定义<strong>属性（Attribute）</strong>来组织和传输数据。每个属性都有一个唯一的标识符（UUID）和数据值。</li>
<li><strong>L2CAP</strong>：负责<strong>数据封装和分段</strong>，实现应用层和传输层之间的可靠数据传输。</li>
</ul>
<p>这两个协议相辅相成，构成了蓝牙低功耗通信的基础，使得不同设备能够高效地进行数据交换和管理。</p>
<h2 id="广播数据包格式"><a href="#广播数据包格式" class="headerlink" title="广播数据包格式"></a>广播数据包格式</h2><p>在 BLE 中，GAP 协议通过广播数据包的形式与其他设备进行交互。广播数据包的主要作用是：</p>
<ul>
<li><strong>设备发现</strong>：向周围设备提供设备的身份信息（如设备名称、UUID 等），使其他设备能够快速发现并识别蓝牙设备。</li>
<li><strong>服务信息传递</strong>：传输设备支持的服务类型和功能。</li>
<li><strong>连接准备</strong>：当其他设备响应广播并发起连接请求后，可建立 BLE 连接。</li>
</ul>
<p>广播数据包的有效负载（Payload）最大为 <strong>37 字节</strong>，前 6 个字节为 MAC 地址，后 <strong>31 字节</strong> 可供开发者使用。这 31 字节被分为一个或多个 <strong>AD Structure</strong>（广播数据结构），每个 AD Structure 包含以下部分：</p>
<ol>
<li><strong>长度字段（Length）</strong>：1 字节，表示该结构的总长度。</li>
<li><strong>类型字段（Type）</strong>：1 字节，定义数据的类型（如设备名称、服务 UUID、设备类别等）。</li>
<li><strong>值字段（Value）</strong>：可变长度，包含具体的数据内容。</li>
</ol>
<p>广播数据包不直接发起连接请求，而是通过提供设备信息，等待中心设备（Scanner）发起连接请求。一旦中心设备响应广播包并发起连接请求，双方可以建立 BLE 连接。</p>
<p>值得注意的是，设备地址（6 字节）用于标识设备，但不占用广播数据包的 31 字节有效负载空间。通过合理设计广播数据内容，可以实现快速设备发现和低功耗的连接准备。</p>
<p><img src="/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ESP32/ESP32S3/ADStructuregeshi.png" alt="ADStructuregeshi"></p>
<blockquote>
<p>每个AD Structure包含3部分内容，分别是：</p>
<ol>
<li>Length(1字节):        广播数据包的长度</li>
<li>AD Type(1字节)：   广播的类型</li>
<li>AD Data（n字节）: 数据</li>
</ol>
</blockquote>
<p><strong>常见的广播类型如下</strong></p>
<p><img src="/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ESP32/ESP32S3/blegblx.png" alt="blegblx"></p>
<p>假设我此时有如下一组广播数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设这是一组广播数据</span></span><br><span class="line"><span class="number">02</span> <span class="number">01</span> <span class="number">06</span> <span class="number">09</span> <span class="number">08</span> <span class="number">54</span> <span class="number">6F</span> <span class="number">6F</span> <span class="number">55</span> <span class="number">70</span> <span class="number">70</span> <span class="number">65</span> <span class="number">72</span> <span class="number">03</span> <span class="number">19</span> C1 <span class="number">03</span></span><br><span class="line"><span class="comment">// 我们将它按照 AD structure 拆分后为：</span></span><br><span class="line"><span class="number">02</span> <span class="number">01</span> <span class="number">06</span>	<span class="comment">// 02 表示数据长度，01 表示广播类型为设备标识 06是具体的标识内容   </span></span><br><span class="line"><span class="number">09</span> <span class="number">08</span> <span class="number">54</span> <span class="number">6F</span> <span class="number">6F</span> <span class="number">55</span> <span class="number">70</span> <span class="number">70</span> <span class="number">65</span> <span class="number">72</span> <span class="comment">// 同理 09 表示长度，08 表示广播类型，后面就是类型的具体数据</span></span><br><span class="line"><span class="number">03</span> <span class="number">19</span> C1 <span class="number">03</span> <span class="comment">// 03 表示长度，19 表示类型，后面表示具体的数据    </span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：</p>
<p>在设置广播的设备外观时候，要采用低位先行的方式，比如我们要设备外观为键盘，键盘对应的数据位 0x03C1，那么我们在广播数据中填写的值就要是 03 19 C1 03（这里要采用低位先行的策略）</p>
</blockquote>
<p>其他的设备外观数据我们可以在蓝牙官方的<a target="_blank" rel="noopener" href="https://www.bluetooth.com/wp-content/uploads/Files/Specification/HTML/Assigned_Numbers/out/en/Assigned_Numbers.pdf">已分配编号</a>表中进行查找</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="蓝牙通信中的角色"><a href="#蓝牙通信中的角色" class="headerlink" title="蓝牙通信中的角色"></a>蓝牙通信中的角色</h3><p>主机（客户端）：可以发起扫描并主动连接从机设备的角色（发起连接），比如手机；</p>
<p>从机（服务端）：发起广播，等待主设备的连接（也可以被别人连接），比如蓝牙灯、手环；</p>
<blockquote>
<p>同一个 BLE 设备既可以作为主机也可以作为从机</p>
</blockquote>
<h3 id="BLE通信信道"><a href="#BLE通信信道" class="headerlink" title="BLE通信信道"></a>BLE通信信道</h3><p>BLE 蓝牙使用使用 2.4GHz 频道，一共有 40 个信道，37、38、39是蓝牙广播信道，剩余 37 个是数据信道。</p>
<p><img src="/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ESP32/ESP32S3/bletxxd.png" alt="bletxxd"></p>
<h3 id="广播间隔和广播事件"><a href="#广播间隔和广播事件" class="headerlink" title="广播间隔和广播事件"></a>广播间隔和广播事件</h3><p><strong>广播间隔</strong>：从机每经过一个时间间隔发送一次广播数据，这个时间间隔称为广播间隔(20ms 到 10.24s)</p>
<p><strong>广播事件</strong>：一次广播的动作，每次广播事件会在37，38，39信道上依次广播</p>
<p><img src="/public/image/%E5%B5%8C%E5%85%A5%E5%BC%8F/MCU/ESP32/ESP32S3/blelygbjg.png" alt="blelygbjg"></p>
<h3 id="BLE连接后"><a href="#BLE连接后" class="headerlink" title="BLE连接后"></a>BLE连接后</h3><p>主机扫描到从机设备后，向从机设备发起连接请求；并且得到回应后双方才正式开始通信。此时有几个概念要注意下</p>
<p><strong>连接事件</strong>：在 BLE 连接中使用跳频方案，两个设备在特定时间、频道上彼此发送和接收数据。这些设备稍后在新的通道上通过约定的时间相遇，这次用于收发数据的相遇称为连接事件。</p>
<p><strong>连接间隔</strong>：两次连接事件之间的时间间隔称为连接间隔。1.25ms 为单位，范围从最小值 7.5ms 到最大值 4.0s.</p>
<p><strong>从机延迟</strong>：可以跳过的最大事件数。从设备（比如一个心率监测器）在连接事件中跳过的最大次数。如果从设备的任务没有及时完成，它可以选择跳过某些连接事件，以节省电池。这个延迟值通常是通过连接参数来配置的，最大值通常可以达到 500。</p>
<p><strong>监控超时</strong>：两次成功连接事件之间的最长时间。如果在此时间内没有成功的连接事件，设备将终止连接并返回到未连接状态。(100ms-32秒)。</p>
<p><strong>有效连接间隔</strong>：实际有效的交互通信间隔，有效连接间隔 &#x3D; 连接间隔 * (1+从机延迟)。</p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>ESP32 广播蓝牙，手机可以使用APP进行连接并且发送和接收数据，可以使用”BLE调试助手“进行测试。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ble.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _BLE_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _BLE_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;esp_err.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化并启动蓝牙BLE</span></span><br><span class="line"><span class="comment"> * @param 无</span></span><br><span class="line"><span class="comment"> * @return 是否成功</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">esp_err_t</span> <span class="title function_">ble_cfg_net_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置特征1的值</span></span><br><span class="line"><span class="comment"> * @param value 值</span></span><br><span class="line"><span class="comment"> * @return 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ble_set_ch1_value</span><span class="params">(<span class="type">uint16_t</span> value)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置特征2的值</span></span><br><span class="line"><span class="comment"> * @param value 值</span></span><br><span class="line"><span class="comment"> * @return 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ble_set_ch2_value</span><span class="params">(<span class="type">uint16_t</span> value)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">=============================================================</span><br><span class="line"><span class="comment">// ble.c    </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;freertos/FreeRTOS.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;freertos/task.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;freertos/event_groups.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;esp_system.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;esp_log.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;esp_bt.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;esp_gap_ble_api.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;esp_gatts_api.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;esp_bt_defs.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;esp_bt_main.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;esp_gatt_common_api.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;nvs_flash.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG <span class="string">&quot;BLE_CFG&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//设备名称</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLE_DEVICE_NAME <span class="string">&quot;ESP32-HOME&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ESP_APP_ID 0x55</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SVC_IND_ID1 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SVC_IND_ID2 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//蓝牙模块</span></span><br><span class="line"><span class="keyword">enum</span>&#123;</span><br><span class="line">    <span class="comment">//服务1</span></span><br><span class="line">    SV1_IDX_SVC,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//特征1</span></span><br><span class="line">    SV1_CH1_IDX_CHAR,</span><br><span class="line">    SV1_CH1_IDX_CHAR_VAL,</span><br><span class="line">    SV1_CH1_IDX_CHAR_CFG,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//特征2</span></span><br><span class="line">    SV1_CH2_IDX_CHAR,</span><br><span class="line">    SV1_CH2_IDX_CHAR_VAL,</span><br><span class="line">    SV1_CH2_IDX_CHAR_CFG,</span><br><span class="line"></span><br><span class="line">    SV1_IDX_NB,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span>&#123;</span></span><br><span class="line">    <span class="comment">//服务2</span></span><br><span class="line">    SV2_IDX_SVC,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//特征1</span></span><br><span class="line">    SV2_CH1_IDX_CHAR,</span><br><span class="line">    SV2_CH1_IDX_CHAR_VAL,</span><br><span class="line">    SV2_CH1_IDX_CHAR_CFG,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//特征2</span></span><br><span class="line">    SV2_CH2_IDX_CHAR,</span><br><span class="line">    SV2_CH2_IDX_CHAR_VAL,</span><br><span class="line">    SV2_CH2_IDX_CHAR_CFG,</span><br><span class="line"></span><br><span class="line">    SV2_IDX_NB,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_SERVICE_UUID_TEST       = <span class="number">0x18FF</span>;   <span class="comment">//自定义服务1</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_CH1           = <span class="number">0x2AFE</span>;   <span class="comment">//特征1 UUID</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR_UUID_CH2           = <span class="number">0x2AFF</span>;   <span class="comment">//特征2 UUID</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_SERVICE2_UUID_TEST       = <span class="number">0x18F3</span>;   <span class="comment">//自定义服务2</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR2_UUID_CH1           = <span class="number">0x2AF1</span>;   <span class="comment">//特征1 UUID</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> GATTS_CHAR2_UUID_CH2           = <span class="number">0x2AF2</span>;   <span class="comment">//特征2 UUID</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//主要服务声明UUID 0x2800</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> primary_service_uuid         = ESP_GATT_UUID_PRI_SERVICE;</span><br><span class="line"></span><br><span class="line"><span class="comment">//次要服务声明UUID 0x2801</span></span><br><span class="line"><span class="comment">//static const uint16_t second_service_uuid          = ESP_GATT_UUID_SEC_SERVICE;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//特征声明UUID 0x2803</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> character_declaration_uuid   = ESP_GATT_UUID_CHAR_DECLARE;</span><br><span class="line"></span><br><span class="line"><span class="comment">//特征描述UUID 0x2902</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> character_client_config_uuid = ESP_GATT_UUID_CHAR_CLIENT_CONFIG;</span><br><span class="line"><span class="comment">//读权限</span></span><br><span class="line"><span class="comment">//static const uint8_t char_prop_read                =  ESP_GATT_CHAR_PROP_BIT_READ;</span></span><br><span class="line"><span class="comment">//写权限</span></span><br><span class="line"><span class="comment">//static const uint8_t char_prop_write               = ESP_GATT_CHAR_PROP_BIT_WRITE;</span></span><br><span class="line"><span class="comment">//读写、通知权限</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint8_t</span> char_prop_read_write_notify   = ESP_GATT_CHAR_PROP_BIT_WRITE | ESP_GATT_CHAR_PROP_BIT_READ | ESP_GATT_CHAR_PROP_BIT_NOTIFY;</span><br><span class="line"><span class="comment">//读、通知权限</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint8_t</span> char_prop_read_notify = ESP_GATT_CHAR_PROP_BIT_READ | ESP_GATT_CHAR_PROP_BIT_NOTIFY;</span><br><span class="line"><span class="comment">//特征1客户端特征配置</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> sv1_ch1_client_cfg[<span class="number">2</span>] = &#123;<span class="number">0x00</span>, <span class="number">0x00</span>&#125;;</span><br><span class="line"><span class="comment">//特征2客户端特征配置</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> sv1_ch2_client_cfg[<span class="number">2</span>]  = &#123;<span class="number">0x00</span>,<span class="number">0x00</span>&#125;;</span><br><span class="line"><span class="comment">//特征1客户端特征配置</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> sv2_ch1_client_cfg[<span class="number">2</span>] = &#123;<span class="number">0x00</span>, <span class="number">0x00</span>&#125;;</span><br><span class="line"><span class="comment">//特征2客户端特征配置</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> sv2_ch2_client_cfg[<span class="number">2</span>]  = &#123;<span class="number">0x00</span>,<span class="number">0x00</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//gatt的访问接口，一个Profile（APP）对应1个</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> gl_gatts_if = ESP_GATT_IF_NONE;</span><br><span class="line"><span class="comment">//连接ID，连接成功后</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> gl_conn_id = <span class="number">0xFFFF</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//char1的值</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> sv1_char1_value[<span class="number">2</span>] = &#123;<span class="number">0x00</span>,<span class="number">0x16</span>&#125;;</span><br><span class="line"><span class="comment">//char2的值</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> sv1_char2_value[<span class="number">2</span>] = &#123;<span class="number">0x00</span>,<span class="number">0x25</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//char1的值</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> sv2_char1_value[<span class="number">2</span>] = &#123;<span class="number">0x00</span>,<span class="number">0xAA</span>&#125;;</span><br><span class="line"><span class="comment">//char2的值</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> sv2_char2_value[<span class="number">2</span>] = &#123;<span class="number">0x00</span>,<span class="number">0xEE</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//att的handle表</span></span><br><span class="line"><span class="type">uint16_t</span> sv1_handle_table[SV1_IDX_NB];</span><br><span class="line"></span><br><span class="line"><span class="comment">//att的handle表</span></span><br><span class="line"><span class="type">uint16_t</span> sv2_handle_table[SV2_IDX_NB];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该标志位用于跟踪广播配置状态，</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> adv_config_done       = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ADV_CONFIG_FLAG 设置广播名称成功标志位</span></span><br><span class="line"><span class="comment">// SCAN_RSP_CONFIG_FLAG 设置扫描回复数据成功标志位</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADV_CONFIG_FLAG             (1 &lt;&lt; 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCAN_RSP_CONFIG_FLAG        (1 &lt;&lt; 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//广播参数</span></span><br><span class="line"><span class="type">static</span> <span class="type">esp_ble_adv_params_t</span> adv_params = &#123;</span><br><span class="line">    .adv_int_min       = <span class="number">0x20</span>,                <span class="comment">//最小广播间隔，单位:0.625ms</span></span><br><span class="line">    .adv_int_max       = <span class="number">0x40</span>,                <span class="comment">//最大广播间隔，单位:0.625ms</span></span><br><span class="line">    .adv_type          = ADV_TYPE_IND,        <span class="comment">//广播类型(可连接的非定向广播)</span></span><br><span class="line">    .own_addr_type     = BLE_ADDR_TYPE_PUBLIC,<span class="comment">//使用固定地址广播</span></span><br><span class="line">    .channel_map       = ADV_CHNL_ALL,        <span class="comment">//在37、38、39信道进行广播</span></span><br><span class="line">    .adv_filter_policy = ADV_FILTER_ALLOW_SCAN_ANY_CON_ANY,   <span class="comment">//广播过滤策略（接收任何scan和任何连接）</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//gatt描述表</span></span><br><span class="line"><span class="comment">// 在ESP32中一张表只能对应一个服务，可以有多个特征</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">esp_gatts_attr_db_t</span> gatt1_db[SV1_IDX_NB] =</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//服务声明</span></span><br><span class="line">    <span class="comment">// ESP_GATT_AUTO_RSP：表示对这个属性的响应由 ESP32 自动处理，不需要应用层干预。</span></span><br><span class="line">    <span class="comment">// 权限（ESP_GATT_PERM_READ）：表示该服务的声明可以被读取。</span></span><br><span class="line">    <span class="comment">// ESP_UUID_LEN_16 UUID 长度</span></span><br><span class="line">    <span class="comment">// (uint8_t *)&amp;primary_service_uuid:将服务标识为主要服务的 UUID (0x2800)</span></span><br><span class="line">    <span class="comment">// 大小：第一个 sizeof(uint16_t) 表示 UUID 的最大程度</span></span><br><span class="line">    <span class="comment">// 第二个 sizeof(GATTS_SERVICE_UUID_TEST) 表示服务 UUID 的实际大小。</span></span><br><span class="line">    <span class="comment">// GATTS_SERVICE_UUID_TEST 是服务的实际 UUID。</span></span><br><span class="line">    [SV1_IDX_SVC]        =</span><br><span class="line">    &#123;&#123;ESP_GATT_AUTO_RSP&#125;, &#123;ESP_UUID_LEN_16, (<span class="type">uint8_t</span> *)&amp;primary_service_uuid, ESP_GATT_PERM_READ,</span><br><span class="line">      <span class="keyword">sizeof</span>(<span class="type">uint16_t</span>), <span class="keyword">sizeof</span>(GATTS_SERVICE_UUID_TEST), (<span class="type">uint8_t</span> *)&amp;GATTS_SERVICE_UUID_TEST&#125;&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//特征1</span></span><br><span class="line">    <span class="comment">//特征声明</span></span><br><span class="line">    <span class="comment">// ESP_GATT_PERM_READ 这是特征声明的权限，表示特征声明本身是只读的。</span></span><br><span class="line">    <span class="comment">// char_prop_read_write_notify 定义了该特征的属性（即允许读、写、通知）。</span></span><br><span class="line">    <span class="comment">// 这是特征的属性（Properties），表示特征值支持的操作类型（读、写、通知等）。</span></span><br><span class="line">    [SV1_CH1_IDX_CHAR]     =</span><br><span class="line">    &#123;&#123;ESP_GATT_AUTO_RSP&#125;, &#123;ESP_UUID_LEN_16, (<span class="type">uint8_t</span> *)&amp;character_declaration_uuid, ESP_GATT_PERM_READ,</span><br><span class="line">      <span class="keyword">sizeof</span>(<span class="type">uint8_t</span>), <span class="keyword">sizeof</span>(<span class="type">uint8_t</span>), (<span class="type">uint8_t</span> *)&amp;char_prop_read_write_notify&#125;&#125;,   <span class="comment">//特征值1允许读写和通知</span></span><br><span class="line">    <span class="comment">//特征值</span></span><br><span class="line">    <span class="comment">// ESP_GATT_RSP_BY_APP 对写/读操作的响应应由应用程序处理。</span></span><br><span class="line">    <span class="comment">// 也就是我们需要自己写函数进行调用回复</span></span><br><span class="line">    <span class="comment">// GATTS_CHAR_UUID_CH1 自定义特征1的UUID</span></span><br><span class="line">    <span class="comment">// 该特征值可以被读取和写入。</span></span><br><span class="line">    <span class="comment">// 大小：sizeof(sv1_char1_value) 表示该特征值的长度</span></span><br><span class="line">    <span class="comment">// 数据内容存储在 sv1_char1_value 变量中。</span></span><br><span class="line">    [SV1_CH1_IDX_CHAR_VAL] =</span><br><span class="line">    &#123;&#123;ESP_GATT_RSP_BY_APP&#125;, &#123;ESP_UUID_LEN_16, (<span class="type">uint8_t</span> *)&amp;GATTS_CHAR_UUID_CH1, ESP_GATT_PERM_READ | ESP_GATT_PERM_WRITE, </span><br><span class="line">      <span class="keyword">sizeof</span>(sv1_char1_value), <span class="keyword">sizeof</span>(sv1_char1_value), (<span class="type">uint8_t</span> *)sv1_char1_value&#125;&#125;,</span><br><span class="line">    <span class="comment">//特征描述-&gt;客户端特征配置</span></span><br><span class="line">    <span class="comment">// 数据内容存储在 sv1_ch1_client_cfg 变量中。</span></span><br><span class="line">    [SV1_CH1_IDX_CHAR_CFG]  =</span><br><span class="line">    &#123;&#123;ESP_GATT_AUTO_RSP&#125;, &#123;ESP_UUID_LEN_16, (<span class="type">uint8_t</span> *)&amp;character_client_config_uuid, ESP_GATT_PERM_READ|ESP_GATT_PERM_WRITE,</span><br><span class="line">      <span class="keyword">sizeof</span>(<span class="type">uint16_t</span>), <span class="keyword">sizeof</span>(sv1_ch1_client_cfg), (<span class="type">uint8_t</span> *)sv1_ch1_client_cfg&#125;&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//特征2</span></span><br><span class="line">    <span class="comment">//特征声明</span></span><br><span class="line">    [SV1_CH2_IDX_CHAR]      =</span><br><span class="line">    &#123;&#123;ESP_GATT_AUTO_RSP&#125;, &#123;ESP_UUID_LEN_16, (<span class="type">uint8_t</span> *)&amp;character_declaration_uuid, ESP_GATT_PERM_READ,</span><br><span class="line">      <span class="keyword">sizeof</span>(<span class="type">uint8_t</span>), <span class="keyword">sizeof</span>(<span class="type">uint8_t</span>), (<span class="type">uint8_t</span> *)&amp;char_prop_read_notify&#125;&#125;,  <span class="comment">//特征值2只允许读和通知</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//特征值</span></span><br><span class="line">    [SV1_CH2_IDX_CHAR_VAL]  =</span><br><span class="line">    &#123;&#123;ESP_GATT_RSP_BY_APP&#125;, &#123;ESP_UUID_LEN_16, (<span class="type">uint8_t</span> *)&amp;GATTS_CHAR_UUID_CH2, ESP_GATT_PERM_READ,</span><br><span class="line">      <span class="keyword">sizeof</span>(sv1_char2_value), <span class="keyword">sizeof</span>(sv1_char2_value), (<span class="type">uint8_t</span> *)sv1_char2_value&#125;&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//特征描述-&gt;客户端特征配置</span></span><br><span class="line">    [SV1_CH2_IDX_CHAR_CFG]      =</span><br><span class="line">    &#123;&#123;ESP_GATT_AUTO_RSP&#125;, &#123;ESP_UUID_LEN_16, (<span class="type">uint8_t</span> *)&amp;character_client_config_uuid, ESP_GATT_PERM_READ|ESP_GATT_PERM_WRITE,</span><br><span class="line">      <span class="keyword">sizeof</span>(<span class="type">uint16_t</span>), <span class="keyword">sizeof</span>(sv1_ch2_client_cfg), (<span class="type">uint8_t</span> *)&amp;sv1_ch2_client_cfg&#125;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//gatt描述表</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">esp_gatts_attr_db_t</span> gatt2_db[SV1_IDX_NB] = </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//服务2声明</span></span><br><span class="line">    [SV2_IDX_SVC]        =</span><br><span class="line">    &#123;&#123;ESP_GATT_AUTO_RSP&#125;, &#123;ESP_UUID_LEN_16, (<span class="type">uint8_t</span> *)&amp;primary_service_uuid, ESP_GATT_PERM_READ,</span><br><span class="line">      <span class="keyword">sizeof</span>(<span class="type">uint16_t</span>), <span class="keyword">sizeof</span>(GATTS_SERVICE2_UUID_TEST), (<span class="type">uint8_t</span> *)&amp;GATTS_SERVICE2_UUID_TEST&#125;&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//特征1</span></span><br><span class="line">    <span class="comment">//特征声明</span></span><br><span class="line">    [SV2_CH1_IDX_CHAR]     =</span><br><span class="line">    &#123;&#123;ESP_GATT_AUTO_RSP&#125;, &#123;ESP_UUID_LEN_16, (<span class="type">uint8_t</span> *)&amp;character_declaration_uuid, ESP_GATT_PERM_READ,</span><br><span class="line">      <span class="keyword">sizeof</span>(<span class="type">uint8_t</span>), <span class="keyword">sizeof</span>(<span class="type">uint8_t</span>), (<span class="type">uint8_t</span> *)&amp;char_prop_read_notify&#125;&#125;,</span><br><span class="line">    <span class="comment">//特征值</span></span><br><span class="line">    [SV2_CH1_IDX_CHAR_VAL] =</span><br><span class="line">    &#123;&#123;ESP_GATT_RSP_BY_APP&#125;, &#123;ESP_UUID_LEN_16, (<span class="type">uint8_t</span> *)&amp;GATTS_CHAR2_UUID_CH1, ESP_GATT_PERM_READ, </span><br><span class="line">      <span class="keyword">sizeof</span>(sv2_char1_value), <span class="keyword">sizeof</span>(sv2_char1_value), (<span class="type">uint8_t</span> *)sv2_char1_value&#125;&#125;,</span><br><span class="line">    <span class="comment">//特征描述-&gt;客户端特征配置</span></span><br><span class="line">    [SV2_CH1_IDX_CHAR_CFG]  =</span><br><span class="line">    &#123;&#123;ESP_GATT_AUTO_RSP&#125;, &#123;ESP_UUID_LEN_16, (<span class="type">uint8_t</span> *)&amp;character_client_config_uuid, ESP_GATT_PERM_READ|ESP_GATT_PERM_WRITE,</span><br><span class="line">      <span class="keyword">sizeof</span>(<span class="type">uint16_t</span>), <span class="keyword">sizeof</span>(sv2_ch1_client_cfg), (<span class="type">uint8_t</span> *)sv2_ch1_client_cfg&#125;&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//特征2</span></span><br><span class="line">    <span class="comment">//特征声明</span></span><br><span class="line">    [SV2_CH2_IDX_CHAR]      =</span><br><span class="line">    &#123;&#123;ESP_GATT_AUTO_RSP&#125;, &#123;ESP_UUID_LEN_16, (<span class="type">uint8_t</span> *)&amp;character_declaration_uuid, ESP_GATT_PERM_READ,</span><br><span class="line">      <span class="keyword">sizeof</span>(<span class="type">uint8_t</span>), <span class="keyword">sizeof</span>(<span class="type">uint8_t</span>), (<span class="type">uint8_t</span> *)&amp;char_prop_read_write_notify&#125;&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//特征值</span></span><br><span class="line">    [SV2_CH2_IDX_CHAR_VAL]  =</span><br><span class="line">    &#123;&#123;ESP_GATT_RSP_BY_APP&#125;, &#123;ESP_UUID_LEN_16, (<span class="type">uint8_t</span> *)&amp;GATTS_CHAR2_UUID_CH2, ESP_GATT_PERM_READ | ESP_GATT_PERM_WRITE,</span><br><span class="line">      <span class="keyword">sizeof</span>(sv2_char2_value), <span class="keyword">sizeof</span>(sv2_char2_value), (<span class="type">uint8_t</span> *)sv2_char2_value&#125;&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//特征描述-&gt;客户端特征配置</span></span><br><span class="line">    [SV2_CH2_IDX_CHAR_CFG]      =</span><br><span class="line">    &#123;&#123;ESP_GATT_AUTO_RSP&#125;, &#123;ESP_UUID_LEN_16, (<span class="type">uint8_t</span> *)&amp;character_client_config_uuid, ESP_GATT_PERM_READ|ESP_GATT_PERM_WRITE,</span><br><span class="line">      <span class="keyword">sizeof</span>(<span class="type">uint16_t</span>), <span class="keyword">sizeof</span>(sv2_ch2_client_cfg), (<span class="type">uint8_t</span> *)&amp;sv2_ch2_client_cfg&#125;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该数组的目的是存储一个 128 位的 UUID，</span></span><br><span class="line"><span class="comment">// 但由于 BLE 广播数据通常使用 16 位或 32 位的 UUID 来节省空间，我们只在数组中包括了实际需要的部分。</span></span><br><span class="line"><span class="comment">// 它实际上包含了一个16位（2字节）服务 UUID 和其它一些与设备相关的数据。0x000018FF</span></span><br><span class="line"><span class="comment">// GATTS_SERVICE_UUID_TEST 是自定义的UUID</span></span><br><span class="line"><span class="comment">// GATTS_SERVICE_UUID_TEST&amp;0xff 获取 UUID 的低字节。</span></span><br><span class="line"><span class="comment">// (GATTS_SERVICE_UUID_TEST&gt;&gt;8)&amp;0xff 获取 UUID 的高字节。</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> adv_service_uuid16[] = &#123;</span><br><span class="line">    <span class="comment">/* LSB &lt;------------------------------&gt; MSB */</span></span><br><span class="line">    <span class="number">0xfb</span>, <span class="number">0x34</span>, <span class="number">0x9b</span>, <span class="number">0x5f</span>, <span class="number">0x80</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x80</span>, <span class="number">0x00</span>, <span class="number">0x10</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, </span><br><span class="line">    GATTS_SERVICE_UUID_TEST&amp;<span class="number">0xff</span>,(GATTS_SERVICE_UUID_TEST&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The length of adv data must be less than 31 bytes</span></span><br><span class="line"><span class="comment">//static uint8_t test_manufacturer[TEST_MANUFACTURER_DATA_LEN] =  &#123;0x12, 0x23, 0x45, 0x56&#125;;</span></span><br><span class="line"><span class="comment">//adv data广播数据</span></span><br><span class="line"><span class="type">static</span> <span class="type">esp_ble_adv_data_t</span> adv_data = &#123;</span><br><span class="line">    <span class="comment">// 如果设置为 true，设备会在接收到扫描请求后，回复包含更多信息的数据；</span></span><br><span class="line">    <span class="comment">// 如果设置为 false，则不返回扫描响应。</span></span><br><span class="line">    .set_scan_rsp = <span class="literal">false</span>, <span class="comment">//此广播数据是否启用扫描响应，</span></span><br><span class="line">    <span class="comment">// 如果设置为 true，设备广播时会包含其设备名称，这样其他设备可以看到设备的名字；</span></span><br><span class="line">    <span class="comment">// 如果设置为 false，则不包含设备名称。</span></span><br><span class="line">    .include_name = <span class="literal">true</span>, <span class="comment">//是否包含名字</span></span><br><span class="line">    <span class="comment">// 发射功率表示设备的信号强度，其他设备可以使用此信息来估算与该设备的距离。</span></span><br><span class="line">    <span class="comment">// 如果设置为 true，则会广播发射功率；如果设置为 false，则不广播。</span></span><br><span class="line">    .include_txpower = <span class="literal">false</span>, <span class="comment">//是否包含发射功率</span></span><br><span class="line">    <span class="comment">// 控制设备在连接时，设备之间交换数据的频率。</span></span><br><span class="line">    .min_interval = <span class="number">0x0006</span>, <span class="comment">//最小连接间隔 单位1.25ms</span></span><br><span class="line">    .max_interval = <span class="number">0x0010</span>, <span class="comment">//最大连接间隔 单位1.25ms</span></span><br><span class="line">    <span class="comment">// 设置设备的外观，这是一个标准化的值，设备可以根据此值告诉其他设备它是什么类型。</span></span><br><span class="line">    .appearance = <span class="number">0x00</span>,     <span class="comment">//apperance</span></span><br><span class="line">    .manufacturer_len = <span class="number">0</span>, <span class="comment">//厂商信息长度</span></span><br><span class="line">    .p_manufacturer_data =  <span class="literal">NULL</span>, <span class="comment">//厂商信息</span></span><br><span class="line">    <span class="comment">// 这个指针指向具体的服务数据内容。</span></span><br><span class="line">    .service_data_len = <span class="number">0</span>,      <span class="comment">//服务数据长度</span></span><br><span class="line">    .p_service_data = <span class="literal">NULL</span>,     <span class="comment">//服务数据</span></span><br><span class="line">    <span class="comment">// 服务 UUID（统一唯一标识符）用于标识 BLE 服务的类型。</span></span><br><span class="line">    .service_uuid_len = <span class="keyword">sizeof</span>(adv_service_uuid16),    <span class="comment">//服务UUID长度</span></span><br><span class="line">    .p_service_uuid = adv_service_uuid16,              <span class="comment">//服务UUID</span></span><br><span class="line">    .flag = (ESP_BLE_ADV_FLAG_GEN_DISC | ESP_BLE_ADV_FLAG_BREDR_NOT_SPT),<span class="comment">//普通发现模式|不支持EDR经典蓝牙</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//扫描回复数据，用于主机在主动扫描时，向设备发起扫描请求，设备需要回复的内容</span></span><br><span class="line"><span class="type">static</span> <span class="type">esp_ble_adv_data_t</span> scan_rsp_data = &#123;</span><br><span class="line">    <span class="comment">// true 表示开启扫描回复数据，设备将回复扫描请求的主机。</span></span><br><span class="line">    .set_scan_rsp = <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 是否在扫描回复数据中包含设备的名字。</span></span><br><span class="line">    .include_name = <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 是否在扫描回复数据中包含设备的发射功率。</span></span><br><span class="line">    .include_txpower = <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 设备的外观</span></span><br><span class="line">    .appearance = <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// 厂商数据的长度与内容</span></span><br><span class="line">    .manufacturer_len = <span class="number">0</span>, <span class="comment">//TEST_MANUFACTURER_DATA_LEN,</span></span><br><span class="line">    .p_manufacturer_data =  <span class="literal">NULL</span>, <span class="comment">//&amp;test_manufacturer[0],</span></span><br><span class="line">    <span class="comment">// 指定服务数据的长度与内容</span></span><br><span class="line">    .service_data_len = <span class="number">0</span>,</span><br><span class="line">    .p_service_data = <span class="literal">NULL</span>,</span><br><span class="line">    <span class="comment">// 指定服务 UUID 的长度与内容</span></span><br><span class="line">    .service_uuid_len = <span class="keyword">sizeof</span>(adv_service_uuid16),</span><br><span class="line">    .p_service_uuid = adv_service_uuid16,</span><br><span class="line">    <span class="comment">// 设置设备的广播标志。</span></span><br><span class="line">    <span class="comment">// ESP_BLE_ADV_FLAG_GEN_DISC：设备支持通用发现（General Discoverable Mode），可以被扫描到。</span></span><br><span class="line">    <span class="comment">// ESP_BLE_ADV_FLAG_BREDR_NOT_SPT：设备不支持经典蓝牙（BR/EDR），只支持 BLE。</span></span><br><span class="line">    .flag = (ESP_BLE_ADV_FLAG_GEN_DISC | ESP_BLE_ADV_FLAG_BREDR_NOT_SPT),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * gatt事件回调函数</span></span><br><span class="line"><span class="comment"> * @param event 事件ID</span></span><br><span class="line"><span class="comment"> * @param gatts_if gatt接口，一个profile对应一个</span></span><br><span class="line"><span class="comment"> * @param </span></span><br><span class="line"><span class="comment"> *		event: 事件类型，指示发生了什么操作，如注册、读取、写入等。</span></span><br><span class="line"><span class="comment"> *		gatts_if: 表示 GATT 服务器接口。用于在 GATT 服务器和应用程序之间进行交互。</span></span><br><span class="line"><span class="comment"> * 			他是与 profile 对应的我们这里只设置了一个 profile 所以 gatts_if 可以不用管。</span></span><br><span class="line"><span class="comment"> *		param: 事件参数，包含具体事件的信息。它是一个结构体，类型为 esp_ble_gatts_cb_param_t</span></span><br><span class="line"><span class="comment"> * @return 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">gatts_profile_event_handler</span><span class="params">(<span class="type">esp_gatts_cb_event_t</span> event, <span class="type">esp_gatt_if_t</span> gatts_if, <span class="type">esp_ble_gatts_cb_param_t</span> *param)</span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (event) &#123;</span><br><span class="line">        <span class="comment">// 当 GATT profile 注册成功时触发的事件，表示设备的 GATT 服务已成功启动。    </span></span><br><span class="line">        <span class="keyword">case</span> ESP_GATTS_REG_EVT:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//设置 BLE 广播时的设备名称</span></span><br><span class="line">            <span class="type">esp_err_t</span> set_dev_name_ret = esp_ble_gap_set_device_name(BLE_DEVICE_NAME);</span><br><span class="line">            <span class="keyword">if</span> (set_dev_name_ret)&#123;</span><br><span class="line">                ESP_LOGE(TAG, <span class="string">&quot;set device name failed, error code = %x&quot;</span>, set_dev_name_ret);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//设置广播数据，完成广播的初始化。</span></span><br><span class="line">            <span class="type">esp_err_t</span> ret = esp_ble_gap_config_adv_data(&amp;adv_data);</span><br><span class="line">            <span class="keyword">if</span> (ret)&#123;</span><br><span class="line">                ESP_LOGE(TAG, <span class="string">&quot;config adv data failed, error code = %x&quot;</span>, ret);</span><br><span class="line">            &#125;</span><br><span class="line">            adv_config_done |= ADV_CONFIG_FLAG;</span><br><span class="line">            <span class="comment">//设置扫描回复参数</span></span><br><span class="line">            <span class="comment">// 即在设备广播过程中，其他设备扫描到该设备时，设备可以返回给扫描者更多的详细信息。</span></span><br><span class="line">            <span class="comment">// 也可以理解为，主机扫描到设备后，设备需要回复给主机的内容。</span></span><br><span class="line">            ret = esp_ble_gap_config_adv_data(&amp;scan_rsp_data);</span><br><span class="line">            <span class="keyword">if</span> (ret)&#123;</span><br><span class="line">                ESP_LOGE(TAG, <span class="string">&quot;config scan response data failed, error code = %x&quot;</span>, ret);</span><br><span class="line">            &#125;</span><br><span class="line">            adv_config_done |= SCAN_RSP_CONFIG_FLAG;      </span><br><span class="line">            <span class="comment">// 注册两个服务的属性表（gatt1_db 和 gatt2_db）。（每个属性表包含符合与特征）</span></span><br><span class="line">            <span class="comment">// 每个属性表都与一个 svc_ind_id 关联，并根据 gatts_if 注册到 GATT 服务器中。</span></span><br><span class="line">            <span class="comment">// 注册attr表1 第一个服务</span></span><br><span class="line">            <span class="comment">// gatt1_db 这是一个指向服务属性数据库的指针，定义了服务的属性表，包括服务的特征和描述符等。</span></span><br><span class="line">            <span class="comment">// gatts_if GATT服务器的接口标识符。</span></span><br><span class="line">            <span class="comment">// SV1_IDX_NB 指定了要添加到服务数据库中的最大属性数量。每个服务、特征和描述符都是一个属性。</span></span><br><span class="line">            <span class="comment">// 它应该与 gatt1_db 中定义的属性数量相匹配。</span></span><br><span class="line">            <span class="comment">// SVC_IND_ID1 这是服务的实例ID。</span></span><br><span class="line">            <span class="comment">// 在一个GATT服务器中，可以有多个服务实例，每个实例都有一个唯一的实例ID。</span></span><br><span class="line">            <span class="type">esp_err_t</span> create_attr_ret = esp_ble_gatts_create_attr_tab(gatt1_db, gatts_if, SV1_IDX_NB, SVC_IND_ID1);</span><br><span class="line">            <span class="keyword">if</span> (create_attr_ret)&#123;</span><br><span class="line">                ESP_LOGE(TAG, <span class="string">&quot;create attr1 table failed, error code = %x&quot;</span>, create_attr_ret);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//注册attr表2 第二个服务</span></span><br><span class="line">            create_attr_ret = esp_ble_gatts_create_attr_tab(gatt2_db, gatts_if, SV2_IDX_NB, SVC_IND_ID2);</span><br><span class="line">            <span class="keyword">if</span> (create_attr_ret)&#123;</span><br><span class="line">                ESP_LOGE(TAG, <span class="string">&quot;create attr2 table failed, error code = %x&quot;</span>, create_attr_ret);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// param 事件参数，</span></span><br><span class="line">            <span class="comment">// param-&gt;reg.status：这是 ESP_GATTS_REG_EVT 事件中的字段，表示注册结果。</span></span><br><span class="line">            <span class="comment">// 保存到全局变量，因为发送数据的时候会用到这个接口</span></span><br><span class="line">            <span class="keyword">if</span>(param-&gt;reg.status == ESP_GATT_OK)&#123;</span><br><span class="line">                gl_gatts_if = gatts_if;</span><br><span class="line">                <span class="comment">//gl_conn_id = param-&gt;connect.conn_id;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">       	    <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 收到客户端请求读取某个特征的值时触发此事件。</span></span><br><span class="line">        <span class="keyword">case</span> ESP_GATTS_READ_EVT:</span><br><span class="line">        &#123;</span><br><span class="line">            ESP_LOGI(TAG, <span class="string">&quot;ESP_GATTS_READ_EVT&quot;</span>);</span><br><span class="line">            <span class="comment">// 定义一个响应结构体，也就是要返回的数据</span></span><br><span class="line">            <span class="type">esp_gatt_rsp_t</span> rsp;</span><br><span class="line">            <span class="comment">// 将响应结构体清零，确保没有残留数据。</span></span><br><span class="line">            <span class="built_in">memset</span>(&amp;rsp, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="type">esp_gatt_rsp_t</span>));</span><br><span class="line">            <span class="comment">// 设置响应结构体中的句柄，表示要返回的特征值的句柄。</span></span><br><span class="line">            rsp.attr_value.handle = param-&gt;read.handle;</span><br><span class="line">            <span class="comment">// 服务1中特征1的特征值句柄。</span></span><br><span class="line">            <span class="comment">// 在GATT协议中，每个特征值或描述符的句柄是全局唯一的，即使它们属于不同的服务。</span></span><br><span class="line">            <span class="comment">// 所以可以不用去判断属于哪一个服务；主机只在乎特征值，其他都是配置自动回复的</span></span><br><span class="line">            <span class="comment">// 所以我们只用判断是哪一个特征值就可以了</span></span><br><span class="line">            <span class="keyword">if</span>(sv1_handle_table[SV1_CH1_IDX_CHAR_VAL] == param-&gt;read.handle)&#123;</span><br><span class="line">                <span class="comment">// 将 sv1_char2_value 的数据复制到响应结构体中。</span></span><br><span class="line">                rsp.attr_value.len = <span class="keyword">sizeof</span>(sv1_char2_value);</span><br><span class="line">                <span class="built_in">memcpy</span>(rsp.attr_value.value,sv1_char2_value,<span class="keyword">sizeof</span>(sv1_char2_value));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 服务1中特征2的特征值句柄。</span></span><br><span class="line">            <span class="keyword">if</span>(sv1_handle_table[SV1_CH2_IDX_CHAR_VAL] == param-&gt;read.handle)&#123;</span><br><span class="line">                rsp.attr_value.len = <span class="keyword">sizeof</span>(sv2_char2_value);</span><br><span class="line">                <span class="built_in">memcpy</span>(rsp.attr_value.value,sv2_char2_value,<span class="keyword">sizeof</span>(sv2_char2_value));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将准备好的响应数据发送给客户端。</span></span><br><span class="line">            <span class="comment">// gatts_if：GATT服务器接口。</span></span><br><span class="line">            <span class="comment">// param-&gt;read.conn_id：连接的ID，表示是哪个客户端发起的请求。</span></span><br><span class="line">            <span class="comment">// param-&gt;read.trans_id：事务ID，用于标识本次读取请求。</span></span><br><span class="line">            <span class="comment">// ESP_GATT_OK：表示响应成功。</span></span><br><span class="line">            <span class="comment">// &amp;rsp：指向响应结构体的指针。</span></span><br><span class="line">            esp_ble_gatts_send_response(gatts_if, param-&gt;read.conn_id, param-&gt;read.trans_id,ESP_GATT_OK, &amp;rsp);</span><br><span class="line">       	    <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 当客户端发送写入请求时，BLE栈会触发该事件。</span></span><br><span class="line">        <span class="keyword">case</span> ESP_GATTS_WRITE_EVT:</span><br><span class="line">            <span class="comment">// is_prep：表示是否是准备写入（长写入）。</span></span><br><span class="line">            <span class="comment">// 如果是 true，设备首先会将这些数据保存下来，等主机确认了最后一包这个预写的数据发完后</span></span><br><span class="line">            <span class="comment">// 我们的设备才一次性的把这些数据更新到内存中去</span></span><br><span class="line">            <span class="keyword">if</span> (!param-&gt;write.is_prep)&#123;</span><br><span class="line">                <span class="comment">// the data length of gattc write  must be less than GATTS_DEMO_CHAR_VAL_LEN_MAX.</span></span><br><span class="line">                ESP_LOGI(TAG, <span class="string">&quot;GATT_WRITE_EVT, handle = %d, value len = %d, value :&quot;</span>, param-&gt;write.handle, param-&gt;write.len);</span><br><span class="line">                <span class="comment">// 打印写入请求的详细信息，包括句柄、数据长度和数据内容。</span></span><br><span class="line">                <span class="comment">// 以十六进制格式打印数据内容。</span></span><br><span class="line">                esp_log_buffer_hex(TAG, param-&gt;write.value, param-&gt;write.len);</span><br><span class="line">                <span class="comment">// 分别保存特征1客户端写入数据的第一个和第二个字节.</span></span><br><span class="line">                <span class="keyword">if</span>(param-&gt;write.handle == sv1_handle_table[SV1_CH1_IDX_CHAR_CFG])&#123; </span><br><span class="line">                    sv1_ch1_client_cfg[<span class="number">0</span>] = param-&gt;write.value[<span class="number">0</span>];</span><br><span class="line">                    sv1_ch1_client_cfg[<span class="number">1</span>] = param-&gt;write.value[<span class="number">1</span>];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 分别保存特征2客户端写入数据的第一个和第二个字节.</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(param-&gt;write.handle == sv1_handle_table[SV1_CH2_IDX_CHAR_CFG])&#123;</span><br><span class="line">                    sv1_ch2_client_cfg[<span class="number">0</span>] = param-&gt;write.value[<span class="number">0</span>];</span><br><span class="line">                    sv1_ch2_client_cfg[<span class="number">1</span>] = param-&gt;write.value[<span class="number">1</span>];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 分别保存特征1特征值写入数据的第一个和第二个字节.</span></span><br><span class="line">                <span class="comment">// 特征2只允许读和通知所以不考虑写入</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(param-&gt;write.handle == sv1_handle_table[SV1_CH1_IDX_CHAR_VAL])&#123;</span><br><span class="line">                    sv1_char2_value[<span class="number">0</span>] = param-&gt;write.value[<span class="number">0</span>];</span><br><span class="line">                    sv1_char2_value[<span class="number">1</span>] = param-&gt;write.value[<span class="number">1</span>];</span><br><span class="line">                &#125;</span><br><span class="line">				<span class="comment">// 如果客户端需要响应，则发送响应。</span></span><br><span class="line">                <span class="comment">// gatts_if：GATT服务器接口。</span></span><br><span class="line">				<span class="comment">//param-&gt;write.conn_id：连接的ID，表示是哪个客户端发起的请求。</span></span><br><span class="line">				<span class="comment">//param-&gt;write.trans_id：事务ID，用于标识本次写入请求。</span></span><br><span class="line">				<span class="comment">//ESP_GATT_OK：表示响应成功。</span></span><br><span class="line">				<span class="comment">//NULL：表示没有额外的响应数据。</span></span><br><span class="line">                <span class="keyword">if</span> (param-&gt;write.need_rsp)&#123;</span><br><span class="line">                    esp_ble_gatts_send_response(gatts_if, param-&gt;write.conn_id, param-&gt;write.trans_id, ESP_GATT_OK, <span class="literal">NULL</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">      	    <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ESP_GATTS_EXEC_WRITE_EVT:</span><br><span class="line">            <span class="comment">// the length of gattc prepare write data must be less than GATTS_DEMO_CHAR_VAL_LEN_MAX.</span></span><br><span class="line">            ESP_LOGI(TAG, <span class="string">&quot;ESP_GATTS_EXEC_WRITE_EVT&quot;</span>);</span><br><span class="line">            <span class="comment">//example_exec_write_event_env(&amp;prepare_write_env, param);</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ESP_GATTS_MTU_EVT:</span><br><span class="line">            ESP_LOGI(TAG, <span class="string">&quot;ESP_GATTS_MTU_EVT, MTU %d&quot;</span>, param-&gt;mtu.mtu);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ESP_GATTS_CONF_EVT:</span><br><span class="line">            ESP_LOGI(TAG, <span class="string">&quot;ESP_GATTS_CONF_EVT, status = %d, attr_handle %d&quot;</span>, param-&gt;conf.status, param-&gt;conf.handle);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ESP_GATTS_START_EVT:</span><br><span class="line">            ESP_LOGI(TAG, <span class="string">&quot;SERVICE_START_EVT, status %d, service_handle %d&quot;</span>, param-&gt;start.status, param-&gt;start.service_handle);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 当 BLE 设备与客户端（例如手机或其他 BLE 设备）建立连接后，会触发这个事件。    </span></span><br><span class="line">        <span class="keyword">case</span> ESP_GATTS_CONNECT_EVT:</span><br><span class="line">            <span class="comment">// 印连接事件的相关信息。</span></span><br><span class="line">            ESP_LOGI(TAG, <span class="string">&quot;ESP_GATTS_CONNECT_EVT, conn_id = %d&quot;</span>, param-&gt;connect.conn_id);</span><br><span class="line">            esp_log_buffer_hex(TAG, param-&gt;connect.remote_bda, <span class="number">6</span>);</span><br><span class="line">            <span class="comment">// 初始化连接参数结构体 esp_ble_conn_update_params_t</span></span><br><span class="line">            <span class="type">esp_ble_conn_update_params_t</span> conn_params = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="comment">// 将客户端的蓝牙地址复制到结构体中。</span></span><br><span class="line">            <span class="built_in">memcpy</span>(conn_params.bda, param-&gt;connect.remote_bda, <span class="keyword">sizeof</span>(<span class="type">esp_bd_addr_t</span>));</span><br><span class="line">            <span class="comment">// 设置连接参数</span></span><br><span class="line">            <span class="comment">// iOS 对 BLE 连接参数有严格的限制，开发者需要遵循 Apple 的官方文档，否则可能导致连接失败或不稳定。</span></span><br><span class="line">            <span class="comment">// 表示从机可以忽略多少个连接事件。这里设置为 0，表示从机不会忽略任何事件。</span></span><br><span class="line">            conn_params.latency = <span class="number">0</span>;    <span class="comment">//从机延迟</span></span><br><span class="line">            conn_params.max_int = <span class="number">0x20</span>; <span class="comment">// 最大连接间隔 = 0x20*1.25ms = 40ms</span></span><br><span class="line">            conn_params.min_int = <span class="number">0x10</span>; <span class="comment">// 最小连接间隔 = 0x10*1.25ms = 20ms</span></span><br><span class="line">            <span class="comment">// 如果在这个时间内没有通信，连接会被认为断开。</span></span><br><span class="line">            conn_params.timeout = <span class="number">400</span>;  <span class="comment">// 监控超时 = 400*10ms = 4000ms</span></span><br><span class="line">            <span class="comment">// 向客户端发送更新连接参数的请求。客户端可以选择接受或拒绝这些参数。</span></span><br><span class="line">            esp_ble_gap_update_conn_params(&amp;conn_params);</span><br><span class="line">            <span class="comment">// 将连接句柄保存到全局变量 gl_conn_id 中，以便后续使用</span></span><br><span class="line">            gl_conn_id = param-&gt;connect.conn_id;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ESP_GATTS_DISCONNECT_EVT:  <span class="comment">//收到断开连接事件</span></span><br><span class="line">            ESP_LOGI(TAG, <span class="string">&quot;ESP_GATTS_DISCONNECT_EVT, reason = 0x%x&quot;</span>, param-&gt;disconnect.reason);</span><br><span class="line">            <span class="comment">// 注意断开后要从新设置连接，并将连接id设为一个无效值</span></span><br><span class="line">            esp_ble_gap_start_advertising(&amp;adv_params);</span><br><span class="line">            gl_conn_id = <span class="number">0xFFFF</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 当 GATT 服务的属性表创建成功时触发  </span></span><br><span class="line">        <span class="keyword">case</span> ESP_GATTS_CREAT_ATTR_TAB_EVT: </span><br><span class="line">            <span class="comment">// 检查属性表是否创建成功。</span></span><br><span class="line">            <span class="keyword">if</span> (param-&gt;add_attr_tab.status != ESP_GATT_OK)&#123;</span><br><span class="line">                    ESP_LOGE(TAG, <span class="string">&quot;create attribute table failed, svc id = %d,error code=0x%x&quot;</span>,param-&gt;add_attr_tab.svc_inst_id, param-&gt;add_attr_tab.status);</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="comment">// 处理服务属性表1的结果。SVC_IND_ID1 服务实例 1 的 ID</span></span><br><span class="line">            <span class="keyword">if</span>(param-&gt;add_attr_tab.svc_inst_id == SVC_IND_ID1)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果 num_handle 不等于 SV1_IDX_NB，说明属性表创建异常，记录错误日志。</span></span><br><span class="line">                <span class="comment">// SV1_IDX_NB：服务实例 1 的属性表预期包含的属性数量。</span></span><br><span class="line">                <span class="keyword">if</span> (param-&gt;add_attr_tab.num_handle != SV1_IDX_NB)&#123;</span><br><span class="line">                    ESP_LOGE(TAG, <span class="string">&quot;create attribute table abnormally, num_handle (%d) \</span></span><br><span class="line"><span class="string">                            doesn&#x27;t equal to NETCFG_IDX_NB(%d)&quot;</span>, param-&gt;add_attr_tab.num_handle, SV1_IDX_NB);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    ESP_LOGI(TAG, <span class="string">&quot;create attribute table successfully, the number handle = %d\n&quot;</span>,param-&gt;add_attr_tab.num_handle);</span><br><span class="line">                    <span class="comment">// 将创建的属性句柄数组复制到 sv1_handle_table 中，以便后续使用。</span></span><br><span class="line">                    <span class="built_in">memcpy</span>(sv1_handle_table, param-&gt;add_attr_tab.handles, <span class="keyword">sizeof</span>(sv1_handle_table));</span><br><span class="line">                    <span class="comment">// 启动服务实例 1</span></span><br><span class="line">                    esp_ble_gatts_start_service(sv1_handle_table[SV1_IDX_SVC]);</span><br><span class="line">                &#125;         </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(param-&gt;add_attr_tab.svc_inst_id == SVC_IND_ID2)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (param-&gt;add_attr_tab.num_handle != SV2_IDX_NB)&#123;</span><br><span class="line">                    ESP_LOGE(TAG, <span class="string">&quot;create attribute table abnormally, num_handle (%d) \</span></span><br><span class="line"><span class="string">                            doesn&#x27;t equal to NETCFG_IDX_NB(%d)&quot;</span>, param-&gt;add_attr_tab.num_handle, SV2_IDX_NB);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    ESP_LOGI(TAG, <span class="string">&quot;create attribute table successfully, the number handle = %d\n&quot;</span>,param-&gt;add_attr_tab.num_handle);</span><br><span class="line">                    <span class="built_in">memcpy</span>(sv2_handle_table, param-&gt;add_attr_tab.handles, <span class="keyword">sizeof</span>(sv2_handle_table));</span><br><span class="line">                    esp_ble_gatts_start_service(sv2_handle_table[SV2_IDX_SVC]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ESP_GATTS_STOP_EVT:</span><br><span class="line">        <span class="keyword">case</span> ESP_GATTS_OPEN_EVT:</span><br><span class="line">        <span class="keyword">case</span> ESP_GATTS_CANCEL_OPEN_EVT:</span><br><span class="line">        <span class="keyword">case</span> ESP_GATTS_CLOSE_EVT:</span><br><span class="line">        <span class="keyword">case</span> ESP_GATTS_LISTEN_EVT:</span><br><span class="line">        <span class="keyword">case</span> ESP_GATTS_CONGEST_EVT:</span><br><span class="line">        <span class="keyword">case</span> ESP_GATTS_UNREG_EVT:</span><br><span class="line">        <span class="keyword">case</span> ESP_GATTS_DELETE_EVT:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * GAP事件回调函数</span></span><br><span class="line"><span class="comment"> * GAP是蓝牙协议栈中定义设备如何发现、连接和与其他设备交互的部分。</span></span><br><span class="line"><span class="comment"> * @param event BLE GAP 事件类型，枚举类型</span></span><br><span class="line"><span class="comment"> * @param param 一个指向 esp_ble_gap_cb_param_t 的指针，包含与当前事件相关的参数。</span></span><br><span class="line"><span class="comment"> * @return 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">gap_event_handler</span><span class="params">(<span class="type">esp_gap_ble_cb_event_t</span> event, <span class="type">esp_ble_gap_cb_param_t</span> *param)</span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (event) &#123;</span><br><span class="line">        <span class="comment">// 该事件触发时，表示广播数据已经成功设置    </span></span><br><span class="line">        <span class="keyword">case</span> ESP_GAP_BLE_ADV_DATA_SET_COMPLETE_EVT:</span><br><span class="line">            <span class="comment">// 将标志位置为0</span></span><br><span class="line">            adv_config_done &amp;= (~ADV_CONFIG_FLAG);</span><br><span class="line">            <span class="keyword">if</span> (adv_config_done == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="comment">// 开始广播，adv_params中是配置的广播参数</span></span><br><span class="line">                esp_ble_gap_start_advertising(&amp;adv_params);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 该事件触发时，表示扫描响应数据已经成功设置    </span></span><br><span class="line">        <span class="keyword">case</span> ESP_GAP_BLE_SCAN_RSP_DATA_SET_COMPLETE_EVT:</span><br><span class="line">            <span class="comment">// 将标志位置为0</span></span><br><span class="line">            adv_config_done &amp;= (~SCAN_RSP_CONFIG_FLAG);</span><br><span class="line">            <span class="keyword">if</span> (adv_config_done == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="comment">// 开始广播</span></span><br><span class="line">                esp_ble_gap_start_advertising(&amp;adv_params);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 此事件表示广播成功启动    </span></span><br><span class="line">        <span class="keyword">case</span> ESP_GAP_BLE_ADV_START_COMPLETE_EVT:</span><br><span class="line">            <span class="comment">/* advertising start complete event to indicate advertising start successfully or failed */</span></span><br><span class="line">            <span class="keyword">if</span> (param-&gt;adv_start_cmpl.status != ESP_BT_STATUS_SUCCESS) &#123;</span><br><span class="line">                ESP_LOGE(TAG, <span class="string">&quot;advertising start failed&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                ESP_LOGI(TAG, <span class="string">&quot;advertising start successfully&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ESP_GAP_BLE_ADV_STOP_COMPLETE_EVT:             <span class="comment">//停止广播成功事件</span></span><br><span class="line">            <span class="keyword">if</span> (param-&gt;adv_stop_cmpl.status != ESP_BT_STATUS_SUCCESS) &#123;</span><br><span class="line">                ESP_LOGE(TAG, <span class="string">&quot;Advertising stop failed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                ESP_LOGI(TAG, <span class="string">&quot;Stop adv successfully\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ESP_GAP_BLE_UPDATE_CONN_PARAMS_EVT:        <span class="comment">//更新连接参数成功事件</span></span><br><span class="line">            ESP_LOGI(TAG, <span class="string">&quot;update connection params status = %d, min_int = %d, max_int = %d,conn_int = %d,latency = %d, timeout = %d&quot;</span>,</span><br><span class="line">                  param-&gt;update_conn_params.status,</span><br><span class="line">                  param-&gt;update_conn_params.min_int,</span><br><span class="line">                  param-&gt;update_conn_params.max_int,</span><br><span class="line">                  param-&gt;update_conn_params.conn_int,</span><br><span class="line">                  param-&gt;update_conn_params.latency,</span><br><span class="line">                  param-&gt;update_conn_params.timeout);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化并启动蓝牙BLE</span></span><br><span class="line"><span class="comment"> * @param 无</span></span><br><span class="line"><span class="comment"> * @return 是否成功</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">esp_err_t</span> <span class="title function_">ble_cfg_net_init</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// esp_err_t ret;</span></span><br><span class="line">    <span class="comment">// 释放 Classic Bluetooth（经典蓝牙）模式的内存。</span></span><br><span class="line">    <span class="comment">// ESP32 支持多种蓝牙模式，ESP_BT_MODE_CLASSIC_BT 是经典蓝牙模式，</span></span><br><span class="line">    <span class="comment">// 调用该函数会释放其相关的内存资源，因为这里我们要使用的是 BLE 模式，经典蓝牙模式不再需要。</span></span><br><span class="line">    ESP_ERROR_CHECK(esp_bt_controller_mem_release(ESP_BT_MODE_CLASSIC_BT));</span><br><span class="line">	<span class="comment">// 引用提供的蓝牙默认配置</span></span><br><span class="line">    <span class="type">esp_bt_controller_config_t</span> bt_cfg = BT_CONTROLLER_INIT_CONFIG_DEFAULT();</span><br><span class="line">    <span class="comment">// 使用默认配置初始化蓝牙控制器</span></span><br><span class="line">    ESP_ERROR_CHECK(esp_bt_controller_init(&amp;bt_cfg));</span><br><span class="line">    <span class="comment">// 启用蓝牙控制器并指定使用蓝牙低能耗 (BLE) 模式</span></span><br><span class="line">    ESP_ERROR_CHECK(esp_bt_controller_enable(ESP_BT_MODE_BLE));</span><br><span class="line">    <span class="comment">// 定义并初始化蓝牙堆栈（Bluedroid）的配置结构体</span></span><br><span class="line">    <span class="comment">// Bluedroid 是 ESP32 官方封装好的蓝牙协议栈支持经典蓝牙和低功耗蓝牙。</span></span><br><span class="line">    <span class="type">esp_bluedroid_config_t</span> bluedroid_cfg = BT_BLUEDROID_INIT_CONFIG_DEFAULT();</span><br><span class="line">    <span class="comment">// 使用指定的配置初始化蓝牙堆栈</span></span><br><span class="line">    ESP_ERROR_CHECK(esp_bluedroid_init_with_cfg(&amp;bluedroid_cfg));</span><br><span class="line">    <span class="comment">// 启用蓝牙堆栈</span></span><br><span class="line">    ESP_ERROR_CHECK(esp_bluedroid_enable());</span><br><span class="line">    <span class="comment">// 注册 GATT 事件用于注册处理 GATT 服务器事件的回调函数</span></span><br><span class="line">    ESP_ERROR_CHECK(esp_ble_gatts_register_callback(gatts_profile_event_handler));</span><br><span class="line">    <span class="comment">// 注册 GAP（通用访问配置文件）事件回调函数处理与 BLE 连接相关的事件，例如设备扫描、连接、断开连接等。</span></span><br><span class="line">    ESP_ERROR_CHECK(esp_ble_gap_register_callback(gap_event_handler));</span><br><span class="line">    <span class="comment">// 注册一个 GATT 应用,通常来说一个应用注册一个 ID 即可。</span></span><br><span class="line">    <span class="comment">// 例如你的设备需要同时支持心率服务和温度服务，那么你需要为这两个服务分别定义不同的应用 ID。</span></span><br><span class="line">    ESP_ERROR_CHECK(esp_ble_gatts_app_register(ESP_APP_ID));</span><br><span class="line">    <span class="comment">// 设置本地的 GATT MTU（最大传输单元）。指在网络协议中一次传输的数据包的最大字节数。</span></span><br><span class="line">    ESP_ERROR_CHECK(esp_ble_gatt_set_local_mtu(<span class="number">500</span>));</span><br><span class="line">    <span class="keyword">return</span> ESP_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这两个函数是暴露给外部去使用的</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置特征1的值</span></span><br><span class="line"><span class="comment"> * @param value 值</span></span><br><span class="line"><span class="comment"> * @return 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ble_set_ch1_value</span><span class="params">(<span class="type">uint16_t</span> value)</span>&#123;</span><br><span class="line">    sv1_char2_value[<span class="number">0</span>] = value&amp;<span class="number">0xff</span>;</span><br><span class="line">    sv1_char2_value[<span class="number">1</span>] = value&gt;&gt;<span class="number">8</span>;</span><br><span class="line">    <span class="comment">//判断连接是否有效，以及客户端特征配置是否不为0</span></span><br><span class="line">    <span class="comment">// 因为 0 表示不能上报</span></span><br><span class="line">    <span class="keyword">if</span>(gl_conn_id != <span class="number">0xFFFF</span> &amp;&amp; (sv1_ch1_client_cfg[<span class="number">0</span>] | sv1_ch1_client_cfg[<span class="number">1</span>]))&#123;</span><br><span class="line">        <span class="comment">// 更新 GATT 服务器中特征的值。</span></span><br><span class="line">        <span class="comment">// v1_handle_table[SV1_CH1_IDX_CHAR_VAL]：特征的句柄（Handle）</span></span><br><span class="line">        <span class="comment">// 2：特征值的长度（2 字节）。</span></span><br><span class="line">        <span class="comment">// (const uint8_t*)&amp;sv1_char2_value：特征值的数据。</span></span><br><span class="line">        esp_ble_gatts_set_attr_value(sv1_handle_table[SV1_CH1_IDX_CHAR_VAL], <span class="number">2</span>, (<span class="type">const</span> <span class="type">uint8_t</span>*)&amp;sv1_char2_value);</span><br><span class="line">        <span class="comment">// 向客户端发送通知（Indication）。</span></span><br><span class="line">        <span class="comment">// gl_gatts_if：GATT 服务器的接口 ID。</span></span><br><span class="line">        <span class="comment">// gl_conn_id：连接句柄，表示当前连接。</span></span><br><span class="line">        <span class="comment">// sv1_handle_table[SV1_CH1_IDX_CHAR_VAL]：特征的句柄。</span></span><br><span class="line">        <span class="comment">// 2：特征值的长度。m</span></span><br><span class="line">        <span class="comment">// (uint8_t*)&amp;sv1_char2_value：特征值的数据。</span></span><br><span class="line">        <span class="comment">// false：表示发送的是通知（Notification），而不是指示（Indication）。</span></span><br><span class="line">        <span class="comment">// 如果是 true，则表示发送的是指示（Indication），客户端需要回复确认。</span></span><br><span class="line">        <span class="comment">// 注意这里发送的通知或指示，要看特征中配置的是通知还是指示</span></span><br><span class="line">        esp_ble_gatts_send_indicate(gl_gatts_if, gl_conn_id,sv1_handle_table[SV1_CH1_IDX_CHAR_VAL], <span class="number">2</span>, (<span class="type">uint8_t</span>*)&amp;sv1_char2_value, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置特征2的值</span></span><br><span class="line"><span class="comment"> * @param value 值</span></span><br><span class="line"><span class="comment"> * @return 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ble_set_ch2_value</span><span class="params">(<span class="type">uint16_t</span> value)</span>&#123;</span><br><span class="line">    sv2_char2_value[<span class="number">0</span>] = value&amp;<span class="number">0xff</span>;</span><br><span class="line">    sv2_char2_value[<span class="number">1</span>] = value&gt;&gt;<span class="number">8</span>;</span><br><span class="line">    <span class="comment">//判断连接是否有效，以及客户端特征配置是否不为0</span></span><br><span class="line">    <span class="keyword">if</span>(gl_conn_id != <span class="number">0xFFFF</span> &amp;&amp; (sv1_ch2_client_cfg[<span class="number">0</span>] | sv1_ch2_client_cfg[<span class="number">1</span>]))&#123;</span><br><span class="line">        esp_ble_gatts_set_attr_value(sv1_handle_table[SV1_CH2_IDX_CHAR_VAL], <span class="number">2</span>, (<span class="type">const</span> <span class="type">uint8_t</span>*)&amp;sv2_char2_value);</span><br><span class="line">        esp_ble_gatts_send_indicate(gl_gatts_if, gl_conn_id,sv1_handle_table[SV1_CH2_IDX_CHAR_VAL], <span class="number">2</span>, (<span class="type">uint8_t</span>*)&amp;sv2_char2_value, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br><span class="line">=============================================================</span><br><span class="line"><span class="comment">// main.c    </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;esp_err.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ble.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;freertos/FreeRTOS.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;freertos/task.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;nvs_flash.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> mytask1(<span class="type">void</span>* param)&#123;</span><br><span class="line">    <span class="type">uint16_t</span> count1 = <span class="number">1</span>;</span><br><span class="line">    <span class="type">uint16_t</span> count2 = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        vTaskDelay(pdMS_TO_TICKS(<span class="number">3000</span>));</span><br><span class="line">        ble_set_ch1_value(count1++);</span><br><span class="line">        vTaskDelay(pdMS_TO_TICKS(<span class="number">700</span>));</span><br><span class="line">        ble_set_ch2_value(count2++);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">app_main</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 初始化 NVS (Non-Volatile Storage)，它是一个用于存储配置、状态信息等的非易失性存储</span></span><br><span class="line">    ESP_ERROR_CHECK(nvs_flash_init());</span><br><span class="line">    <span class="comment">// 初始化蓝牙配置</span></span><br><span class="line">    ble_cfg_net_init();</span><br><span class="line">    <span class="comment">// 创建一个名为 mytask1 的 FreeRTOS 任务并将其固定到指定的 CPU 核心。</span></span><br><span class="line">    <span class="comment">// 这个任务我们拿来做自己的事情</span></span><br><span class="line">    xTaskCreatePinnedToCore(mytask1,<span class="string">&quot;mytask&quot;</span>,<span class="number">4096</span>,<span class="literal">NULL</span>,<span class="number">3</span>,<span class="literal">NULL</span>,<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码运行后可以通过蓝牙检索到名为”ESP32-HOME”的设备，通过上述的微信小程序可成功连接到蓝牙；</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>一、<strong>头文件报错</strong></p>
<p>例如：fatal error: esp_bt.h: No such file or directory</p>
<p><img src="C:\Users\kay\AppData\Roaming\Typora\typora-user-images\image-20250120211959363.png" alt="image-20250120211959363"></p>
<p><img src="C:\Users\kay\AppData\Roaming\Typora\typora-user-images\image-20250120213226853.png" alt="image-20250120213226853"></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/about/">博主</a></li>
        
          <li><a href="/tags/">标签</a></li>
        
          <li><a href="/categories/">分类</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%8F%E8%AE%AE%E6%A0%88"><span class="toc-number">1.</span> <span class="toc-text">协议栈</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GAP-%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.1.</span> <span class="toc-text">GAP 协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GATT%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.2.</span> <span class="toc-text">GATT协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ATT%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.3.</span> <span class="toc-text">ATT协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%F0%9F%99%83%F0%9F%99%83%F0%9F%99%83"><span class="toc-number">1.4.</span> <span class="toc-text">总结🙃🙃🙃</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%BF%E6%92%AD%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F"><span class="toc-number">2.</span> <span class="toc-text">广播数据包格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%93%9D%E7%89%99%E9%80%9A%E4%BF%A1%E4%B8%AD%E7%9A%84%E8%A7%92%E8%89%B2"><span class="toc-number">3.1.</span> <span class="toc-text">蓝牙通信中的角色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BLE%E9%80%9A%E4%BF%A1%E4%BF%A1%E9%81%93"><span class="toc-number">3.2.</span> <span class="toc-text">BLE通信信道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%BF%E6%92%AD%E9%97%B4%E9%9A%94%E5%92%8C%E5%B9%BF%E6%92%AD%E4%BA%8B%E4%BB%B6"><span class="toc-number">3.3.</span> <span class="toc-text">广播间隔和广播事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BLE%E8%BF%9E%E6%8E%A5%E5%90%8E"><span class="toc-number">3.4.</span> <span class="toc-text">BLE连接后</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">3.5.</span> <span class="toc-text">代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">4.</span> <span class="toc-text">问题</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/&text=BLE蓝牙"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/&title=BLE蓝牙"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/&is_video=false&description=BLE蓝牙"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=BLE蓝牙&body=Check out this article: https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/&title=BLE蓝牙"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/&title=BLE蓝牙"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/&title=BLE蓝牙"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/&title=BLE蓝牙"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/&name=BLE蓝牙&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://www.tooupper.org/%E5%B5%8C%E5%85%A5%E5%BC%8F/%E5%8D%95%E7%89%87%E6%9C%BA/ESP32/ESP32_S3/BLE%E8%93%9D%E7%89%99/&t=BLE蓝牙"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024-2025
    kay
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">博主</a></li><!--
     --><!--
       --><li><a href="/tags/">标签</a></li><!--
     --><!--
       --><li><a href="/categories/">分类</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
